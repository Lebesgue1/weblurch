<html>
    <head>
        <link rel="stylesheet"
              href="../bootstrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="./main.css"/>
        <link rel="stylesheet" href="./obsidian.css"/>
        <link rel="shortcut icon" href="favicon.png"/>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config( {
              tex2jax: { inlineMath: [ [ '$', '$' ], [ '\\(', '\\)' ] ] }
            } );
        </script>
        <script type="text/javascript"
                src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <title>webLurch docs: utils</title>
    </head>
    <body>
        <div id="left">
            <p align=center>Page contents</p>
<p><a href='#test-app-utilities'>Test app utilities</a></p><ul>
<li><a href='#setup-routine'>Setup routine</a></li><li><a href='#event-handlers'>Event handlers</a></li><ul>
<li><a href='#dispatcher'>Dispatcher</a></li><li><a href='#source-synchronizer'>Source synchronizer</a></li><li><a href='#main-code-runner'>Main code runner</a></li><li><a href='#code-runner-for-test-history'>Code runner for test history</a></li><li><a href='#code-runner-for-full-test-history'>Code runner for full test history</a></li><li><a href='#yes-and-no-buttons'>Yes and no buttons</a></li><li><a href='#edit-comments-buttons'>Edit comments buttons</a></li><li><a href='#download-button'>Download button</a></li><li><a href='#reset-button'>Reset button</a></li><li><a href='#undo-button'>Undo button</a></li><li><a href='#handling-a-choice-of-a-saved-history'>Handling a choice of a saved history</a></li><li><a href='#representation-of-the-test-history'>Representation of the test history</a></li><li><a href='#resizing-the-test-history-div'>Resizing the test history div</a></li></ul>
<li><a href='#utility-functions'>Utility functions</a></li>
        </div>
        <div id="middle">
            <h1><a name='test-app-utilities'></a>Test app utilities &nbsp;  <font size=-1><a href='#test-app-utilities'><span class="glyphicon glyphicon-link"></span></a></font></h1><h2><a name='setup-routine'></a>Setup routine &nbsp;  <font size=-1><a href='#setup-routine'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>The following routine is run after
<a href="../testapp/index.html">the test app page</a> has finished loading.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">testAppSetup</span> = -&gt;</span>
</code></pre><p>Create a <code>LurchEditor</code> instance in the page itself.</p>
<pre class="hljs"><code>    <span class="hljs-built_in">window</span>.LE = <span class="hljs-keyword">new</span> LurchEditor editor
</code></pre><p>Create global datum in which we will store the history of all the
states of the model (i.e., <code>LE</code>&#39;s element), as well as all lines of
code executed to cause changes of state.</p>
<pre class="hljs"><code>    initializeHistory()
</code></pre><p>Store in global variables the important UI elements on the page.</p>
<pre class="hljs"><code>    <span class="hljs-built_in">window</span>.maindiv = LE.getElement()
</code></pre><p>Install event handlers for the buttons.</p>
<pre class="hljs"><code>    ( $ runButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, runButtonClicked
    ( $ resetButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, resetButtonClicked
    ( $ downloadButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, downloadButtonClicked
    ( $ undoButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, undoButtonClicked
    ( $ runFullHistoryButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>,
        runFullHistoryButtonClicked
    ( $ saveStateCommentsButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>,
        saveStateCommentsButtonClicked
</code></pre><p>Make the code input respond to the Enter key by auto-clicking the
run button, and the comments input respond to Shift+Enter by
auto-clicking the Save button.</p>
<pre class="hljs"><code>    <span class="hljs-function"><span class="hljs-params">( $ codeInput )</span>.<span class="hljs-title">on</span> '<span class="hljs-title">keydown</span>', <span class="hljs-params">( event )</span> -&gt;</span>
        <span class="hljs-keyword">if</span> event.keyCode <span class="hljs-keyword">is</span> <span class="hljs-number">13</span> <span class="hljs-keyword">then</span> runButtonClicked()
    <span class="hljs-function"><span class="hljs-params">( $ commentEditInput )</span>.<span class="hljs-title">on</span> '<span class="hljs-title">keydown</span>', <span class="hljs-params">( event )</span> -&gt;</span>
        <span class="hljs-keyword">if</span> event.keyCode <span class="hljs-keyword">is</span> <span class="hljs-number">13</span> <span class="hljs-keyword">and</span> event.shiftKey
            saveStateCommentsButtonClicked()
            <span class="hljs-literal">no</span> <span class="hljs-comment"># prevent event propagation</span>
</code></pre><p>Fill the source and/or history tabs only when they become visible,
so we&#39;re not always recomputing their contents.</p>
<pre class="hljs"><code>    ( $ sourceTab ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, updateSourceTab
    ( $ historyTab ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, updateHistoryTab
</code></pre><p>Fill the saved histories drop-down with items from the global
variable <code>allTestHistories</code>.  Then install the event handler for
that drop-down list.</p>
<pre class="hljs"><code>    filenames = Object.keys allTestHistories
    filenames.sort()
    filenames.unshift <span class="hljs-string">'Compare to a saved history...'</span>
    <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> filenames
        item = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'option'</span>
        item.textContent = filename
        savedHistoriesList.appendChild item
    ( $ savedHistoriesList ).change chosenHistoryChanged
</code></pre><p>Make the history body the right size for scrolling independently,
and have this update every time the page is resized.</p>
<pre class="hljs"><code>    resizeHistoryHeight()
    ( $ <span class="hljs-built_in">window</span> ).resize resizeHistoryHeight
</code></pre><p>Run <a href="#source-synchronizer">the routine</a> that updates the currently
active view.</p>
<pre class="hljs"><code>    updateView()
</code></pre><p>Place the user&#39;s keyboard focus into the code input box.</p>
<pre class="hljs"><code>    codeInput.focus()
</code></pre><h2><a name='event-handlers'></a>Event handlers &nbsp;  <font size=-1><a href='#event-handlers'><span class="glyphicon glyphicon-link"></span></a></font></h2><h3><a name='dispatcher'></a>Dispatcher &nbsp;  <font size=-1><a href='#dispatcher'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>This function dispatches to either the source tab updater or the
history tab updater, depending on which one is visible, if either.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">updateView</span> = -&gt;</span>
    updateSourceTab() <span class="hljs-keyword">if</span> ( $ sourceView ).hasClass <span class="hljs-string">'active'</span>
    updateHistoryTab() <span class="hljs-keyword">if</span> ( $ historyView ).hasClass <span class="hljs-string">'active'</span>
</code></pre><h3><a name='source-synchronizer'></a>Source synchronizer &nbsp;  <font size=-1><a href='#source-synchronizer'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>The following routine fills the source div with the HTML source of
the <code>LurchEditor</code>&#39;s element.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">updateSourceTab</span> = -&gt;</span>
    code = LE.getElement().outerHTML.replace( <span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">'&amp;amp;'</span> )
                                    .replace( <span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">'&amp;gt;'</span> )
                                    .replace( <span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">'&amp;lt;'</span> )
                                    .replace( <span class="hljs-regexp">/'/g</span>, <span class="hljs-string">'&amp;apos;'</span> )
                                    .replace( <span class="hljs-regexp">/"/g</span>, <span class="hljs-string">'&amp;quot;'</span> )
    sourceView.innerHTML = <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">#{code}</span>&lt;/pre&gt;"</span>
</code></pre><h3><a name='main-code-runner'></a>Main code runner &nbsp;  <font size=-1><a href='#main-code-runner'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>The event handler on the &quot;Run&quot; button that evaluates the code the
user enters in the code input box.  The following function is the
auxiliary function it uses to do so.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">runCodeInModel</span> = <span class="hljs-params">( code )</span> -&gt;</span>
</code></pre><p>First, just evaluate the code.</p>
<pre class="hljs"><code>    eval code
</code></pre><p>This auxiliary function also appends that action and its result to
the test history array.</p>
<pre class="hljs"><code>    testHistory.push {
        code : code
        state : LE.getElement().toJSON()
    }
</code></pre><p>The event handler just calls the auxiliary function, then updates
any visible views, clears the code input, and gives it focus.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">runButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
    runCodeInModel codeInput.value
    updateView()
    codeInput.value = <span class="hljs-string">''</span>
    codeInput.focus()
</code></pre><h3><a name='code-runner-for-test-history'></a>Code runner for test history &nbsp;  <font size=-1><a href='#code-runner-for-test-history'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>Similar to the previous method, but this event handler is for the
individual run buttons that appear in code steps in a saved test
history, if one is displayed.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">runSavedStep</span> = <span class="hljs-params">( index )</span> -&gt;</span>
</code></pre><p>Guard against having this run at an incorrect time, or with an
incorrect parameter.</p>
<pre class="hljs"><code>    savedHistory = <span class="hljs-built_in">window</span>.comparisonHistory?.data
    <span class="hljs-keyword">if</span> savedHistory <span class="hljs-keyword">and</span> index &lt; savedHistory.length
</code></pre><p>Use the same auxiliary function as
<a href="#main-code-runner">the main code runner</a> uses, then update the
view.</p>
<pre class="hljs"><code>        runCodeInModel savedHistory[index].code
        updateView()
</code></pre><h3><a name='code-runner-for-full-test-history'></a>Code runner for full test history &nbsp;  <font size=-1><a href='#code-runner-for-full-test-history'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>It can be convenient to run the full test history all at once, all
commands in sequence.  There is a button for doing so, and this is
its event handler.</p>
<p>It is very similar to
<a href="#code-runner-for-test-history">the previous handler</a>, except in
a loop, so I don&#39;t feel the need to describe it in detail.  The
one interesting note is that we don&#39;t replay the initial command,
because it is blank (corresponding to the initial state).</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">runFullHistoryButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
    savedHistory = <span class="hljs-built_in">window</span>.comparisonHistory?.data
    <span class="hljs-keyword">if</span> savedHistory
        testHistory[testHistory.length-<span class="hljs-number">1</span>].comments =
            savedHistory[<span class="hljs-number">0</span>].comments
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> savedHistory[<span class="hljs-number">1.</span>.]
            runCodeInModel step.code
            testHistory[testHistory.length-<span class="hljs-number">1</span>].comments =
                step.comments
        updateView()
</code></pre><h3><a name='yes-and-no-buttons'></a>Yes and no buttons &nbsp;  <font size=-1><a href='#yes-and-no-buttons'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>The event handlers for the &quot;Mark right&quot; and &quot;Mark wrong&quot; buttons
edit the last item pushed onto the <code>testHistory</code> stack.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">yesButtonClicked</span> = <span class="hljs-params">( index )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> testHistory[index].correct <span class="hljs-keyword">is</span> <span class="hljs-literal">yes</span>
        <span class="hljs-keyword">delete</span> testHistory[index].correct
    <span class="hljs-keyword">else</span>
        testHistory[index].correct = <span class="hljs-literal">yes</span>
    updateView()

<span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">noButtonClicked</span> = <span class="hljs-params">( index )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> testHistory[index].correct <span class="hljs-keyword">is</span> <span class="hljs-literal">no</span>
        <span class="hljs-keyword">delete</span> testHistory[index].correct
    <span class="hljs-keyword">else</span>
        testHistory[index].correct = <span class="hljs-literal">no</span>
    updateView()
</code></pre><h3><a name='edit-comments-buttons'></a>Edit comments buttons &nbsp;  <font size=-1><a href='#edit-comments-buttons'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>The following event handler responds to the user&#39;s clicking the
edit button in a state in the current history.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">editStateComments</span> = <span class="hljs-params">( index )</span> -&gt;</span>
</code></pre><p>Fill the hidden modal dialog with the comments to be edited.</p>
<pre class="hljs"><code>    ( $ commentEditInput ).val testHistory[index].comments
</code></pre><p>Store the index of the state we&#39;re editing, so we know later where
to save any edits.</p>
<pre class="hljs"><code>    commentEditInput.comesFromIndex = index
</code></pre><p>Show the modal dialog and ensure that focus goes to the right
control after it appears.</p>
<pre class="hljs"><code>    ( $ commentEditDialog ).modal {
        show : <span class="hljs-literal">true</span>
        backdrop : <span class="hljs-literal">true</span>
        keyboard : <span class="hljs-literal">true</span>
    }
    <span class="hljs-function"><span class="hljs-params">( $ commentEditDialog )</span>.<span class="hljs-title">on</span> '<span class="hljs-title">shown</span>.<span class="hljs-title">bs</span>.<span class="hljs-title">modal</span>', <span class="hljs-params">( event )</span> -&gt;</span>
        ( $ commentEditInput ).focus()
</code></pre><p>The following event handler responds to the user&#39;s clicking Save in
the modal dialog for editing state comments.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">saveStateCommentsButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
</code></pre><p>Fetch the stored index of which state it is whose comments we&#39;re
editing.</p>
<pre class="hljs"><code>    index = commentEditInput.comesFromIndex
</code></pre><p>Save the comments, having trimmed whitespace from start and end.</p>
<pre class="hljs"><code>    testHistory[index].comments =
        ( $ commentEditInput ).val().trim()
</code></pre><p>Hide the modal dialog and update any necessary views.</p>
<pre class="hljs"><code>    ( $ commentEditDialog ).modal <span class="hljs-string">'hide'</span>
    updateView()
</code></pre><h3><a name='download-button'></a>Download button &nbsp;  <font size=-1><a href='#download-button'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">downloadButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
</code></pre><p>I use pretty printing in the following JSON, because these files
will be checked into our repository, and developers may end up
browsing them at some point on disk.  The preferred way to browse
them is to load them into
<a href="../testapp/index.html">this very test app</a>, but it doesn&#39;t hurt to
make reading the source files easier.</p>
<pre class="hljs"><code>    data = JSON.stringify testHistory, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>
</code></pre><p>The following uses the HTML <code>createObjectURL</code> method to store blob
data in the browser, which provides us a unique URL containing a
hash that references that blob, for the user to download.</p>
<pre class="hljs"><code>    blob = <span class="hljs-keyword">new</span> Blob [ data ], type : <span class="hljs-string">'application/json'</span>
    link = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'a'</span>
    link.setAttribute <span class="hljs-string">'href'</span>, URL.createObjectURL blob
    link.setAttribute <span class="hljs-string">'download'</span>,
        <span class="hljs-string">"<span class="hljs-subst">#{testNameInput.value <span class="hljs-keyword">or</span> <span class="hljs-string">'test-history'</span>}</span>.json"</span>
    link.click()
</code></pre><p>Technically, once the blob has been used (i.e., the file
downloaded), we should then delete the URL, to save resources.
However, the amount of data being stored here is very small, and
the test app will be used infrequently enough that I&#39;m not
concerned about that leak right now.  But it could be fixed in the
future.</p>
<h3><a name='reset-button'></a>Reset button &nbsp;  <font size=-1><a href='#reset-button'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>This method resets the document (and the editor over it) to their
initial states, by replacing them with fresh ones.  The process is
described in the comments interleaved in the code below.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">resetButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
</code></pre><p>Then recreate a new div that&#39;s exactly like the document was when
it was initialized.</p>
<pre class="hljs"><code>    freshDocument = Node.fromJSON testHistory[<span class="hljs-number">0</span>].state
</code></pre><p>Replace the existing document in the DOM hierarchy with this new
one.</p>
<pre class="hljs"><code>    current = <span class="hljs-built_in">window</span>.LE.getElement()
    current.parentNode.replaceChild freshDocument, current
</code></pre><p>Throw away the old <code>LurchEditor</code> and replace it with a new one,
whose element is this newly created document.</p>
<pre class="hljs"><code>    <span class="hljs-built_in">window</span>.LE = <span class="hljs-keyword">new</span> LurchEditor freshDocument
    <span class="hljs-built_in">window</span>.maindiv = freshDocument
</code></pre><p>Clear out the test history, reload any saved history, and refresh
all views.</p>
<pre class="hljs"><code>    initializeHistory()
    chosenHistoryChanged()
    updateView()
</code></pre><h3><a name='undo-button'></a>Undo button &nbsp;  <font size=-1><a href='#undo-button'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>This method performs an undo <em>not</em> by calling the <code>undo</code> method of
the editor, for two reasons.</p>
<ul>
<li>The test history may be testing (and thus using) that very undo
method, and thus it should not be relied upon in the test app.</li>
<li>Calling that method changes the state of the editor, by
manipulating its undo/redo stack.  But the state of that stack
must be reverted by this very undo/redo operation.</li>
</ul>
<p>Thus this method proceeds as follows.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">undoButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
</code></pre><p>First, retain the current test history in a temporary variable for
use below.</p>
<pre class="hljs"><code>    oldHistory = testHistory
</code></pre><p>Now reset the entire page to its initial state (which clears out
the test history, and that&#39;s why we saved it, above.)</p>
<pre class="hljs"><code>    resetButtonClicked()
</code></pre><p>Now replay all the commands in the test history, in order, <em>except
for</em> the final one.  This will put the document <em>and</em> the editor in
the state they were in before that last command took place.  Note
that the first entry in the test history is not a command, so we
must skip it.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> oldHistory[<span class="hljs-number">1.</span>..-<span class="hljs-number">1</span>]
        runCodeInModel step.code
</code></pre><p>Last, update any views to show that the undo took place.</p>
<pre class="hljs"><code>    updateView()
</code></pre><h3><a name='handling-a-choice-of-a-saved-history'></a>Handling a choice of a saved history &nbsp;  <font size=-1><a href='#handling-a-choice-of-a-saved-history'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">chosenHistoryChanged</span> = <span class="hljs-params">( event )</span> -&gt;</span>
</code></pre><p>Look up the data for the chosen history in the global variable in
which it&#39;s stored.</p>
<pre class="hljs"><code>    filename = ( $ savedHistoriesList ).val()
</code></pre><p>Update the global variable used for history comparison to contain
that data, or to be null if there was no such data (e.g., the user
chose the drop-down&#39;s title, rather than an item on it).</p>
<pre class="hljs"><code>    <span class="hljs-keyword">if</span> filename <span class="hljs-keyword">of</span> allTestHistories
        <span class="hljs-built_in">window</span>.comparisonHistory = {
            filename : filename
            data : allTestHistories[filename]
        }
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">window</span>.comparisonHistory = <span class="hljs-literal">null</span>
</code></pre><p>Update the view, in case they&#39;re viewing the history.</p>
<pre class="hljs"><code>    updateView()
</code></pre><h3><a name='representation-of-the-test-history'></a>Representation of the test history &nbsp;  <font size=-1><a href='#representation-of-the-test-history'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>This routine is the event handler for the display of the History
tab; it populates that tab with an HTML representation of the
current test history.</p>
<p>First, we need some auxiliary functions.  The first computes the
representation of a command in the history.  The parameters are
as follows.</p>
<ul>
<li><code>step</code> is an entry in the test history</li>
<li><code>index</code> is an integer, that step&#39;s index in the history</li>
<li><code>details</code> is any HTML that should be inserted in the panel
header, before the title (such as floating buttons/indicators)</li>
</ul>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.historyCommandRepresentation = ( step, index,
    details = <span class="hljs-string">''</span> )<span class="hljs-function"> -&gt;</span>
</code></pre><p>Escape the code for insertion into an HTML document.</p>
<pre class="hljs"><code>    code = step.code.replace( <span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">'&amp;amp;'</span> )
                    .replace( <span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">'&amp;gt;'</span> )
                    .replace( <span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">'&amp;lt;'</span> )
                    .replace( <span class="hljs-regexp">/'/g</span>, <span class="hljs-string">'&amp;apos;'</span> )
                    .replace( <span class="hljs-regexp">/"/g</span>, <span class="hljs-string">'&amp;quot;'</span> )
</code></pre><p>Wrap it in some titles and boxes to make it pretty.</p>
<pre class="hljs"><code>    <span class="hljs-string">"""
    &lt;div class='panel panel-info'&gt;
      &lt;div class='panel-heading'&gt;
        <span class="hljs-subst">#{details}</span>
        &lt;h3 class='panel-title'&gt;Command <span class="hljs-subst">#{index}</span>:&lt;/h3&gt;
      &lt;/div&gt;
      &lt;div class='panel-body'&gt;
        &lt;pre&gt;<span class="hljs-subst">#{code}</span>&lt;/pre&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    """</span>
</code></pre><p>The second auxiliary function computes the representation of a
state in the command history.  The parameters are the same as in
the previous auxiliary function, plus this one:</p>
<ul>
<li><code>type</code> is the panel type, either &#39;default&#39;, &#39;success&#39;, or
&#39;danger&#39;</li>
</ul>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.historyStateRepresentation = ( step, index,
    details = <span class="hljs-string">''</span>, type = <span class="hljs-string">'default'</span> )<span class="hljs-function"> -&gt;</span>
</code></pre><p>De-serialize the model state, do not put it into the page&#39;s DOM,
but convert it to a string of HTML code.  Remove all ids from this
code so that we can use it to represent the document state without
conflicting with the document that&#39;s already in the page.</p>
<pre class="hljs"><code>    code = Node.fromJSON( step.state ).outerHTML
    escaped = code.replace( <span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">'&amp;amp;'</span> )
                  .replace( <span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">'&amp;gt;'</span> )
                  .replace( <span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">'&amp;lt;'</span> )
                  .replace( <span class="hljs-regexp">/'/g</span>, <span class="hljs-string">'&amp;apos;'</span> )
                  .replace( <span class="hljs-regexp">/"/g</span>, <span class="hljs-string">'&amp;quot;'</span> )
    code = code.replace <span class="hljs-regexp">/\s+id=['"][^'"]+['"]/g</span>, <span class="hljs-string">''</span>
    state = <span class="hljs-string">"""&lt;pre class='gap-below-2'&gt;<span class="hljs-subst">#{escaped}</span>&lt;/pre&gt;
               <span class="hljs-subst">#{code}</span>"""</span>
</code></pre><p>Label the state as either as the initial state or the result of
executing some JavaScript code.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">if</span> index <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
        title = <span class="hljs-string">"Initial state:"</span>
        type += <span class="hljs-string">' gap-before-2'</span>
    <span class="hljs-keyword">else</span>
        title = <span class="hljs-string">"State after command <span class="hljs-subst">#{index}</span>:"</span>
</code></pre><p>Wrap the comments in a well if they actually exist, or keep them
blank if this step does not have any comments.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">if</span> step.comments
        comments = <span class="hljs-string">"""
            &lt;div class='well well-sm'&gt;
                &lt;span class='glyphicon glyphicon-info-sign'&gt;
                &lt;/span&gt;
                <span class="hljs-subst">#{step.comments}</span>
            &lt;/div&gt;
            """</span>
    <span class="hljs-keyword">else</span>
        comments = <span class="hljs-string">''</span>
</code></pre><p>Wrap it in titles and boxes to make it pretty, and insert any
details the caller provided, such as buttons or markers, in the
panel title.</p>
<pre class="hljs"><code>    <span class="hljs-string">"""
    &lt;div class='panel panel-<span class="hljs-subst">#{type}</span>'&gt;
        &lt;div class='panel-heading'&gt;
            <span class="hljs-subst">#{details}</span>
            &lt;h3 class='panel-title'&gt;<span class="hljs-subst">#{title}</span>&lt;/h3&gt;
        &lt;/div&gt;
        &lt;div class='panel-body'&gt;
            <span class="hljs-subst">#{comments}</span>
            <span class="hljs-subst">#{state}</span>
        &lt;/div&gt;
    &lt;/div&gt;
    """</span>
</code></pre><p>Now, the main event handler.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">updateHistoryTab</span> = -&gt;</span>
</code></pre><p>We also need several tiny auxiliary functions that aren&#39;t worth
declaring at the global scope, so I declare them here.  They&#39;re
for creating HTML button code.</p>
<p>A run button for use in saved history commands:</p>
<pre class="hljs"><code>    <span class="hljs-function"><span class="hljs-title">makeRunButton</span> = <span class="hljs-params">( index )</span> -&gt;</span> <span class="hljs-string">"""
        &lt;button type='button'
                class='btn btn-xs btn-default pull-right'
                data-toggle='tooltip' title='Run'
                onclick='runSavedStep(<span class="hljs-subst">#{index}</span>);'
         &gt;&lt;span class='glyphicon glyphicon-play'&gt;
                &lt;/span&gt;&lt;/button&gt;"""</span>
</code></pre><p>An edit button for use in current history states:</p>
<pre class="hljs"><code>    <span class="hljs-function"><span class="hljs-title">makeEditButton</span> = <span class="hljs-params">( index )</span> -&gt;</span> <span class="hljs-string">"""
        &lt;button type='button'
                class='btn btn-xs btn-default pull-right'
                data-toggle='tooltip' title='Edit comments'
                onclick='editStateComments(<span class="hljs-subst">#{index}</span>);'
         &gt;&lt;span class='glyphicon glyphicon-pencil'&gt;
                &lt;/span&gt;&lt;/button&gt;"""</span>
</code></pre><p>A pair of thumbs up/down buttons for use in test history states:</p>
<pre class="hljs"><code>    <span class="hljs-function"><span class="hljs-title">makeThumbButtons</span> = <span class="hljs-params">( index )</span> -&gt;</span> <span class="hljs-string">"""
        &lt;button type='button'
                class='btn btn-xs btn-danger pull-right'
                data-toggle='tooltip' title='Mark incorrect'
                onclick='noButtonClicked(<span class="hljs-subst">#{index}</span>);'
         &gt;&lt;span class='glyphicon glyphicon-thumbs-down'&gt;
                &lt;/span&gt;&lt;/button&gt;
        &lt;button type='button'
                class='btn btn-xs btn-success pull-right'
                data-toggle='tooltip' title='Mark correct'
                onclick='yesButtonClicked(<span class="hljs-subst">#{index}</span>);'
         &gt;&lt;span class='glyphicon glyphicon-thumbs-up'&gt;
                &lt;/span&gt;&lt;/button&gt;"""</span>
</code></pre><p>&quot;Same&quot; and &quot;different&quot; indicators for saved history states:</p>
<pre class="hljs"><code>    sameIndicator = <span class="hljs-string">'''
        &lt;div class='pull-right'&gt;SAME
            &lt;span class='glyphicon glyphicon-ok'&gt;&lt;/span&gt;
        &lt;/div&gt;'''</span>
    diffIndicator = <span class="hljs-string">'''
        &lt;div class='pull-right'&gt;DIFFERENT
            &lt;span class='glyphicon glyphicon-remove'&gt;&lt;/span&gt;
        &lt;/div&gt;'''</span>
</code></pre><p>Tool for building rows of two columns:</p>
<pre class="hljs"><code>    <span class="hljs-function"><span class="hljs-title">makeRowOfTwo</span> = <span class="hljs-params">( left, right )</span> -&gt;</span> <span class="hljs-string">"""
        &lt;div class='row'&gt;
            &lt;div class='col-md-6'&gt;<span class="hljs-subst">#{left}</span>&lt;/div&gt;
            &lt;div class='col-md-6'&gt;<span class="hljs-subst">#{right}</span>&lt;/div&gt;
        &lt;/div&gt;"""</span>
</code></pre><p>And now we truly begin!  Initialize the representation to empty,
and we&#39;ll build it as we loop through the histories.</p>
<pre class="hljs"><code>    representation = <span class="hljs-string">''</span>
</code></pre><p>Find out if we&#39;re comparing the current test history to another.</p>
<pre class="hljs"><code>    compare = <span class="hljs-built_in">window</span>.comparisonHistory?.data <span class="hljs-keyword">or</span> <span class="hljs-literal">null</span>
</code></pre><p>Loop through the history&#39;s steps.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">for</span> step, index <span class="hljs-keyword">in</span> testHistory
</code></pre><p>If this is not the initial state, then show the command that got us
to this state.</p>
<pre class="hljs"><code>        <span class="hljs-keyword">if</span> index &gt; <span class="hljs-number">0</span>
            current = historyCommandRepresentation step, index
            <span class="hljs-keyword">if</span> compare
                <span class="hljs-keyword">if</span> index &lt; compare.length
                    saved = historyCommandRepresentation \
                        compare[index], index,
                        makeRunButton index
                <span class="hljs-keyword">else</span>
                    saved = <span class="hljs-string">''</span>
                current = makeRowOfTwo current, saved
            representation += current
</code></pre><p>No matter what state it is, show the state.  We must first
compute the type of panel we will use to show the state, based
on its correctness marking.</p>
<pre class="hljs"><code>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> step.hasOwnProperty <span class="hljs-string">'correct'</span>
            type = <span class="hljs-string">'default'</span>
        <span class="hljs-keyword">else</span>
            type = <span class="hljs-keyword">if</span> step.correct <span class="hljs-keyword">then</span> <span class="hljs-string">'success'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'danger'</span>
        current = historyStateRepresentation step, index,
            makeThumbButtons( index ) +
            makeEditButton( index ), type
        <span class="hljs-keyword">if</span> compare
            <span class="hljs-keyword">if</span> index &lt; compare.length
                left = JSON.stringify step.state
                right = JSON.stringify compare[index].state
                <span class="hljs-keyword">if</span> left <span class="hljs-keyword">is</span> right
                    details = sameIndicator
                    type = <span class="hljs-string">'success'</span>
                <span class="hljs-keyword">else</span>
                    details = diffIndicator
                    type = <span class="hljs-string">'danger'</span>
                saved = historyStateRepresentation \
                    compare[index], index, details, type
            <span class="hljs-keyword">else</span>
                saved = <span class="hljs-string">''</span>
            current = makeRowOfTwo current, saved
        representation += current
</code></pre><p>If there were more steps remaining in the saved history to which
we&#39;re comparing the current one, show those at the end.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">if</span> compare <span class="hljs-keyword">and</span> testHistory.length &lt; compare.length
        <span class="hljs-keyword">for</span> index <span class="hljs-keyword">in</span> [testHistory.length...compare.length]
            step = compare[index]
            code = historyCommandRepresentation step, index,
                makeRunButton index
            state = historyStateRepresentation \
                compare[index], index, <span class="hljs-string">''</span>, <span class="hljs-string">'default'</span>
            representation += makeRowOfTwo <span class="hljs-string">''</span>, code
            representation += makeRowOfTwo <span class="hljs-string">''</span>, state
</code></pre><p>Populate the history tab.</p>
<pre class="hljs"><code>    historyBody.innerHTML = representation
</code></pre><h3><a name='resizing-the-test-history-div'></a>Resizing the test history div &nbsp;  <font size=-1><a href='#resizing-the-test-history-div'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>Because the test history div should be scrollable without the rest
of the page being scrollable, it must have a fixed height.  This is
unfortunate, especially since it requires estimating how tall the
rest of the page will be, and subtracting.  Furthermore, it must be
updated every time the window resizes.  Hence the following
function, which I wish I could do in CSS, but I don&#39;t think I can.</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-title">resizeHistoryHeight</span> = -&gt;</span>
</code></pre><p>First figure out the total height of all children of the main
container, stopping before the tab bodies, which we&#39;re about to
resize.  (After the tab bodies sit modal dialogs, which we do not
wish to include in the height computation.)</p>
<pre class="hljs"><code>    theRest = <span class="hljs-number">75</span> <span class="hljs-comment"># padding</span>
    <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-attribute">Array</span>::slice.apply mainContainer.childNodes
        <span class="hljs-keyword">if</span> ( $ child ).hasClass <span class="hljs-string">'tab-content'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> HTMLElement
            theRest += ( $ child ).outerHeight <span class="hljs-literal">true</span>
</code></pre><p>Then subtract to determine the appropriate resize height.</p>
<pre class="hljs"><code>    ( $ historyBody ).height ( $ <span class="hljs-built_in">window</span> ).height() - theRest
</code></pre><h2><a name='utility-functions'></a>Utility functions &nbsp;  <font size=-1><a href='#utility-functions'><span class="glyphicon glyphicon-link"></span></a></font></h2><pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">initializeHistory</span> = -&gt;</span>
</code></pre><p>Set up the initial test history by reading it from the current
document state.</p>
<pre class="hljs"><code>    <span class="hljs-built_in">window</span>.testHistory = [
        {
            code : <span class="hljs-string">''</span>
            state : LE.getElement().toJSON()
        }
    ]
</code></pre><p>Clear the history to which the user wishes to compare that one,
because at the outset, no such history has been chosen.</p>
<pre class="hljs"><code>    <span class="hljs-built_in">window</span>.comparisonHistory = <span class="hljs-literal">null</span>
</code></pre>
        </div>
        <div id="right">
            <h3 align=center>Navigation</h3><br><h3><a href='index.md.html'>webLurch home</a></h3><p>.</p><ul><li><a href='buildutils.litcoffee.html'>buildutils.litcoffee</a></li><li><a href='cake.litcoffee.html'>cake.litcoffee</a></li></ul><p>./app</p><ul><li><a href='../app/index.html'>index.html</a></li></ul><p>./doc</p><ul><li><a href='overview.md.html'>overview.md</a></li><li><a href='plan.md.html'>plan.md</a></li><li><a href='progress.md.html'>progress.md</a></li><li><a href='test-app-help.md.html'>test-app-help.md</a></li><li><a href='test-results.md.html'>test-results.md</a></li></ul><p>./src</p><ul><li><a href='domeditaction.litcoffee.html'>domeditaction.litcoffee</a></li><li><a href='domedittracker.litcoffee.html'>domedittracker.litcoffee</a></li><li><a href='domutils.litcoffee.html'>domutils.litcoffee</a></li><li><a href='lurcheditor.litcoffee.html'>lurcheditor.litcoffee</a></li><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li></ul><p>./test</p><ul><li><a href='all-histories-spec.litcoffee.html'>all-histories-spec.litcoffee</a></li><li><a href='basic-spec.litcoffee.html'>basic-spec.litcoffee</a></li><li><a href='domeditaction-spec.litcoffee.html'>domeditaction-spec.litcoffee</a></li><li><a href='domedittracker-spec.litcoffee.html'>domedittracker-spec.litcoffee</a></li><li><a href='domutils-spec.litcoffee.html'>domutils-spec.litcoffee</a></li><li><a href='lurcheditor-spec.litcoffee.html'>lurcheditor-spec.litcoffee</a></li><li><a href='phantom-utils.litcoffee.html'>phantom-utils.litcoffee</a></li><li><a href='undoredo-spec.litcoffee.html'>undoredo-spec.litcoffee</a></li></ul><p>./testapp</p><ul><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li><li><a href='../testapp/index.html'>index.html</a></li></ul>
        </div>
    </body>
</html>

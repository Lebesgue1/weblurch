<html>
    <head>
        <link rel="stylesheet"
              href="../bootstrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="./main.css"/>
        <link rel="stylesheet" href="./obsidian.css"/>
        <link rel="shortcut icon" href="favicon.png"/>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config( {
              tex2jax: { inlineMath: [ [ '$', '$' ], [ '\\(', '\\)' ] ] }
            } );
        </script>
        <script type="text/javascript"
                src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <title>webLurch docs: utils</title>
    </head>
    <body>
        <div id="left">
            <p align=center>Page contents</p>
<p><a href='#test-app-utilities'>Test app utilities</a></p><ul>
<li><a href='#setup-routine'>Setup routine</a></li><li><a href='#event-handlers'>Event handlers</a></li><ul>
<li><a href='#dispatcher'>Dispatcher</a></li><li><a href='#source-synchronizer'>Source synchronizer</a></li><li><a href='#code-runner'>Code runner</a></li><li><a href='#yes-and-no-buttons'>Yes and no buttons</a></li><li><a href='#download-button'>Download button</a></li><li><a href='#representation-of-the-test-history'>Representation of the test history</a></li>
        </div>
        <div id="middle">
            <h1><a name='test-app-utilities'></a>Test app utilities &nbsp;  <font size=-1><a href='#test-app-utilities'><span class="glyphicon glyphicon-link"></span></a></font></h1><h2><a name='setup-routine'></a>Setup routine &nbsp;  <font size=-1><a href='#setup-routine'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>The following routine is run after
<a href="../testapp/index.html">the test app page</a> has finished loading.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">testAppSetup</span> = -&gt;</span>
</code></pre><p>Create a <code>LurchEditor</code> instance in the page itself.</p>
<pre class="hljs"><code>    <span class="hljs-built_in">window</span>.LE =
        <span class="hljs-keyword">new</span> LurchEditor <span class="hljs-built_in">document</span>.getElementById <span class="hljs-string">'editor'</span>
</code></pre><p>Create global arrays in which we will store the history of all the
states of the model (i.e., <code>LE</code>&#39;s element), as well as all lines of
code executed to cause changes of state.</p>
<pre class="hljs"><code>    <span class="hljs-built_in">window</span>.testHistory = [
        {
            code : <span class="hljs-string">''</span>
            state : LE.getElement().toJSON()
        }
    ]
</code></pre><p>Store in global variables the important UI elements on the page.</p>
<pre class="hljs"><code>    <span class="hljs-string">'''
    source history historyBody historyTab
    codeInput testNameInput
    runButton yesButton noButton downloadButton
    '''</span> \
    .split<span class="hljs-function"><span class="hljs-params">( <span class="hljs-string">' '</span> )</span>.<span class="hljs-title">map</span> <span class="hljs-params">( id )</span> -&gt;</span>
        <span class="hljs-built_in">window</span>[id] = <span class="hljs-built_in">document</span>.getElementById id
    <span class="hljs-built_in">window</span>.maindiv = LE.getElement()
</code></pre><p>Install event handlers for the buttons.</p>
<pre class="hljs"><code>    ( $ runButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, runButtonClicked
    ( $ yesButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, yesButtonClicked
    ( $ noButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, noButtonClicked
    ( $ downloadButton ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, downloadButtonClicked
</code></pre><p>Make the code input respond to the Enter key by auto-clicking the
run button.</p>
<pre class="hljs"><code>    <span class="hljs-function"><span class="hljs-params">( $ codeInput )</span>.<span class="hljs-title">on</span> '<span class="hljs-title">keyup</span>', <span class="hljs-params">( event )</span> -&gt;</span>
        <span class="hljs-keyword">if</span> event.keyCode <span class="hljs-keyword">is</span> <span class="hljs-number">13</span> <span class="hljs-keyword">then</span> runButtonClicked()
</code></pre><p>Fill the source and/or history tabs only when they become visible,
so we&#39;re not always recomputing their contents.</p>
<pre class="hljs"><code>    ( $ sourceTab ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, updateSourceTab
    ( $ historyTab ).<span class="hljs-literal">on</span> <span class="hljs-string">'click'</span>, updateHistoryTab
</code></pre><p>Run <a href="#source-synchronizer">the routine</a> that updates the source div
with the HTML source of the <code>LurchEditor</code>&#39;s element.</p>
<pre class="hljs"><code>    updateSourceTab()
</code></pre><p>Place the user&#39;s keyboard focus into the code input box.</p>
<pre class="hljs"><code>    codeInput.focus()
</code></pre><h2><a name='event-handlers'></a>Event handlers &nbsp;  <font size=-1><a href='#event-handlers'><span class="glyphicon glyphicon-link"></span></a></font></h2><h3><a name='dispatcher'></a>Dispatcher &nbsp;  <font size=-1><a href='#dispatcher'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>This function dispatches to either the source tab updater or the
history tab updater, depending on which one is visible, if either.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">updateDispatcher</span> = -&gt;</span>
    <span class="hljs-keyword">if</span> ( $ source ).hasClass <span class="hljs-string">'active'</span> <span class="hljs-keyword">then</span> updateSourceTab()
    <span class="hljs-keyword">if</span> ( $ history ).hasClass <span class="hljs-string">'active'</span> <span class="hljs-keyword">then</span> updateHistoryTab()
</code></pre><h3><a name='source-synchronizer'></a>Source synchronizer &nbsp;  <font size=-1><a href='#source-synchronizer'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>The following routine fills the source div with the HTML source of
the <code>LurchEditor</code>&#39;s element.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">updateSourceTab</span> = -&gt;</span>
    code = LE.getElement().outerHTML.replace( <span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">'&amp;amp;'</span> )
                                    .replace( <span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">'&amp;gt;'</span> )
                                    .replace( <span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">'&amp;lt;'</span> )
                                    .replace( <span class="hljs-regexp">/'/g</span>, <span class="hljs-string">'&amp;apos;'</span> )
                                    .replace( <span class="hljs-regexp">/"/g</span>, <span class="hljs-string">'&amp;quot;'</span> )
    source.innerHTML = <span class="hljs-string">"&lt;pre&gt;<span class="hljs-subst">#{code}</span>&lt;/pre&gt;"</span>
</code></pre><h3><a name='code-runner'></a>Code runner &nbsp;  <font size=-1><a href='#code-runner'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>The event handler on the &quot;Run&quot; button that evaluates the code the
user enters in the code input box.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">runButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
    eval codeInput.value
</code></pre><p>It also appends that action and its result to the test history
array.</p>
<pre class="hljs"><code>    testHistory.push {
        code : codeInput.value
        state : LE.getElement().toJSON()
    }
</code></pre><p>Update any visible views, clear the code input, and give it focus.</p>
<pre class="hljs"><code>    updateDispatcher()
    codeInput.value = <span class="hljs-string">''</span>
    codeInput.focus()
</code></pre><h3><a name='yes-and-no-buttons'></a>Yes and no buttons &nbsp;  <font size=-1><a href='#yes-and-no-buttons'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>The event handlers for the &quot;Mark right&quot; and &quot;Mark wrong&quot; buttons
edit the last item pushed onto the <code>testHistory</code> stack.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">yesButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
    testHistory[testHistory.length - <span class="hljs-number">1</span>].correct = <span class="hljs-literal">yes</span>
    updateDispatcher()

<span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">noButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
    testHistory[testHistory.length - <span class="hljs-number">1</span>].correct = <span class="hljs-literal">no</span>
    updateDispatcher()
</code></pre><h3><a name='download-button'></a>Download button &nbsp;  <font size=-1><a href='#download-button'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">downloadButtonClicked</span> = <span class="hljs-params">( event )</span> -&gt;</span>
    data = JSON.stringify testHistory
    blob = <span class="hljs-keyword">new</span> Blob [ data ], type : <span class="hljs-string">'application/json'</span>
    link = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'a'</span>
    link.setAttribute <span class="hljs-string">'href'</span>, URL.createObjectURL blob
    link.setAttribute <span class="hljs-string">'download'</span>,
        <span class="hljs-string">"<span class="hljs-subst">#{testNameInput.value <span class="hljs-keyword">or</span> <span class="hljs-string">'test-history'</span>}</span>.json"</span>
    link.click()
</code></pre><h3><a name='representation-of-the-test-history'></a>Representation of the test history &nbsp;  <font size=-1><a href='#representation-of-the-test-history'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>This routine is the event handler for the display of the History
tab; it populates that tab with an HTML representation of the
current test history.</p>
<pre class="hljs"><code><span class="hljs-built_in">window</span>.<span class="hljs-function"><span class="hljs-title">updateHistoryTab</span> = -&gt;</span>
    representation = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> step, index <span class="hljs-keyword">in</span> testHistory
</code></pre><p>If this is not the initial state, then show the command that got us
to this state.</p>
<pre class="hljs"><code>        <span class="hljs-keyword">if</span> index &gt; <span class="hljs-number">0</span>
            code = step.code.replace( <span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">'&amp;amp;'</span> )
                            .replace( <span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">'&amp;gt;'</span> )
                            .replace( <span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">'&amp;lt;'</span> )
                            .replace( <span class="hljs-regexp">/'/g</span>, <span class="hljs-string">'&amp;apos;'</span> )
                            .replace( <span class="hljs-regexp">/"/g</span>, <span class="hljs-string">'&amp;quot;'</span> )
            representation += <span class="hljs-string">"""
                &lt;div class='panel panel-info'&gt;
                  &lt;div class='panel-heading'&gt;
                    &lt;h3 class='panel-title'
                    &gt;Command <span class="hljs-subst">#{index}</span>:&lt;/h3&gt;
                  &lt;/div&gt;
                  &lt;div class='panel-body'&gt;
                    &lt;pre&gt;<span class="hljs-subst">#{code}</span>&lt;/pre&gt;
                  &lt;/div&gt;
                &lt;/div&gt;
                """</span>
</code></pre><p>Compute the type of panel we will use to show the next state, based
on its correctness marking.</p>
<pre class="hljs"><code>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> step.hasOwnProperty <span class="hljs-string">'correct'</span>
            type = <span class="hljs-string">'default'</span>
        <span class="hljs-keyword">else</span>
            type = <span class="hljs-keyword">if</span> step.correct <span class="hljs-keyword">then</span> <span class="hljs-string">'success'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'danger'</span>
</code></pre><p>De-serialize the model state, do not put it into the page&#39;s DOM,
but convert it to a string of HTML code.  Remove all ids from this
code so that we can use it to represent the document state.</p>
<pre class="hljs"><code>        code = Node.fromJSON( step.state ).outerHTML
        escaped = code.replace( <span class="hljs-regexp">/&amp;/g</span>, <span class="hljs-string">'&amp;amp;'</span> )
                      .replace( <span class="hljs-regexp">/&gt;/g</span>, <span class="hljs-string">'&amp;gt;'</span> )
                      .replace( <span class="hljs-regexp">/&lt;/g</span>, <span class="hljs-string">'&amp;lt;'</span> )
                      .replace( <span class="hljs-regexp">/'/g</span>, <span class="hljs-string">'&amp;apos;'</span> )
                      .replace( <span class="hljs-regexp">/"/g</span>, <span class="hljs-string">'&amp;quot;'</span> )
        code = code.replace <span class="hljs-regexp">/\s+id=['"][^'"]+['"]/g</span>, <span class="hljs-string">''</span>
        state = <span class="hljs-string">"""
            &lt;pre class='gap-below-2'&gt;<span class="hljs-subst">#{escaped}</span>&lt;/pre&gt;
            <span class="hljs-subst">#{code}</span>
            """</span>
</code></pre><p>Show the state in the history step, either as the initial state or
the result of executing some JavaScript code.</p>
<pre class="hljs"><code>        title = <span class="hljs-keyword">if</span> index <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
            <span class="hljs-string">"Initial state:"</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-string">"State after command <span class="hljs-subst">#{index}</span>:"</span>
        <span class="hljs-keyword">if</span> index <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> type += <span class="hljs-string">' gap-before-2'</span>
        representation += <span class="hljs-string">"""
            &lt;div class='panel panel-<span class="hljs-subst">#{type}</span>'&gt;
              &lt;div class='panel-heading'&gt;
                &lt;h3 class='panel-title'&gt;<span class="hljs-subst">#{title}</span>&lt;/h3&gt;
              &lt;/div&gt;
              &lt;div class='panel-body'&gt;<span class="hljs-subst">#{state}</span>&lt;/div&gt;
            &lt;/div&gt;
            """</span>
</code></pre><p>Populate the history tab.</p>
<pre class="hljs"><code>    historyBody.innerHTML = representation
</code></pre>
        </div>
        <div id="right">
            <h3 align=center>Navigation</h3><br><h3><a href='index.md.html'>webLurch home</a></h3><p>.</p><ul><li><a href='buildutils.litcoffee.html'>buildutils.litcoffee</a></li><li><a href='cake.litcoffee.html'>cake.litcoffee</a></li></ul><p>./app</p><ul><li><a href='../app/index.html'>index.html</a></li></ul><p>./doc</p><ul><li><a href='plan.md.html'>plan.md</a></li><li><a href='progress.md.html'>progress.md</a></li><li><a href='test-results.md.html'>test-results.md</a></li></ul><p>./src</p><ul><li><a href='domeditaction.litcoffee.html'>domeditaction.litcoffee</a></li><li><a href='domedittracker.litcoffee.html'>domedittracker.litcoffee</a></li><li><a href='domutils.litcoffee.html'>domutils.litcoffee</a></li><li><a href='lurcheditor.litcoffee.html'>lurcheditor.litcoffee</a></li></ul><p>./test</p><ul><li><a href='all-histories-spec.litcoffee.html'>all-histories-spec.litcoffee</a></li><li><a href='basic-spec.litcoffee.html'>basic-spec.litcoffee</a></li><li><a href='domeditaction-spec.litcoffee.html'>domeditaction-spec.litcoffee</a></li><li><a href='domedittracker-spec.litcoffee.html'>domedittracker-spec.litcoffee</a></li><li><a href='domutils-spec.litcoffee.html'>domutils-spec.litcoffee</a></li><li><a href='lurcheditor-spec.litcoffee.html'>lurcheditor-spec.litcoffee</a></li><li><a href='phantom-utils.litcoffee.html'>phantom-utils.litcoffee</a></li><li><a href='undoredo-spec.litcoffee.html'>undoredo-spec.litcoffee</a></li></ul><p>./testapp</p><ul><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li><li><a href='../testapp/index.html'>index.html</a></li></ul>
        </div>
    </body>
</html>

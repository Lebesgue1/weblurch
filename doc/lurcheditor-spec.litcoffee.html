<html>
    <head>
        <link rel="stylesheet"
              href="../bootstrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="./main.css"/>
        <link rel="stylesheet" href="./obsidian.css"/>
        <link rel="shortcut icon" href="favicon.png"/>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config( {
              tex2jax: { inlineMath: [ [ '$', '$' ], [ '\\(', '\\)' ] ] }
            } );
        </script>
        <script type="text/javascript"
                src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <title>webLurch docs: lurcheditor-spec</title>
    </head>
    <body>
        <div id="left">
            <p align=center>Page contents</p>
<p><a href='#tests-for-the-code-lurcheditor-code-class'>Tests for the <code>LurchEditor</code> class</a></p><ul>
<li><a href='#lurcheditor-class'>LurchEditor class</a></li><ul>
<li><a href='#should-exist'>should exist</a></li></ul>
<li><a href='#lurcheditor-instances-without-divs'>LurchEditor instances without DIVs</a></li><ul>
<li><a href='#should-initialize-freeids'>should initialize freeIds</a></li><li><a href='#nextfreeid-should-count-0-1-2-'>nextFreeId() should count 0,1,2,...</a></li><li><a href='#addfreeid-re-inserts-in-order'>addFreeId() re-inserts in order</a></li></ul>
<li><a href='#lurcheditor-instances-with-divs'>LurchEditor instances with DIVs</a></li><ul>
<li><a href='#should-give-an-empty-div-id-0'>should give an empty DIV id 0</a></li><li><a href='#should-remove-all-invalid-ids'>should remove all invalid ids</a></li><li><a href='#should-assign-unique-integer-ids'>should assign unique integer ids</a></li><li><a href='#should-work-with-existing-integer-ids'>should work with existing integer ids</a></li><li><a href='#should-have-working-address-and-index'>should have working address and index</a></li><li><a href='#should-give-no-address-and-index-if-empty'>should give no address and index if empty</a></li></ul>
<li><a href='#lurcheditor-cursor-support'>LurchEditor cursor support</a></li><ul>
<li><a href='#should-locate-position-and-anchor-elements'>should locate position and anchor elements</a></li><li><a href='#should-provide-the-cursorpositionsin-member'>should provide the cursorPositionsIn member</a></li><li><a href='#should-compute-correct-cursor-position-counts'>should compute correct cursor position counts</a></li><li><a href='#should-provide-the-placecursor-member'>should provide the placeCursor member</a></li><li><a href='#should-place-the-cursor-correctly'>should place the cursor correctly</a></li><li><a href='#should-preserve-the-anchor-correctly'>should preserve the anchor correctly</a></li><li><a href='#should-handle-tables'>should handle tables</a></li>
        </div>
        <div id="middle">
            <h1><a name='tests-for-the-code-lurcheditor-code-class'></a>Tests for the <code>LurchEditor</code> class &nbsp;  <font size=-1><a href='#tests-for-the-code-lurcheditor-code-class'><span class="glyphicon glyphicon-link"></span></a></font></h1><p>Pull in the utility functions in
<a href="phantom-utils.litcoffee.html">phantom-utils</a> that make it
easier to write the tests below.  Then follow the same structure
for setting up tests as documented more thoroughly in
<a href="basic-spec.litcoffee.html">the basic unit test</a>.</p>
<pre class="hljs"><code>{ phantomDescribe, pageDo, pageExpects,
  pageExpectsError, inPage } = <span class="hljs-built_in">require</span> <span class="hljs-string">'./phantom-utils'</span>
</code></pre><h2><a name='lurcheditor-class'></a>LurchEditor class &nbsp; <font size=-1><a href='test-results.md.html#lurcheditor-class'>see results</a></font> <font size=-1><a href='#lurcheditor-class'><span class="glyphicon glyphicon-link"></span></a></font></h2><pre class="hljs"><code>phantomDescribe <span class="hljs-string">'LurchEditor class'</span>, <span class="hljs-string">'./app/index.html'</span>,<span class="hljs-function"> -&gt;</span>
</code></pre><h3><a name='should-exist'></a>should exist &nbsp; <font size=-1><a href='test-results.md.html#should-exist'>see results</a></font> <font size=-1><a href='#should-exist'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>That is, the class should be defined in the global namespace of
the browser after loading the main app page.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should exist'</span>, inPage<span class="hljs-function"> -&gt;</span>
        pageExpects<span class="hljs-function"> -&gt;</span> LurchEditor
</code></pre><h2><a name='lurcheditor-instances-without-divs'></a>LurchEditor instances without DIVs &nbsp; <font size=-1><a href='test-results.md.html#lurcheditor-instances-without-divs'>see results</a></font> <font size=-1><a href='#lurcheditor-instances-without-divs'><span class="glyphicon glyphicon-link"></span></a></font></h2><pre class="hljs"><code>phantomDescribe <span class="hljs-string">'LurchEditor instances without DIVs'</span>,
<span class="hljs-string">'./app/index.html'</span>,<span class="hljs-function"> -&gt;</span>
</code></pre><h3><a name='should-initialize-freeids'></a>should initialize freeIds &nbsp; <font size=-1><a href='test-results.md.html#should-initialize-freeids'>see results</a></font> <font size=-1><a href='#should-initialize-freeids'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>A newly created <code>LurchEditor</code> instance should have a <code>freeIds</code>
array containing only zero.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should initialize freeIds'</span>, inPage<span class="hljs-function"> -&gt;</span>
        pageExpects (<span class="hljs-function"> -&gt;</span>
            L = <span class="hljs-keyword">new</span> LurchEditor()
            L.freeIds
        ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">0</span> ]
</code></pre><p>Calling <code>nextFreeId()</code> on a newly created instance should keep
yielding nonnegative integers starting with zero and counting
upwards.  The resulting <code>freeIds</code> array should have in it just
the next integer.</p>
<h3><a name='nextfreeid-should-count-0-1-2-'></a>nextFreeId() should count 0,1,2,... &nbsp; <font size=-1><a href='test-results.md.html#nextfreeid-should-count-0-1-2-'>see results</a></font> <font size=-1><a href='#nextfreeid-should-count-0-1-2-'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'nextFreeId() should count 0,1,2,...'</span>, inPage<span class="hljs-function"> -&gt;</span>
        pageDo<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">window</span>.L = <span class="hljs-keyword">new</span> LurchEditor()
        pageExpects (<span class="hljs-function"> -&gt;</span> L.nextFreeId() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.nextFreeId() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">1</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.nextFreeId() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">2</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.nextFreeId() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">3</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.freeIds ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">4</span> ]
</code></pre><h3><a name='addfreeid-re-inserts-in-order'></a>addFreeId() re-inserts in order &nbsp; <font size=-1><a href='test-results.md.html#addfreeid-re-inserts-in-order'>see results</a></font> <font size=-1><a href='#addfreeid-re-inserts-in-order'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'addfreeId() re-inserts in order'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>Create a new instance and put it through the same sequence of
<code>nextFreeId()</code> calls as above.  We should get the same result.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.L = <span class="hljs-keyword">new</span> LurchEditor()
            L.nextFreeId() <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span><span class="hljs-number">.4</span>]
        pageExpects (<span class="hljs-function"> -&gt;</span> L.freeIds ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">4</span> ]
</code></pre><p>Then restoring the id 2 should put it back on the <code>freeIds</code> list in
the correct spot.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span> L.addFreeId <span class="hljs-number">2</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.freeIds ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">2</span>, <span class="hljs-number">4</span> ]
</code></pre><p>But restoring any id 4 or higher should do nothing.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            L.addFreeId <span class="hljs-number">4</span>
            L.addFreeId <span class="hljs-number">10</span>
            L.addFreeId <span class="hljs-number">100</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.freeIds ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">2</span>, <span class="hljs-number">4</span> ]
</code></pre><p>Then calls to <code>nextFreeId</code> should yield 2, 4, 5, 6, ...</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span> L.nextFreeId() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">2</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.nextFreeId() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">4</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.nextFreeId() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">5</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.nextFreeId() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">6</span>
</code></pre><h2><a name='lurcheditor-instances-with-divs'></a>LurchEditor instances with DIVs &nbsp; <font size=-1><a href='test-results.md.html#lurcheditor-instances-with-divs'>see results</a></font> <font size=-1><a href='#lurcheditor-instances-with-divs'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>We now test constructing a new <code>LurchEditor</code> instance around an
existing DOM element, and verify that it does the correct things
with ids.  See the documentation in
<a href="lurcheditor.litcoffee.html">the Lurch Editor class itself</a> for
details on what the constructor is expected to do in these
situations, or read each test description below.</p>
<pre class="hljs"><code>phantomDescribe <span class="hljs-string">'LurchEditor instances with DIVs'</span>,
<span class="hljs-string">'./app/index.html'</span>,<span class="hljs-function"> -&gt;</span>
</code></pre><h3><a name='should-give-an-empty-div-id-0'></a>should give an empty DIV id 0 &nbsp; <font size=-1><a href='test-results.md.html#should-give-an-empty-div-id-0'>see results</a></font> <font size=-1><a href='#should-give-an-empty-div-id-0'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should give an empty DIV id 0'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>When constructed in an empty DIV, it should give that DIV the id 0,
and thus have a free ids list of <code>[ 1 ]</code> aftewards.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            <span class="hljs-built_in">document</span>.body.appendChild div
            <span class="hljs-built_in">window</span>.L = <span class="hljs-keyword">new</span> LurchEditor div
        pageExpects (<span class="hljs-function"> -&gt;</span> parseInt( div.id ) ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.freeIds ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">1</span> ]
</code></pre><h3><a name='should-remove-all-invalid-ids'></a>should remove all invalid ids &nbsp; <font size=-1><a href='test-results.md.html#should-remove-all-invalid-ids'>see results</a></font> <font size=-1><a href='#should-remove-all-invalid-ids'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should remove all invalid ids'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>When constructed in a DIV containing a hierarchy of nested spans,
some of which have ids, all of which are invalid, it should remove
all of their old ids, and assign them each a new, unique,
nonnegative integer id.  In this test, we verify only that it
removed all of their old ids.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            <span class="hljs-built_in">document</span>.body.appendChild div
            div.innerHTML =
                <span class="hljs-string">'''
                &lt;span id="yo"&gt;some span
                    &lt;span id="inner"&gt;inner span&lt;/span&gt;
                &lt;/span&gt;
                &lt;b id="-1"&gt;neg number&lt;/b&gt;
                &lt;br&gt;
                &lt;a href="foo" id="-0"&gt;weird&lt;/a&gt;
                &lt;span id="1.0"&gt;int-ish float&lt;/span&gt;
                &lt;span&gt;
                    &lt;span&gt;
                        &lt;span id="hank"&gt;way inside&lt;/span&gt;
                    &lt;/span&gt;
                    &lt;i&gt;italic&lt;/i&gt;
                &lt;/span&gt;
                '''</span>
</code></pre><p>For each id we expect to be in the document (because it&#39;s mentioned
in the HTML code given above), verify that it is actually present
in the document by looking up the id and verifying that the result
is not null.</p>
<pre class="hljs"><code>        pageExpects<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'yo'</span> ) <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'inner'</span> ) <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'-1'</span> ) <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'-0'</span> ) <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'1.0'</span> ) <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'hank'</span> ) <span class="hljs-keyword">isnt</span> <span class="hljs-literal">null</span>
</code></pre><p>Install the Lurch Editor in the DIV in question.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span> <span class="hljs-keyword">new</span> LurchEditor div
</code></pre><p>For each id that used to be in the document, verify that it is no
longer present in the document.</p>
<pre class="hljs"><code>        pageExpects<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'yo'</span> ) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'inner'</span> ) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'-1'</span> ) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'-0'</span> ) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'1.0'</span> ) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
        pageExpects<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-string">'hank'</span> ) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
</code></pre><h3><a name='should-assign-unique-integer-ids'></a>should assign unique integer ids &nbsp; <font size=-1><a href='test-results.md.html#should-assign-unique-integer-ids'>see results</a></font> <font size=-1><a href='#should-assign-unique-integer-ids'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should assign unique integer ids'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>If we re-run the same test as the previous (creating a
<code>LurchEditor</code> class around the same DIV) we should find that it
has also assigned unique non-negative integer ids to each element
in the DOM tree beneath that DIV, starting with 0 and proceeding
upwards sequentially.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            <span class="hljs-built_in">document</span>.body.appendChild div
            div.innerHTML =
                <span class="hljs-string">'''
                &lt;span id="yo"&gt;some span
                    &lt;span id="inner"&gt;inner span&lt;/span&gt;
                &lt;/span&gt;
                &lt;b id="-1"&gt;neg number&lt;/b&gt;
                &lt;br&gt;
                &lt;a href="foo" id="-0"&gt;weird&lt;/a&gt;
                &lt;span id="1.0"&gt;int-ish float&lt;/span&gt;
                &lt;span&gt;
                    &lt;span&gt;
                        &lt;span id="hank"&gt;way inside&lt;/span&gt;
                    &lt;/span&gt;
                    &lt;i&gt;italic&lt;/i&gt;
                &lt;/span&gt;
                '''</span>
</code></pre><p>Construct the <code>LurchEditor</code> instance around the div, as before.</p>
<pre class="hljs"><code>            <span class="hljs-built_in">window</span>.LE = <span class="hljs-keyword">new</span> LurchEditor div
</code></pre><p>Now find all ids of all nodes under that div, and sort numerically.</p>
<pre class="hljs"><code>            <span class="hljs-function"><span class="hljs-title">allNodesUnder</span> = <span class="hljs-params">( node )</span> -&gt;</span>
                result = [ node ]
                <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> node.childNodes
                    result = result.concat allNodesUnder child
                result
            <span class="hljs-built_in">window</span>.ids = ( parseInt node.id <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> \
                allNodesUnder div <span class="hljs-keyword">when</span> node.id )
            ids.sort <span class="hljs-function"><span class="hljs-params">( a, b )</span> -&gt;</span> a - b
</code></pre><p>Verify that the list is <code>[ 0, 1, ..., 10 ]</code>.</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span> ids ), <span class="hljs-string">'toEqual'</span>, [<span class="hljs-number">0.</span><span class="hljs-number">.10</span>]
</code></pre><p>Verify that the list of free ids is &quot;everything 11 and above.&quot;</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span> LE.freeIds ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">11</span> ]
</code></pre><h3><a name='should-work-with-existing-integer-ids'></a>should work with existing integer ids &nbsp; <font size=-1><a href='test-results.md.html#should-work-with-existing-integer-ids'>see results</a></font> <font size=-1><a href='#should-work-with-existing-integer-ids'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>If we run a similar test to the previous two, but with the DIV
slightly altered to include a few valid integer ids, we should
find that it has also assigned unique non-negative integer ids to
each element in the DOM tree beneath that DIV, starting with 0 and
proceeding upwards sequentially, but keeping the existing valid
integer ids unchanged.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should work with existing integer ids'</span>, inPage<span class="hljs-function"> -&gt;</span>
        pageDo<span class="hljs-function"> -&gt;</span>
            div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            <span class="hljs-built_in">document</span>.body.appendChild div
            div.innerHTML =
                <span class="hljs-string">'''
                &lt;span id="yo"&gt;some span
                    &lt;span id="inner"&gt;inner span&lt;/span&gt;
                &lt;/span&gt;
                &lt;b id="1"&gt;pos number&lt;/b&gt;
                &lt;br&gt;
                &lt;a href="foo" id="-0"&gt;weird&lt;/a&gt;
                &lt;span id="20"&gt;big-ish number&lt;/span&gt;
                &lt;span&gt;
                    &lt;span&gt;
                        &lt;span id="hank"&gt;way inside&lt;/span&gt;
                    &lt;/span&gt;
                    &lt;i id=4&gt;italic&lt;/i&gt;
                &lt;/span&gt;
                '''</span>
</code></pre><p>Construct the <code>LurchEditor</code> instance around the div, as before.</p>
<pre class="hljs"><code>            <span class="hljs-built_in">window</span>.LE = <span class="hljs-keyword">new</span> LurchEditor div
</code></pre><p>Now find all ids of all nodes under that div, and sort them.</p>
<pre class="hljs"><code>            <span class="hljs-function"><span class="hljs-title">allNodesUnder</span> = <span class="hljs-params">( node )</span> -&gt;</span>
                result = [ node ]
                <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> node.childNodes
                    result = result.concat allNodesUnder child
                result
            <span class="hljs-built_in">window</span>.ids = ( parseInt node.id <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> \
                allNodesUnder div <span class="hljs-keyword">when</span> node.id )
            ids.sort <span class="hljs-function"><span class="hljs-params">( a, b )</span> -&gt;</span> a - b
</code></pre><p>Verify that the list is <code>[ 0, 1, ..., 9, 20 ]</code>.</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span> ids ), <span class="hljs-string">'toEqual'</span>, [<span class="hljs-number">0.</span><span class="hljs-number">.9</span>].concat [ <span class="hljs-number">20</span> ]
</code></pre><p>Verify that the list of free ids is &quot;everything 10 and above,
except 20.&quot;</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span> LE.freeIds ),
            <span class="hljs-string">'toEqual'</span>, [<span class="hljs-number">10.</span><span class="hljs-number">.19</span>].concat [ <span class="hljs-number">21</span> ]
</code></pre><p>Verify that the ids for the nodes that already had valid integer
ids were left unchanged.</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-number">1</span> ).textContent \
                .replace <span class="hljs-regexp">/^\s+|\s+$/g</span>, <span class="hljs-string">''</span> ),
            <span class="hljs-string">'toEqual'</span>, <span class="hljs-string">'pos number'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-number">4</span> ).textContent \
                .replace <span class="hljs-regexp">/^\s+|\s+$/g</span>, <span class="hljs-string">''</span> ),
            <span class="hljs-string">'toEqual'</span>, <span class="hljs-string">'italic'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">document</span>.getElementById( <span class="hljs-number">20</span> ).textContent \
                .replace <span class="hljs-regexp">/^\s+|\s+$/g</span>, <span class="hljs-string">''</span> ),
            <span class="hljs-string">'toEqual'</span>, <span class="hljs-string">'big-ish number'</span>
</code></pre><h3><a name='should-have-working-address-and-index'></a>should have working address and index &nbsp; <font size=-1><a href='test-results.md.html#should-have-working-address-and-index'>see results</a></font> <font size=-1><a href='#should-have-working-address-and-index'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should have working address and index'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>The <code>LurchEditor</code> class defines shortuct address and index
functions that just make the calls relative to their main HTML
elements.  We verify here briefly that those functions work, but
do not test them extensively, since that is already done in
<a href="domutils-spec.litcoffee.html">the unit test for DOM utilities</a>.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            div.id = <span class="hljs-string">'0'</span>
            <span class="hljs-built_in">document</span>.body.appendChild div
            <span class="hljs-built_in">window</span>.span1 = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'span'</span>
            span1.id = <span class="hljs-string">'1'</span>
            div.appendChild span1
            <span class="hljs-built_in">window</span>.span2 = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'span'</span>
            span2.id = <span class="hljs-string">'2'</span>
            div.appendChild span2
            <span class="hljs-built_in">window</span>.LE = <span class="hljs-keyword">new</span> LurchEditor div
</code></pre><p>Four address queries.</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span> LE.address div ), <span class="hljs-string">'toEqual'</span>, []
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.address span1 ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">0</span> ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.address span2 ), <span class="hljs-string">'toEqual'</span>, [ <span class="hljs-number">1</span> ]
        pageExpects<span class="hljs-function"> -&gt;</span> <span class="hljs-literal">null</span> <span class="hljs-keyword">is</span> LE.address <span class="hljs-built_in">document</span>
</code></pre><p>Four index queries, the last of which we expect to be undefined.</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span> LE.index( [] ).id ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-string">'0'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.index( [ <span class="hljs-number">0</span> ] ).id ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-string">'1'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.index( [ <span class="hljs-number">1</span> ] ).id ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-string">'2'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.index [ <span class="hljs-number">0</span>, <span class="hljs-number">0</span> ] ),
            <span class="hljs-string">'toBeUndefined'</span>
</code></pre><h3><a name='should-give-no-address-and-index-if-empty'></a>should give no address and index if empty &nbsp; <font size=-1><a href='test-results.md.html#should-give-no-address-and-index-if-empty'>see results</a></font> <font size=-1><a href='#should-give-no-address-and-index-if-empty'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should give no address and index if empty'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>The shortuct address and index functions in the <code>LurchEditor</code> class
should function correctly (returning null) if the main HTML element
of the instance is empty.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            <span class="hljs-built_in">document</span>.body.appendChild div
            <span class="hljs-built_in">window</span>.LE = <span class="hljs-keyword">new</span> LurchEditor()
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.address div ), <span class="hljs-string">'toBeNull'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.index div ), <span class="hljs-string">'toBeNull'</span>
</code></pre><h2><a name='lurcheditor-cursor-support'></a>LurchEditor cursor support &nbsp; <font size=-1><a href='test-results.md.html#lurcheditor-cursor-support'>see results</a></font> <font size=-1><a href='#lurcheditor-cursor-support'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>We now test the routines that support placement and movement of
cursor position and anchor elements in the document.</p>
<pre class="hljs"><code>phantomDescribe <span class="hljs-string">'LurchEditor cursor support'</span>,
<span class="hljs-string">'./app/index.html'</span>,<span class="hljs-function"> -&gt;</span>
</code></pre><h3><a name='should-locate-position-and-anchor-elements'></a>should locate position and anchor elements &nbsp; <font size=-1><a href='test-results.md.html#should-locate-position-and-anchor-elements'>see results</a></font> <font size=-1><a href='#should-locate-position-and-anchor-elements'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should locate position and anchor elements'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>In this test we construct a <code>LurchEditor</code> over a div that&#39;s got
some elements inside that can function like cursor position and
anchor markers.  We assign those elements the appropriate ids to
indicate that they are cursor position and anchor markers, and
verify that the editor can identify them as such.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
</code></pre><p>Create a div and put inside five spans, only two of which are
marked as cursor position and anchor elements.</p>
<pre class="hljs"><code>            <span class="hljs-built_in">window</span>.div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            <span class="hljs-built_in">document</span>.body.appendChild div
            <span class="hljs-built_in">window</span>.LE = <span class="hljs-keyword">new</span> LurchEditor div
            temp = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'span'</span>
            temp.textContent = <span class="hljs-string">'not important'</span>
            div.appendChild temp
            <span class="hljs-built_in">window</span>.P = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'span'</span>
            P.id = <span class="hljs-attribute">LurchEditor</span>::positionId
            P.textContent = <span class="hljs-string">'foo'</span>
            div.appendChild P
            temp = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'span'</span>
            temp.textContent = <span class="hljs-string">'also not important'</span>
            div.appendChild temp
            <span class="hljs-built_in">window</span>.A = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'span'</span>
            A.id = <span class="hljs-attribute">LurchEditor</span>::anchorId
            A.textContent = <span class="hljs-string">'bar'</span>
            div.appendChild A
            temp = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'span'</span>
            temp.textContent = <span class="hljs-string">'yes, still not important'</span>
            div.appendChild temp
</code></pre><p>Verify that, at first, the <code>LurchEditor</code> instance has no known
cursor position or anchor elements.</p>
<pre class="hljs"><code>        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursor.position ), <span class="hljs-string">'toBeNull'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursor.anchor ), <span class="hljs-string">'toBeNull'</span>
</code></pre><p>Now have the editor find its cursor position and anchor elements.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span> LE.updateCursor()
</code></pre><p>Verify that it found the correct items.</p>
<pre class="hljs"><code>        pageExpects<span class="hljs-function"> -&gt;</span> LE.cursor.position <span class="hljs-keyword">is</span> P
        pageExpects<span class="hljs-function"> -&gt;</span> LE.cursor.anchor <span class="hljs-keyword">is</span> A
</code></pre><p>Next, remove those elements from the document.  We will then
recompute the cursor position and anchor, and verify that they
have become null once again.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            div.removeChild P
            div.removeChild A
            LE.updateCursor()
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursor.position ), <span class="hljs-string">'toBeNull'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursor.anchor ), <span class="hljs-string">'toBeNull'</span>
</code></pre><h3><a name='should-provide-the-cursorpositionsin-member'></a>should provide the cursorPositionsIn member &nbsp; <font size=-1><a href='test-results.md.html#should-provide-the-cursorpositionsin-member'>see results</a></font> <font size=-1><a href='#should-provide-the-cursorpositionsin-member'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>This section and the next test the routine defined <a href="lurcheditor.litcoffee#number-of-cursor-positions-with-a-given-node">here</a>.</p>
<p>First, just verify that it&#39;s present.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should provide the cursorPositionsIn member'</span>, inPage<span class="hljs-function"> -&gt;</span>
        pageExpects<span class="hljs-function"> -&gt;</span> <span class="hljs-attribute">LurchEditor</span>::cursorPositionsIn
</code></pre><h3><a name='should-compute-correct-cursor-position-counts'></a>should compute correct cursor position counts &nbsp; <font size=-1><a href='test-results.md.html#should-compute-correct-cursor-position-counts'>see results</a></font> <font size=-1><a href='#should-compute-correct-cursor-position-counts'><span class="glyphicon glyphicon-link"></span></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should compute correct cursor position counts'</span>,
    inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>The title for this test is vague, but the reason is so that we
may pack several tests into one <code>it</code> call.  (There is no need to
reload the page after each of these.)</p>
<p>First, the character count of a text node should be the number of
characters in it minus one.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.L = <span class="hljs-keyword">new</span> LurchEditor()
            <span class="hljs-built_in">window</span>.T = <span class="hljs-built_in">document</span>.createTextNode <span class="hljs-string">''</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn T ), <span class="hljs-string">'toEqual'</span>, -<span class="hljs-number">1</span>
        pageDo<span class="hljs-function"> -&gt;</span> T.textContent = <span class="hljs-string">'A'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn T ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
        pageDo<span class="hljs-function"> -&gt;</span> T.textContent = <span class="hljs-string">'hi'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn T ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">1</span>
        pageDo<span class="hljs-function"> -&gt;</span> T.textContent = <span class="hljs-string">'hello, friends'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn T ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">13</span>
</code></pre><p>Second, a non-text node with no children and no permission to
contain the cursor should have no cursor positions.  Here I test
just a few example such elements.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">window</span>.S = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'img'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn S ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
        pageDo<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">window</span>.S = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'hr'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn S ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
        pageDo<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">window</span>.S = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'br'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn S ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
</code></pre><p>Third, a non-text node with no children but with position to
contain the cursor should have one cursor position.  Here I test
just a few example such elements.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">window</span>.S = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'a'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn S ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">1</span>
        pageDo<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">window</span>.S = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'td'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn S ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">1</span>
        pageDo<span class="hljs-function"> -&gt;</span> <span class="hljs-built_in">window</span>.S = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'span'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn S ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">1</span>
</code></pre><p>Elements with children should return the total count of all
characters in all children, plus the number of children, plus 1.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.D = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            D.innerHTML = <span class="hljs-string">'some text &lt;span&gt;more text&lt;/span&gt;&lt;br
                &gt;&lt;span&gt;nest&lt;i&gt;ed&lt;/i&gt;&lt;/span&gt;'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn D ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">33</span>
        pageDo<span class="hljs-function"> -&gt;</span> D.innerHTML = <span class="hljs-string">'&lt;b&gt;&lt;i&gt;&lt;u&gt;1&lt;/u&gt;&lt;/i&gt;&lt;/b&gt;'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn D ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">8</span>
</code></pre><p>Now test the difficult situation of tables, which are complex
structures.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.TBL = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            TBL.innerHTML = <span class="hljs-string">'before &lt;table&gt;&lt;tr&gt;&lt;th&gt;one&lt;/th&gt;
                &lt;th&gt;two&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;three&lt;/td&gt;
                &lt;td&gt;four&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt; after'</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> L.cursorPositionsIn TBL ),
            <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">34</span>
</code></pre><h3><a name='should-provide-the-placecursor-member'></a>should provide the placeCursor member &nbsp; <font size=-1><a href='test-results.md.html#should-provide-the-placecursor-member'>see results</a></font> <font size=-1><a href='#should-provide-the-placecursor-member'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>This section and the next test the routine defined <a href="lurcheditor.litcoffee#inserting-the-cursor-into-the-document">here</a>.
Note that testing <code>placeCursor</code> implicitly tests <code>removeCursor</code>
because <code>removeCursor</code> is called at the beginning of every run of
<code>placeCursor</code>, and if it didn&#39;t work, then there would be two
cursors in the document thereafter, and the <code>placeCursor</code> tests
would therefore fail.</p>
<p>First, just verify that it&#39;s present.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should provide the placeCursor member'</span>, inPage<span class="hljs-function"> -&gt;</span>
        pageExpects<span class="hljs-function"> -&gt;</span> <span class="hljs-attribute">LurchEditor</span>::placeCursor
</code></pre><h3><a name='should-place-the-cursor-correctly'></a>should place the cursor correctly &nbsp; <font size=-1><a href='test-results.md.html#should-place-the-cursor-correctly'>see results</a></font> <font size=-1><a href='#should-place-the-cursor-correctly'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>In this routine, not only do we test the <code>placeCursor</code> routine,
verifying that it puts the cursor where we expect, but we also
verify that, after the cursor has been placed, it reports its
position correctly.  That is, if we put the cursor at position $k$,
then after verifying that it appeared where we expect, we also
query its position (using <code>cursorPositionOf</code>) and ensure that it is
$k$.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should place the cursor correctly'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>Initialize the contents of the main div to have some text, some
no-children nodes, and some nested items.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.div = LE.getElement()
            div.innerHTML =
                <span class="hljs-string">'text&lt;br&gt;&lt;span&gt;&lt;i&gt;more&lt;/i&gt;&lt;/span&gt;&lt;b&gt;&lt;/b&gt;'</span>
</code></pre><p>Verify that the desired structure was produced.</p>
<pre class="hljs"><code>        initialConfiguration = {
            tagName : <span class="hljs-string">'DIV'</span>
            attributes : { id : <span class="hljs-string">'0'</span> }
            children : [
                <span class="hljs-string">'text'</span>
                tagName : <span class="hljs-string">'BR'</span>
                {
                    tagName : <span class="hljs-string">'SPAN'</span>
                    children : [
                        {
                            tagName : <span class="hljs-string">'I'</span>
                            children : [ <span class="hljs-string">'more'</span> ]
                        }
                    ]
                }
                tagName : <span class="hljs-string">'B'</span>
            ]
        }
        pageExpects (<span class="hljs-function"> -&gt;</span> div.toJSON() ), <span class="hljs-string">'toEqual'</span>,
            initialConfiguration
</code></pre><p>Place the cursor at the beginning of the document.  Then remove any
indication of whether the cursor is blinking on or off, and clone
that state of the document for later comparison.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor()
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 0.</p>
<pre class="hljs"><code>        cursor = {
            tagName : <span class="hljs-string">'SPAN'</span>
            attributes : { id : <span class="hljs-string">'lurch-cursor-position'</span> }
        }
        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children.unshift cursor
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
</code></pre><p>Place the cursor way past the end of the document, which will be
treated as placing it at the end of the document.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">1000</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 15, which is the last
one in the document.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children.push cursor
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">15</span>
</code></pre><p>Place the cursor between the first two nodes (text and BR).
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">4</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 4.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children = [
            copy.children[<span class="hljs-number">0</span>]
            cursor
            copy.children[<span class="hljs-number">1</span>]
            copy.children[<span class="hljs-number">2</span>]
            copy.children[<span class="hljs-number">3</span>]
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">4</span>
</code></pre><p>Place the cursor between the second and third nodes (BR and span).
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">5</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 5.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children = [
            copy.children[<span class="hljs-number">0</span>]
            copy.children[<span class="hljs-number">1</span>]
            cursor
            copy.children[<span class="hljs-number">2</span>]
            copy.children[<span class="hljs-number">3</span>]
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">5</span>
</code></pre><p>Place the cursor inside the initial text node, and ensure it
splits.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">2</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 2.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children = [
            <span class="hljs-string">'te'</span>
            cursor
            <span class="hljs-string">'xt'</span>
            copy.children[<span class="hljs-number">1</span>]
            copy.children[<span class="hljs-number">2</span>]
            copy.children[<span class="hljs-number">3</span>]
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">2</span>
</code></pre><p>Place the cursor inside the final span, but not yet inside its
inner italic element.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">6</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 6.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">2</span>].children = [
            cursor
            copy.children[<span class="hljs-number">2</span>].children[<span class="hljs-number">0</span>]
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">6</span>
</code></pre><p>Place the cursor one step further, not only inside the final span,
but also inside its inner italic element, just before the text
inside that italic element.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">7</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 7.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">2</span>].children[<span class="hljs-number">0</span>].children = [
            cursor
            <span class="hljs-string">'more'</span>
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">7</span>
</code></pre><p>Place the cursor one step further, thus splitting the text &quot;more&quot;
into two pieces.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">8</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 8.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">2</span>].children[<span class="hljs-number">0</span>].children = [
            <span class="hljs-string">'m'</span>
            cursor
            <span class="hljs-string">'ore'</span>
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">8</span>
</code></pre><p>Place the cursor two steps further, thus splitting the text &quot;more&quot;
at a different location.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">10</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 10.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">2</span>].children[<span class="hljs-number">0</span>].children = [
            <span class="hljs-string">'mor'</span>
            cursor
            <span class="hljs-string">'e'</span>
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">10</span>
</code></pre><p>Place the cursor one step further, after the text &quot;more&quot; but still
inside the italic element.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">11</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 11.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">2</span>].children[<span class="hljs-number">0</span>].children = [
            <span class="hljs-string">'more'</span>
            cursor
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">11</span>
</code></pre><p>Place the cursor one step further, after the italic element but
still inside the span.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">12</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 12.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">2</span>].children = [
            copy.children[<span class="hljs-number">2</span>].children[<span class="hljs-number">0</span>]
            cursor
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">12</span>
</code></pre><p>Place the cursor one step further, and verify that that is right
before the empty bold element.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">13</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 13.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children = [
            copy.children[<span class="hljs-number">0</span>]
            copy.children[<span class="hljs-number">1</span>]
            copy.children[<span class="hljs-number">2</span>]
            cursor
            copy.children[<span class="hljs-number">3</span>]
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">13</span>
</code></pre><p>Place the cursor one step further, and verify that that is inside
the empty bold element.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">14</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 14.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">3</span>].children = [ cursor ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">14</span>
</code></pre><p>Place the cursor one step further, and verify that that is at the
end of the document.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">15</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 15.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children.push cursor
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">15</span>
</code></pre><h3><a name='should-preserve-the-anchor-correctly'></a>should preserve the anchor correctly &nbsp; <font size=-1><a href='test-results.md.html#should-preserve-the-anchor-correctly'>see results</a></font> <font size=-1><a href='#should-preserve-the-anchor-correctly'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>The <code>placeCursor</code> routine takes an optional parameter that can
make the cursor&#39;s anchor stay still while the cursor moves.
We thus take variations on the previous section&#39;s tests, now
keeping the anchor still, and verifying that the results remain
correct.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should preserve the anchor correctly'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>Initialize the contents of the main div as in the previous test.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.div = LE.getElement()
            div.innerHTML =
                <span class="hljs-string">'text&lt;br&gt;&lt;span&gt;&lt;i&gt;more&lt;/i&gt;&lt;/span&gt;&lt;b&gt;&lt;/b&gt;'</span>
</code></pre><p>Verify that the desired structure was produced.</p>
<pre class="hljs"><code>        initialConfiguration = {
            tagName : <span class="hljs-string">'DIV'</span>
            attributes : { id : <span class="hljs-string">'0'</span> }
            children : [
                <span class="hljs-string">'text'</span>
                tagName : <span class="hljs-string">'BR'</span>
                {
                    tagName : <span class="hljs-string">'SPAN'</span>
                    children : [
                        {
                            tagName : <span class="hljs-string">'I'</span>
                            children : [ <span class="hljs-string">'more'</span> ]
                        }
                    ]
                }
                tagName : <span class="hljs-string">'B'</span>
            ]
        }
        pageExpects (<span class="hljs-function"> -&gt;</span> div.toJSON() ), <span class="hljs-string">'toEqual'</span>,
            initialConfiguration
</code></pre><p>Place the cursor at the beginning of the document.  Then remove
any indication of whether the cursor is blinking on or off, and
clone that state of the document for later comparison.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor()
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 0.</p>
<pre class="hljs"><code>        cursor = {
            tagName : <span class="hljs-string">'SPAN'</span>
            attributes : { id : <span class="hljs-string">'lurch-cursor-position'</span> }
        }
        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children.unshift cursor
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.anchorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
</code></pre><p>Place the cursor way past the end of the document, which will be
treated as placing it at the end of the document.  Do not let
the anchor move.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        anchor = {
            tagName : <span class="hljs-string">'SPAN'</span>
            attributes : { id : <span class="hljs-string">'lurch-cursor-anchor'</span> }
        }
        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">1000</span>, <span class="hljs-literal">no</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 15, which is the last
one in the document.  The anchor must remain at position zero, and
all elements between the two must have the selection class.</p>
<pre class="hljs"><code>        selected = class : 'lurch-cursor-selection'
        wrapped = class : 'lurch-selection-wrap
            lurch-cursor-selection'
        copy = {
            tagName : 'DIV'
            attributes : { id : '0' }
            children : [
                anchor
                {
                    tagName : 'SPAN'
                    attributes : wrapped
                    children : [ 'text' ]
                }
                {
                    tagName : 'BR'
                    attributes : selected
                }
                {
                    tagName : 'SPAN'
                    attributes : selected
                    children : [
                        {
                            tagName : 'I'
                            attributes : selected
                            children : [ 'more' ]
                        }
                    ]
                }
                {
                    tagName : 'B'
                    attributes : selected
                }
                cursor
            ]
        }
        pageExpects ( -&gt; LEcopy.toJSON() ), 'toEqual', copy
        pageExpects ( -&gt; LE.cursorPosition() ), 'toEqual', 15
        pageExpects ( -&gt; LE.anchorPosition() ), 'toEqual', 0
</code></pre><p>Place the cursor between the first two nodes (text and BR).
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">4</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 4.  The anchor, too,
has position 4, and no elements are selected.</p>
<pre class="hljs"><code>        copy = {
            tagName : <span class="hljs-string">'DIV'</span>
            attributes : { id : <span class="hljs-string">'0'</span> }
            children : [
                <span class="hljs-string">'text'</span>
                cursor
                tagName : <span class="hljs-string">'BR'</span>
                {
                    tagName : <span class="hljs-string">'SPAN'</span>
                    children : [
                        {
                            tagName : <span class="hljs-string">'I'</span>
                            children : [ <span class="hljs-string">'more'</span> ]
                        }
                    ]
                }
                tagName : <span class="hljs-string">'B'</span>
            ]
        }
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">4</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.anchorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">4</span>
</code></pre><p>Place the cursor between the second and third nodes (BR and span).
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">5</span>, <span class="hljs-literal">no</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 5.  The anchor still
has position 4 and the one element between them is selected.</p>
<pre class="hljs"><code>        copy = {
            tagName : <span class="hljs-string">'DIV'</span>
            attributes : { id : <span class="hljs-string">'0'</span> }
            children : [
                <span class="hljs-string">'text'</span>
                anchor
                {
                    tagName : <span class="hljs-string">'BR'</span>
                    attributes : selected
                }
                cursor
                {
                    tagName : <span class="hljs-string">'SPAN'</span>
                    children : [
                        {
                            tagName : <span class="hljs-string">'I'</span>
                            children : [ <span class="hljs-string">'more'</span> ]
                        }
                    ]
                }
                tagName : <span class="hljs-string">'B'</span>
            ]
        }
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">5</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.anchorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">4</span>
</code></pre><p>Place the cursor inside the initial text node, and ensure it
splits.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">2</span>, <span class="hljs-literal">no</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 2.  The anchor
remains at position 4, and the text between them has been wrapped
in a span that lets it have the CSS style for the cursor
selection.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children = [
            <span class="hljs-string">'te'</span>
            cursor
            {
                tagName : <span class="hljs-string">'SPAN'</span>
                attributes : wrapped
                children : [ <span class="hljs-string">'xt'</span> ]
            }
            anchor
            copy.children[<span class="hljs-number">1</span>]
            copy.children[<span class="hljs-number">2</span>]
            copy.children[<span class="hljs-number">3</span>]
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">2</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.anchorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">4</span>
</code></pre><p>Place the cursor inside the final span, but not yet inside its
inner italic element.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">6</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 6.  The anchor, too,
is at position 6, and so no elements are selected.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">2</span>].children = [
            cursor
            copy.children[<span class="hljs-number">2</span>].children[<span class="hljs-number">0</span>]
        ]
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">6</span>
</code></pre><h3><a name='should-handle-tables'></a>should handle tables &nbsp; <font size=-1><a href='test-results.md.html#should-handle-tables'>see results</a></font> <font size=-1><a href='#should-handle-tables'><span class="glyphicon glyphicon-link"></span></a></font></h3><p>Because HTML tables are complex structures, one of the trickier
tests of the cursor routines is whether it can work well with
tables.  This routine puts a simple table into the document and
tries to move the cursor and anchor among its cells and the
adjacent elements.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should handle tables'</span>, inPage<span class="hljs-function"> -&gt;</span>
</code></pre><p>Initialize the contents of the main div, now with a table and some
other things nearby.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            <span class="hljs-built_in">window</span>.div = LE.getElement()
            div.innerHTML =
                <span class="hljs-string">'plain text before the table'</span> +
                <span class="hljs-string">'&lt;table&gt;&lt;tr&gt;&lt;th&gt;Column 1&lt;/td&gt;'</span> +
                <span class="hljs-string">'&lt;th&gt;Column 2&lt;/td&gt;&lt;/tr&gt;'</span> +
                <span class="hljs-string">'&lt;tr&gt;&lt;td&gt;blah&lt;/td&gt;&lt;td&gt;blah&lt;/td&gt;&lt;/tr&gt;'</span> +
                <span class="hljs-string">'&lt;/table&gt;&lt;div&gt;&lt;b&gt;Content&lt;/b&gt; after&lt;/div&gt;'</span>
</code></pre><p>Verify that the desired structure was produced.</p>
<pre class="hljs"><code>        initialConfiguration = {
            tagName : <span class="hljs-string">'DIV'</span>
            attributes : { id : <span class="hljs-string">'0'</span> }
            children : [
                <span class="hljs-string">'plain text before the table'</span>
                {
                    tagName : <span class="hljs-string">'TABLE'</span>
                    children : [
                        {
                            tagName : <span class="hljs-string">'TBODY'</span>
                            children : [
                                {
                                    tagName : <span class="hljs-string">'TR'</span>
                                    children : [
                                        {
                                            tagName : <span class="hljs-string">'TH'</span>
                                            children : [
                                                <span class="hljs-string">'Column 1'</span>
                                            ]
                                        }
                                        {
                                            tagName : <span class="hljs-string">'TH'</span>
                                            children : [
                                                <span class="hljs-string">'Column 2'</span>
                                            ]
                                        }
                                    ]
                                }
                                {
                                    tagName : <span class="hljs-string">'TR'</span>
                                    children : [
                                        {
                                            tagName : <span class="hljs-string">'TD'</span>
                                            children : [
                                                <span class="hljs-string">'blah'</span>
                                            ]
                                        }
                                        {
                                            tagName : <span class="hljs-string">'TD'</span>
                                            children : [
                                                <span class="hljs-string">'blah'</span>
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
                {
                    tagName : <span class="hljs-string">'DIV'</span>
                    children : [
                        {
                            tagName : <span class="hljs-string">'B'</span>
                            children : [ <span class="hljs-string">'Content'</span> ]
                        }
                        <span class="hljs-string">' after'</span>
                    ]
                }
            ]
        }
        pageExpects (<span class="hljs-function"> -&gt;</span> div.toJSON() ), <span class="hljs-string">'toEqual'</span>,
            initialConfiguration
</code></pre><p>Place the cursor at the beginning of the document.  Then remove
any indication of whether the cursor is blinking on or off, and
clone that state of the document for later comparison.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor()
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 0.</p>
<pre class="hljs"><code>        cursor = {
            tagName : <span class="hljs-string">'SPAN'</span>
            attributes : { id : <span class="hljs-string">'lurch-cursor-position'</span> }
        }
        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children.unshift cursor
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.anchorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">0</span>
</code></pre><p>Place the cursor way past the end of the document, which will be
treated as placing it at the end of the document.  Move the anchor
with it.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">1000</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 73, which is the last
one in the document.  The anchor must remain at position zero, and
all elements between the two must have the selection class.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children.push cursor
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">73</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.anchorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">73</span>
</code></pre><p>Place the cursor just inside the first table cell.  This is an
important point to test, because several seemingly-valid cursor
positions (i.e., immediately inside the TABLE, TBODY, and TR
elements) must be skipped in favor of the TD element.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">28</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 28.</p>
<pre class="hljs"><code>        copy = JSON.parse JSON.stringify initialConfiguration
        copy.children[<span class="hljs-number">1</span>].children[<span class="hljs-number">0</span>].children[<span class="hljs-number">0</span>] \
            .children[<span class="hljs-number">0</span>].children.unshift cursor
        pageExpects (<span class="hljs-function"> -&gt;</span> LEcopy.toJSON() ), <span class="hljs-string">'toEqual'</span>, copy
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.cursorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">28</span>
        pageExpects (<span class="hljs-function"> -&gt;</span> LE.anchorPosition() ), <span class="hljs-string">'toEqual'</span>, <span class="hljs-number">28</span>
</code></pre><p>Now try to highlight a selection from there into half-way through
the first cell in the second row.
Again, we make a clone to remove the possibility of cursor
blinking.</p>
<pre class="hljs"><code>        pageDo<span class="hljs-function"> -&gt;</span>
            LE.placeCursor <span class="hljs-number">48</span>, <span class="hljs-literal">no</span>
            <span class="hljs-attribute">LurchEditor</span>::blinkCursors <span class="hljs-literal">off</span>
            <span class="hljs-built_in">window</span>.LEcopy = LE.getElement().cloneNode <span class="hljs-literal">true</span>
</code></pre><p>Verify that it got there, and is at position 28.</p>
<pre class="hljs"><code>        anchor = {
            tagName : 'SPAN'
            attributes : { id : 'lurch-cursor-anchor' }
        }
        selected = class : 'lurch-cursor-selection'
        wrapped = class : 'lurch-selection-wrap
            lurch-cursor-selection'
        copy = {
            tagName : 'DIV'
            attributes : { id : '0' }
            children : [
                'plain text before the table'
                {
                    tagName : 'TABLE'
                    children : [
                        {
                            tagName : 'TBODY'
                            children : [
                                {
                                    tagName : 'TR'
                                    children : [
                                        {
                                            tagName : 'TH'
                                            children : [
                                                anchor
                                                {
                                                    tagName : 'SPAN'
                                                    attributes : wrapped
                                                    children : [ 'Column 1' ]
                                                }
                                            ]
                                        }
                                        {
                                            tagName : 'TH'
                                            attributes : \
                                                selected
                                            children : [
                                                'Column 2'
                                            ]
                                        }
                                    ]
                                }
                                {
                                    tagName : 'TR'
                                    children : [
                                        {
                                            tagName : 'TD'
                                            children : [
                                                {
                                                    tagName : 'SPAN'
                                                    attributes : wrapped
                                                    children : [ 'bl' ]
                                                }
                                                cursor
                                                'ah'
                                            ]
                                        }
                                        {
                                            tagName : 'TD'
                                            children : [
                                                'blah'
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
                {
                    tagName : 'DIV'
                    children : [
                        {
                            tagName : 'B'
                            children : [ 'Content' ]
                        }
                        ' after'
                    ]
                }
            ]
        }
        pageExpects ( -&gt; LEcopy.toJSON() ), 'toEqual', copy
        pageExpects ( -&gt; LE.cursorPosition() ), 'toEqual', 48
        pageExpects ( -&gt; LE.anchorPosition() ), 'toEqual', 28
</code></pre>
        </div>
        <div id="right">
            <h3 align=center>Navigation</h3><br><h3><a href='index.md.html'>webLurch home</a></h3><p>.</p><ul><li><a href='buildutils.litcoffee.html'>buildutils.litcoffee</a></li><li><a href='cake.litcoffee.html'>cake.litcoffee</a></li></ul><p>./app</p><ul><li><a href='../app/index.html'>index.html</a></li></ul><p>./doc</p><ul><li><a href='overview.md.html'>overview.md</a></li><li><a href='plan.md.html'>plan.md</a></li><li><a href='progress.md.html'>progress.md</a></li><li><a href='test-app-help.md.html'>test-app-help.md</a></li><li><a href='test-results.md.html'>test-results.md</a></li></ul><p>./src</p><ul><li><a href='domeditaction.litcoffee.html'>domeditaction.litcoffee</a></li><li><a href='domedittracker.litcoffee.html'>domedittracker.litcoffee</a></li><li><a href='domutils.litcoffee.html'>domutils.litcoffee</a></li><li><a href='lurcheditor.litcoffee.html'>lurcheditor.litcoffee</a></li><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li></ul><p>./test</p><ul><li><a href='all-histories-spec.litcoffee.html'>all-histories-spec.litcoffee</a></li><li><a href='basic-spec.litcoffee.html'>basic-spec.litcoffee</a></li><li><a href='domeditaction-spec.litcoffee.html'>domeditaction-spec.litcoffee</a></li><li><a href='domedittracker-spec.litcoffee.html'>domedittracker-spec.litcoffee</a></li><li><a href='domutils-spec.litcoffee.html'>domutils-spec.litcoffee</a></li><li><a href='lurcheditor-spec.litcoffee.html'>lurcheditor-spec.litcoffee</a></li><li><a href='phantom-utils.litcoffee.html'>phantom-utils.litcoffee</a></li><li><a href='undoredo-spec.litcoffee.html'>undoredo-spec.litcoffee</a></li><li><a href='utils-spec.litcoffee.html'>utils-spec.litcoffee</a></li></ul><p>./testapp</p><ul><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li><li><a href='../testapp/index.html'>index.html</a></li></ul>
        </div>
    </body>
</html>

<html>
    <head>
        <link rel="stylesheet" href="./main.css"/>
        <link rel="stylesheet" href="./obsidian.css"/>
        <link rel="shortcut icon" href="favicon.png"/>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config( {
              tex2jax: { inlineMath: [ [ '$', '$' ], [ '\\(', '\\)' ] ] }
            } );
        </script>
        <script type="text/javascript"
                src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <title>webLurch docs: lurcheditor-spec</title>
    </head>
    <body>
        <div id="left">
            webLurch source code docs
        </div>
        <div id="middle">
            <h1><a name='tests-for-the-code-lurcheditor-code-class'></a>Tests for the <code>LurchEditor</code> class &nbsp; <font size=-1><a href='test-results.md.html#tests-for-the-code-lurcheditor-code-class'>see results</a></font> <font size=-1><a href='#tests-for-the-code-lurcheditor-code-class'><img src="link.png" class="anchor"></a></font></h1><p>Pull in the utility functions in
<a href="phantom-utils.litcoffee.html">phantom-utils</a> that make it
easier to write the tests below.  Then follow the same structure
for setting up tests as documented more thoroughly in
<a href="basic-spec.litcoffee.html">the basic unit test</a>.</p>
<pre class="hljs"><code>{ phantomDescribe } = <span class="hljs-keyword">require</span> <span class="hljs-string">'./phantom-utils'</span>
</code></pre><h2><a name='lurcheditor-class'></a>LurchEditor class &nbsp; <font size=-1><a href='test-results.md.html#lurcheditor-class'>see results</a></font> <font size=-1><a href='#lurcheditor-class'><img src="link.png" class="anchor"></a></font></h2><pre class="hljs"><code>phantomDescribe <span class="hljs-string">'LurchEditor class'</span>, <span class="hljs-string">'./app/index.html'</span>,<span class="hljs-function"> -&gt;</span>
</code></pre><h3><a name='should-exist'></a>should exist &nbsp; <font size=-1><a href='test-results.md.html#should-exist'>see results</a></font> <font size=-1><a href='#should-exist'><img src="link.png" class="anchor"></a></font></h3><p>That is, the class should be defined in the global namespace of
the browser after loading the main app page.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should exist'</span>, <span class="hljs-function"><span class="hljs-params">( done )</span> =&gt;</span>
        <span class="hljs-property">@page</span>.evaluate <span class="hljs-function"><span class="hljs-params">( -&gt; LurchEditor )</span>, <span class="hljs-params">( err, result )</span> -&gt;</span>
            expect( result ).toBeTruthy()
            done()
</code></pre><h2><a name='lurcheditor-instances-without-divs'></a>LurchEditor instances without DIVs &nbsp; <font size=-1><a href='test-results.md.html#lurcheditor-instances-without-divs'>see results</a></font> <font size=-1><a href='#lurcheditor-instances-without-divs'><img src="link.png" class="anchor"></a></font></h2><pre class="hljs"><code>phantomDescribe <span class="hljs-string">'LurchEditor instances without DIVs'</span>,
<span class="hljs-string">'./app/index.html'</span>,<span class="hljs-function"> -&gt;</span>
</code></pre><h3><a name='should-initialize-freeids'></a>should initialize freeIds &nbsp; <font size=-1><a href='test-results.md.html#should-initialize-freeids'>see results</a></font> <font size=-1><a href='#should-initialize-freeids'><img src="link.png" class="anchor"></a></font></h3><p>A newly created <code>LurchEditor</code> instance should have a <code>freeIds</code>
array containing only zero.</p>
<pre class="hljs"><code>    it <span class="hljs-string">'should initialize freeIds'</span>, <span class="hljs-function"><span class="hljs-params">( done )</span> =&gt;</span>
        <span class="hljs-property">@page</span>.evaluate<span class="hljs-function"> -&gt;</span>
            L = <span class="hljs-keyword">new</span> LurchEditor()
            L.freeIds
        , <span class="hljs-function"><span class="hljs-params">( err, result )</span> -&gt;</span>
            expect( result ).toEqual [ <span class="hljs-number">0</span> ]
            done()
</code></pre><p>Calling <code>nextFreeId()</code> on a newly created instance should keep
yielding nonnegative integers starting with zero and counting
upwards.  The resulting <code>freeIds</code> array should have in it just
the next integer.</p>
<h3><a name='nextfreeid-should-count-0-1-2-'></a>nextFreeId() should count 0,1,2,... &nbsp; <font size=-1><a href='test-results.md.html#nextfreeid-should-count-0-1-2-'>see results</a></font> <font size=-1><a href='#nextfreeid-should-count-0-1-2-'><img src="link.png" class="anchor"></a></font></h3><pre class="hljs"><code>    <span class="hljs-keyword">it</span> <span class="hljs-string">'nextFreeId() should count 0,1,2,...'</span>, ( done ) =&gt;
        @page.evaluate -&gt;
            L = <span class="hljs-built_in">new</span> LurchEditor()
            <span class="hljs-built_in">result</span> = []
            <span class="hljs-built_in">result</span>.push L.nextFreeId()
            <span class="hljs-built_in">result</span>.push L.nextFreeId()
            <span class="hljs-built_in">result</span>.push L.nextFreeId()
            <span class="hljs-built_in">result</span>.push L.nextFreeId()
            <span class="hljs-built_in">result</span>.push L.freeIds
            <span class="hljs-built_in">result</span>
        , ( err, <span class="hljs-built_in">result</span> ) -&gt;
            expect( <span class="hljs-built_in">result</span> ).toEqual [ <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, [ <span class="hljs-number">4</span> ] ]
            done()
</code></pre><h3><a name='addfreeid-re-inserts-in-order'></a>addFreeId() re-inserts in order &nbsp; <font size=-1><a href='test-results.md.html#addfreeid-re-inserts-in-order'>see results</a></font> <font size=-1><a href='#addfreeid-re-inserts-in-order'><img src="link.png" class="anchor"></a></font></h3><p>After a newly created instance has undergone the same sequence of
<code>nextFreeId()</code> calls as above, then restoring the id 2 should put
it back on the <code>freeIds</code> list in the correct spot, but restoring
any id 4 or higher should do nothing.  Then calls to <code>nextFreeId</code>
should yield 2, 4, 5, 6, ...</p>
<pre class="hljs"><code>    <span class="hljs-keyword">it</span> <span class="hljs-string">'addfreeId() re-inserts in order'</span>, ( done ) =&gt;
        @page.evaluate -&gt;
            L = <span class="hljs-built_in">new</span> LurchEditor()
            <span class="hljs-built_in">result</span> = []
            L.nextFreeId() <span class="hljs-comment"># four calls to nextFreeId()</span>
            L.nextFreeId()
            L.nextFreeId()
            L.nextFreeId()
            <span class="hljs-built_in">result</span>.push L.freeIds[..] <span class="hljs-comment"># save current array</span>
            L.addFreeId <span class="hljs-number">2</span> <span class="hljs-comment"># one call to addFreeId()</span>
            <span class="hljs-built_in">result</span>.push L.freeIds[..] <span class="hljs-comment"># save current array</span>
            <span class="hljs-built_in">result</span>.push L.nextFreeId() <span class="hljs-comment"># four more</span>
            <span class="hljs-built_in">result</span>.push L.nextFreeId()
            <span class="hljs-built_in">result</span>.push L.nextFreeId()
            <span class="hljs-built_in">result</span>.push L.nextFreeId()
            <span class="hljs-built_in">result</span>
        , ( err, <span class="hljs-built_in">result</span> ) -&gt;
            expect( <span class="hljs-built_in">result</span> ).toEqual [
                [ <span class="hljs-number">4</span> ] <span class="hljs-comment"># first saved freeIds array</span>
                [ <span class="hljs-number">2</span>, <span class="hljs-number">4</span> ] <span class="hljs-comment"># second saved freeIds array</span>
                <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span> <span class="hljs-comment"># last four generated ids</span>
            ]
            done()
</code></pre><h2><a name='lurcheditor-instances-with-divs'></a>LurchEditor instances with DIVs &nbsp; <font size=-1><a href='test-results.md.html#lurcheditor-instances-with-divs'>see results</a></font> <font size=-1><a href='#lurcheditor-instances-with-divs'><img src="link.png" class="anchor"></a></font></h2><p>We now test constructing a new <code>LurchEditor</code> instance around an
existing DOM element, and verify that it does the correct things
with ids.  See the documentation in
<a href="lurcheditor.litcoffee.html">the Lurch Editor class itself</a> for
details on what the constructor is expected to do in these
situations, or read each test description below.</p>
<pre class="hljs"><code>phantomDescribe <span class="hljs-string">'LurchEditor instances with DIVs'</span>,
<span class="hljs-string">'./app/index.html'</span>,<span class="hljs-function"> -&gt;</span>
</code></pre><h3><a name='should-give-an-empty-div-id-0'></a>should give an empty DIV id 0 &nbsp; <font size=-1><a href='test-results.md.html#should-give-an-empty-div-id-0'>see results</a></font> <font size=-1><a href='#should-give-an-empty-div-id-0'><img src="link.png" class="anchor"></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should give an empty DIV id 0'</span>, <span class="hljs-function"><span class="hljs-params">( done )</span> =&gt;</span>
</code></pre><p>When constructed in an empty DIV, it should give that DIV the id 0,
and thus have a free ids list of <code>[ 1 ]</code> aftewards.</p>
<pre class="hljs"><code>        <span class="hljs-property">@page</span>.evaluate<span class="hljs-function"> -&gt;</span>
            div = <span class="hljs-built_in">document</span>.createElement <span class="hljs-string">'div'</span>
            <span class="hljs-built_in">document</span>.body.appendChild div
            L = <span class="hljs-keyword">new</span> LurchEditor div
            [ parseInt( div.id ), L.freeIds ]
        , <span class="hljs-function"><span class="hljs-params">( err, result )</span> -&gt;</span>
            expect( result ).toEqual [ <span class="hljs-number">0</span>, [ <span class="hljs-number">1</span> ] ]
            done()
</code></pre><h3><a name='should-remove-all-invalid-ids'></a>should remove all invalid ids &nbsp; <font size=-1><a href='test-results.md.html#should-remove-all-invalid-ids'>see results</a></font> <font size=-1><a href='#should-remove-all-invalid-ids'><img src="link.png" class="anchor"></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should remove all invalid ids'</span>, <span class="hljs-function"><span class="hljs-params">( done )</span> =&gt;</span>
</code></pre><p>When constructed in a DIV containing a hierarchy of nested spans,
some of which have ids, all of which are invalid, it should remove
all of their old ids, and assign them each a new, unique,
nonnegative integer id.  In this test, we verify only that it
removed all of their old ids.</p>
<pre class="hljs"><code>        @page.evaluate -&gt;
            div = document.createElement 'div'
            document.body.appendChild div
            div.innerHTML =
                '''
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"yo"</span>&gt;</span>some span
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"inner"</span>&gt;</span>inner span<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">b</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"-1"</span>&gt;</span>neg number<span class="hljs-tag">&lt;/<span class="hljs-title">b</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"foo"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"-0"</span>&gt;</span>weird<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"1.0"</span>&gt;</span>int-ish float<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"hank"</span>&gt;</span>way inside<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">i</span>&gt;</span>italic<span class="hljs-tag">&lt;/<span class="hljs-title">i</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                '''
            oldids = 'yo inner -1 -0 1.0 hank'.split ' '
</code></pre><p>For each id we expect to be in the document (because it&#39;s mentioned
in the HTML code given above), record whether it was actually
present in the document.  (We record &quot;is null&quot; for each, and expect
all false results.)</p>
<pre class="hljs"><code>            <span class="hljs-built_in">result</span> = <span class="hljs-keyword">before</span>: { }, <span class="hljs-keyword">after</span>: { }
            <span class="hljs-keyword">for</span> key <span class="hljs-operator">in</span> oldids
                <span class="hljs-built_in">result</span>.<span class="hljs-keyword">before</span>[key] =
                    document.getElementById( key ) is <span class="hljs-constant">null</span>
</code></pre><p>Install the Lurch Editor in the DIV in question.</p>
<pre class="hljs"><code>            L = <span class="hljs-built_in">new</span> LurchEditor <span class="hljs-operator">div</span>
</code></pre><p>For each id that used to be in the document, record whether it is
still present in the document.  (We expect it to <em>not</em> be; we
record &quot;is null&quot; for each, and expect all true results.)</p>
<pre class="hljs"><code>            <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> oldids
                result.after[key] =
                    <span class="hljs-built_in">document</span>.getElementById( key ) <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
            result
        , <span class="hljs-function"><span class="hljs-params">( err, result )</span> -&gt;</span>
</code></pre><p>Verify that all the &quot;before&quot;s were not null.</p>
<pre class="hljs"><code>            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">before</span>[<span class="hljs-string">'yo'</span>] ).toBeFalsy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">before</span>[<span class="hljs-string">'inner'</span>] ).toBeFalsy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">before</span>[<span class="hljs-string">'-1'</span>] ).toBeFalsy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">before</span>[<span class="hljs-string">'-0'</span>] ).toBeFalsy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">before</span>[<span class="hljs-string">'1.0'</span>] ).toBeFalsy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">before</span>[<span class="hljs-string">'hank'</span>] ).toBeFalsy()
</code></pre><p>Verify that all the &quot;after&quot;s were null.</p>
<pre class="hljs"><code>            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">after</span>[<span class="hljs-string">'yo'</span>] ).toBeTruthy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">after</span>[<span class="hljs-string">'inner'</span>] ).toBeTruthy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">after</span>[<span class="hljs-string">'-1'</span>] ).toBeTruthy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">after</span>[<span class="hljs-string">'-0'</span>] ).toBeTruthy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">after</span>[<span class="hljs-string">'1.0'</span>] ).toBeTruthy()
            expect( <span class="hljs-built_in">result</span>.<span class="hljs-keyword">after</span>[<span class="hljs-string">'hank'</span>] ).toBeTruthy()
            done()
</code></pre><h3><a name='should-assign-unique-integer-ids'></a>should assign unique integer ids &nbsp; <font size=-1><a href='test-results.md.html#should-assign-unique-integer-ids'>see results</a></font> <font size=-1><a href='#should-assign-unique-integer-ids'><img src="link.png" class="anchor"></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should assign unique integer ids'</span>, <span class="hljs-function"><span class="hljs-params">( done )</span> =&gt;</span>
</code></pre><p>If we re-run the same test as the previous (creating a
<code>LurchEditor</code> class around the same DIV) we should find that it
has also assigned unique non-negative integer ids to each element
in the DOM tree beneath that DIV, starting with 0 and proceeding
upwards sequentially.</p>
<pre class="hljs"><code>        @page.evaluate -&gt;
            div = document.createElement 'div'
            document.body.appendChild div
            div.innerHTML =
                '''
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"yo"</span>&gt;</span>some span
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"inner"</span>&gt;</span>inner span<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">b</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"-1"</span>&gt;</span>neg number<span class="hljs-tag">&lt;/<span class="hljs-title">b</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"foo"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"-0"</span>&gt;</span>weird<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"1.0"</span>&gt;</span>int-ish float<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"hank"</span>&gt;</span>way inside<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">i</span>&gt;</span>italic<span class="hljs-tag">&lt;/<span class="hljs-title">i</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                '''
</code></pre><p>Construct the <code>LurchEditor</code> instance around the div, as before.</p>
<pre class="hljs"><code>            LE = <span class="hljs-built_in">new</span> LurchEditor <span class="hljs-operator">div</span>
</code></pre><p>Now find all ids of all nodes under that div.</p>
<pre class="hljs"><code>            allNodesUnder = ( node ) -&gt;
                <span class="hljs-constant">result</span> = [ node ]
                <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> node.childNodes
                    <span class="hljs-constant">result</span> = <span class="hljs-constant">result</span>.concat allNodesUnder child
                <span class="hljs-constant">result</span>
            {
                ids: ( parseInt node.<span class="hljs-property">id</span> <span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> \
                        allNodesUnder <span class="hljs-keyword">div</span> when node.<span class="hljs-property">id</span> )
                freeIds: LE.freeIds[..]
            }
        , ( err, <span class="hljs-constant">result</span> ) -&gt;
</code></pre><p>Sort the ids and verify that the list is <code>[ 0, 1, ..., 10 ]</code>.
(There are nine tags in the HTML code above, plus the DIV
containing them.)</p>
<pre class="hljs"><code>            result<span class="hljs-preprocessor">.ids</span><span class="hljs-preprocessor">.sort</span> ( a, b ) -&gt; a - b
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">0</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">0</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">1</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">1</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">2</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">2</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">3</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">3</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">4</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">4</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">5</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">5</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">6</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">6</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">7</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">7</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">8</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">8</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">9</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">9</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">10</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">10</span>
            expect( result<span class="hljs-preprocessor">.ids</span><span class="hljs-preprocessor">.length</span> )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">11</span>
</code></pre><p>Verify that the list of free ids is &quot;everything 11 and above.&quot;</p>
<pre class="hljs"><code>            <span class="hljs-function">expect( result.freeIds )</span><span class="hljs-class">.toEqual</span> <span class="hljs-attr_selector">[ 11 ]</span>
            <span class="hljs-function">done()</span>
</code></pre><h3><a name='should-work-with-existing-integer-ids'></a>should work with existing integer ids &nbsp; <font size=-1><a href='test-results.md.html#should-work-with-existing-integer-ids'>see results</a></font> <font size=-1><a href='#should-work-with-existing-integer-ids'><img src="link.png" class="anchor"></a></font></h3><p>If we run a similar test to the previous two, but with the DIV
slightly altered to include a few valid integer ids, we should
find that it has also assigned unique non-negative integer ids to
each element in the DOM tree beneath that DIV, starting with 0 and
proceeding upwards sequentially, but keeping the existing valid
integer ids unchanged.</p>
<pre class="hljs"><code>    it 'should work with existing integer ids', ( done ) =&gt;
        @page.evaluate -&gt;
            div = document.createElement 'div'
            document.body.appendChild div
            div.innerHTML =
                '''
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"yo"</span>&gt;</span>some span
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"inner"</span>&gt;</span>inner span<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">b</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"1"</span>&gt;</span>pos number<span class="hljs-tag">&lt;/<span class="hljs-title">b</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">br</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"foo"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"-0"</span>&gt;</span>weird<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"20"</span>&gt;</span>big-ish number<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"hank"</span>&gt;</span>way inside<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">i</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">4</span>&gt;</span>italic<span class="hljs-tag">&lt;/<span class="hljs-title">i</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>
                '''
</code></pre><p>Construct the <code>LurchEditor</code> instance around the div, as before.</p>
<pre class="hljs"><code>            LE = <span class="hljs-built_in">new</span> LurchEditor <span class="hljs-operator">div</span>
</code></pre><p>Now find all ids of all nodes under that div.</p>
<pre class="hljs"><code>            allNodesUnder = ( node ) -&gt;
                <span class="hljs-built_in">result</span> = [ node ]
                <span class="hljs-keyword">for</span> child <span class="hljs-operator">in</span> node.childNodes
                    <span class="hljs-built_in">result</span> = <span class="hljs-built_in">result</span>.concat allNodesUnder child
                <span class="hljs-built_in">result</span>
            <span class="hljs-built_in">result</span> =
                ids: ( parseInt node.id <span class="hljs-keyword">for</span> node <span class="hljs-operator">in</span> \
                        allNodesUnder <span class="hljs-operator">div</span> when node.id )
                freeIds: LE.freeIds[..]
                texts: { }
            <span class="hljs-keyword">for</span> i <span class="hljs-operator">in</span> [<span class="hljs-number">0.</span><span class="hljs-number">.9</span>].concat [ <span class="hljs-number">20</span> ]
                <span class="hljs-built_in">result</span>.texts[i] =
                    document.getElementById( <span class="hljs-string">"#{i}"</span> ) \
                        .textContent.<span class="hljs-built_in">replace</span> /^\s+|\s+$/g, <span class="hljs-string">''</span>
            <span class="hljs-built_in">result</span>
        , ( err, <span class="hljs-built_in">result</span> ) -&gt;
</code></pre><p>Sort the ids and verify that the list is <code>[ 0, 1, ..., 9, 20 ]</code>.
(There are nine tags in the HTML code above, plus the DIV
containing them.)</p>
<pre class="hljs"><code>            result<span class="hljs-preprocessor">.ids</span><span class="hljs-preprocessor">.sort</span> ( a, b ) -&gt; a - b
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">0</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">0</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">1</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">1</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">2</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">2</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">3</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">3</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">4</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">4</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">5</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">5</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">6</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">6</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">7</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">7</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">8</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">8</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">9</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">9</span>
            expect( result<span class="hljs-preprocessor">.ids</span>[<span class="hljs-number">10</span>] )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">20</span>
            expect( result<span class="hljs-preprocessor">.ids</span><span class="hljs-preprocessor">.length</span> )<span class="hljs-preprocessor">.toEqual</span> <span class="hljs-number">11</span>
</code></pre><p>Verify that the list of free ids is &quot;everything 10 and above,
except 20.&quot;</p>
<pre class="hljs"><code>            expect( result<span class="hljs-preprocessor">.freeIds</span> )<span class="hljs-preprocessor">.toEqual</span> \
                [ <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">21</span> ]
</code></pre><p>Verify that the ids for the nodes that already had valid integer
ids were left unchanged.</p>
<pre class="hljs"><code>            expect( <span class="hljs-built_in">result</span>.texts[<span class="hljs-number">4</span>] ).toEqual <span class="hljs-string">'italic'</span>
            expect( <span class="hljs-built_in">result</span>.texts[<span class="hljs-number">1</span>] ).toEqual <span class="hljs-string">'pos number'</span>
            expect( <span class="hljs-built_in">result</span>.texts[<span class="hljs-number">20</span>] ).toEqual <span class="hljs-string">'big-ish number'</span>
            done()
</code></pre><h3><a name='should-have-working-address-and-index'></a>should have working address and index &nbsp; <font size=-1><a href='test-results.md.html#should-have-working-address-and-index'>see results</a></font> <font size=-1><a href='#should-have-working-address-and-index'><img src="link.png" class="anchor"></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should have working address and index'</span>, <span class="hljs-function"><span class="hljs-params">( done )</span> =&gt;</span>
</code></pre><p>The <code>LurchEditor</code> class defines shortuct address and index
functions that just make the calls relative to their main HTML
elements.  We verify here briefly that those functions work, but
do not test them extensively, since that is already done in
<a href="domutils-spec.litcoffee.html">the unit test for DOM utilities</a>.</p>
<pre class="hljs"><code>        @page.evaluate -&gt;
            <span class="hljs-operator">div</span> = document.createElement <span class="hljs-string">'div'</span>
            <span class="hljs-operator">div</span>.id = <span class="hljs-string">'0'</span>
            document.body.appendChild <span class="hljs-operator">div</span>
            span1 = document.createElement <span class="hljs-string">'span'</span>
            span1.id = <span class="hljs-string">'1'</span>
            <span class="hljs-operator">div</span>.appendChild span1
            span2 = document.createElement <span class="hljs-string">'span'</span>
            span2.id = <span class="hljs-string">'2'</span>
            <span class="hljs-operator">div</span>.appendChild span2
            LE = <span class="hljs-built_in">new</span> LurchEditor <span class="hljs-operator">div</span>
</code></pre><p>Four address queries followed by four index queries, the last of
which we expect to be undefined.</p>
<pre class="hljs"><code>            [
                LE.address <span class="hljs-keyword">div</span>
                LE.address span1
                LE.address span2
                null <span class="hljs-keyword">is</span> LE.address document
                LE.<span class="hljs-keyword">index</span>( [] ).id
                LE.<span class="hljs-keyword">index</span>( [ <span class="hljs-number">0</span> ] ).id
                LE.<span class="hljs-keyword">index</span>( [ <span class="hljs-number">1</span> ] ).id
                typeof LE.<span class="hljs-keyword">index</span> [ <span class="hljs-number">0</span>, <span class="hljs-number">0</span> ]
            ]
        , ( err, <span class="hljs-keyword">result</span> ) -&gt;
            expect( <span class="hljs-keyword">result</span>[<span class="hljs-number">0</span>] ).toEqual []
            expect( <span class="hljs-keyword">result</span>[<span class="hljs-number">1</span>] ).toEqual [ <span class="hljs-number">0</span> ]
            expect( <span class="hljs-keyword">result</span>[<span class="hljs-number">2</span>] ).toEqual [ <span class="hljs-number">1</span> ]
            expect( <span class="hljs-keyword">result</span>[<span class="hljs-number">3</span>] ).toBeTruthy()
            expect( <span class="hljs-keyword">result</span>[<span class="hljs-number">4</span>] ).toEqual <span class="hljs-string">'0'</span>
            expect( <span class="hljs-keyword">result</span>[<span class="hljs-number">5</span>] ).toEqual <span class="hljs-string">'1'</span>
            expect( <span class="hljs-keyword">result</span>[<span class="hljs-number">6</span>] ).toEqual <span class="hljs-string">'2'</span>
            expect( <span class="hljs-keyword">result</span>[<span class="hljs-number">7</span>] ).toEqual <span class="hljs-string">'undefined'</span>
            done()
</code></pre><h3><a name='should-give-no-address-and-index-if-empty'></a>should give no address and index if empty &nbsp; <font size=-1><a href='test-results.md.html#should-give-no-address-and-index-if-empty'>see results</a></font> <font size=-1><a href='#should-give-no-address-and-index-if-empty'><img src="link.png" class="anchor"></a></font></h3><pre class="hljs"><code>    it <span class="hljs-string">'should give no address and index if empty'</span>, <span class="hljs-function"><span class="hljs-params">( done )</span> =&gt;</span>
</code></pre><p>The shortuct address and index functions in the <code>LurchEditor</code> class
should function correctly (returning null) if the main HTML element
of the instance is empty.</p>
<pre class="hljs"><code>        @page.evaluate -&gt;
            <span class="hljs-operator">div</span> = document.createElement <span class="hljs-string">'div'</span>
            document.body.appendChild <span class="hljs-operator">div</span>
            LE = <span class="hljs-built_in">new</span> LurchEditor()
            console.<span class="hljs-built_in">log</span> LE.address <span class="hljs-operator">div</span>
            console.<span class="hljs-built_in">log</span> LE.index <span class="hljs-operator">div</span>
            [
                <span class="hljs-constant">null</span> is LE.address <span class="hljs-operator">div</span>
                <span class="hljs-constant">null</span> is LE.index <span class="hljs-operator">div</span>
            ]
        , ( err, <span class="hljs-built_in">result</span> ) -&gt;
            expect( <span class="hljs-built_in">result</span>[<span class="hljs-number">0</span>] ).toBeTruthy()
            expect( <span class="hljs-built_in">result</span>[<span class="hljs-number">1</span>] ).toBeTruthy()
            done()
</code></pre>
        </div>
        <div id="right">
            <h3 align=center>Navigation</h3><br><h3><a href='index.md.html'>Main Page</a></h3><p>.</p><ul><li><a href='buildutils.litcoffee.html'>buildutils.litcoffee</a></li><li><a href='cake.litcoffee.html'>cake.litcoffee</a></li></ul><p>./app</p><ul><li><a href='../app/index.html'>index.html</a></li></ul><p>./doc</p><ul><li><a href='plan.md.html'>plan.md</a></li><li><a href='test-results.md.html'>test-results.md</a></li></ul><p>./src</p><ul><li><a href='domedittracker.litcoffee.html'>domedittracker.litcoffee</a></li><li><a href='domutils.litcoffee.html'>domutils.litcoffee</a></li><li><a href='lurcheditor.litcoffee.html'>lurcheditor.litcoffee</a></li></ul><p>./test</p><ul><li><a href='basic-spec.litcoffee.html'>basic-spec.litcoffee</a></li><li><a href='domedittracker-spec.litcoffee.html'>domedittracker-spec.litcoffee</a></li><li><a href='domutils-spec.litcoffee.html'>domutils-spec.litcoffee</a></li><li><a href='lurcheditor-spec.litcoffee.html'>lurcheditor-spec.litcoffee</a></li><li><a href='phantom-utils.litcoffee.html'>phantom-utils.litcoffee</a></li></ul><p>./testapp</p><ul><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li><li><a href='../testapp/index.html'>index.html</a></li></ul>
        </div>
    </body>
</html>

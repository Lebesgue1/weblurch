<html>
    <head>
        <link rel="stylesheet"
              href="../bootstrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="./main.css"/>
        <link rel="stylesheet" href="./obsidian.css"/>
        <link rel="shortcut icon" href="favicon.png"/>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config( {
              tex2jax: { inlineMath: [ [ '$', '$' ], [ '\\(', '\\)' ] ] }
            } );
        </script>
        <script type="text/javascript"
                src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <title>webLurch docs: all-histories-spec</title>
    </head>
    <body>
        <div id="left">
            <p align=center>Page contents</p>
<p><a href='#all-test-histories'>All test histories</a></p>
        </div>
        <div id="middle">
            <h1><a name='all-test-histories'></a>All test histories &nbsp;  <font size=-1><a href='#all-test-histories'><span class="glyphicon glyphicon-link"></span></a></font></h1><p>Test histories are recorded by users of the test app into JSON
files that contains a sequence of JavaScript commands to execute,
and waypoints at which to compare the state of the document against
known-correct (and even known-incorrect) states.</p>
<p>This test suite traverses a folder hierarchy of many such tests,
running them all.  <em>If you&#39;ve followed a link here hoping to see
the actual test histories, they are not here, but are stored in
JSON files in the repository.  The easiest way to browse them is
through <a href="../testapp/index.html">the test app</a>; click the History
tab and choose a saved test history from the drop-down list.</em></p>
<p>First, we load the necessary tools.</p>
<pre class="hljs"><code>{ runTestHistory } = <span class="hljs-built_in">require</span> <span class="hljs-string">'./phantom-utils'</span>
fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
</code></pre><p>We initialize a module-level variable to store all test histories
in one big data structure.  We populate this as we walk the folder
hierarchy, below.  We also provide a filename into which this
structure will be saved, once it&#39;s fully populated.</p>
<pre class="hljs"><code>historyHierarchy = { }
historyOutFile = <span class="hljs-string">'./testapp/all-test-histories.js'</span>
</code></pre><p>Next, we define a function that will find all <code>.json</code> files in a
given directory hierarchy, and treat each as a test history to be
run.  It runs such histories in breadth-first-search order.</p>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-title">walk</span> = <span class="hljs-params">( dir )</span> -&gt;</span>
</code></pre><p>Classify the things we find in <code>dir</code> as <code>.json</code> files, directories,
or neither (which we ignore).</p>
<pre class="hljs"><code>    files = []
    dirs = []
    <span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> fs.readdirSync dir
        entry = path.join dir, entry
        <span class="hljs-keyword">if</span> ( fs.statSync entry )?.isDirectory()
            dirs.push entry
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> entry[-<span class="hljs-number">5.</span>.].toLowerCase() <span class="hljs-keyword">is</span> <span class="hljs-string">'.json'</span>
            files.push entry
</code></pre><p>In order to keep the search breadth-first, we process the files
in <em>this</em> folder first, then recur on any subfolders we found.
As we process the files, we store them in the global data structure
if and only if they were an array, which means the test attempted.</p>
<pre class="hljs"><code>    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files
        testHistory = runTestHistory file
        <span class="hljs-keyword">if</span> testHistory <span class="hljs-keyword">instanceof</span> Array
            historyHierarchy[file] = testHistory
    walk dir <span class="hljs-keyword">for</span> dir <span class="hljs-keyword">in</span> dirs
</code></pre><p>Now we apply that function to the hierarchy of test histories
stored in this repository.</p>
<pre class="hljs"><code>walk <span class="hljs-string">'test/histories'</span>
</code></pre><p>Save the global data structure of all test histories in a file in
the test app folder.  The output format is JavaScript, initializing
a global variable to contain the JSON data.</p>
<pre class="hljs"><code>stringForm = JSON.stringify historyHierarchy
fs.writeFileSync historyOutFile,
    <span class="hljs-string">"window.allTestHistories = <span class="hljs-subst">#{stringForm}</span>;"</span>
</code></pre>
        </div>
        <div id="right">
            <h3 align=center>Navigation</h3><br><h3><a href='index.md.html'>webLurch home</a></h3><p>.</p><ul><li><a href='buildutils.litcoffee.html'>buildutils.litcoffee</a></li><li><a href='cake.litcoffee.html'>cake.litcoffee</a></li></ul><p>./app</p><ul><li><a href='../app/index.html'>index.html</a></li></ul><p>./doc</p><ul><li><a href='plan.md.html'>plan.md</a></li><li><a href='progress.md.html'>progress.md</a></li><li><a href='test-app-help.md.html'>test-app-help.md</a></li><li><a href='test-results.md.html'>test-results.md</a></li></ul><p>./src</p><ul><li><a href='domeditaction.litcoffee.html'>domeditaction.litcoffee</a></li><li><a href='domedittracker.litcoffee.html'>domedittracker.litcoffee</a></li><li><a href='domutils.litcoffee.html'>domutils.litcoffee</a></li><li><a href='lurcheditor.litcoffee.html'>lurcheditor.litcoffee</a></li></ul><p>./test</p><ul><li><a href='all-histories-spec.litcoffee.html'>all-histories-spec.litcoffee</a></li><li><a href='basic-spec.litcoffee.html'>basic-spec.litcoffee</a></li><li><a href='domeditaction-spec.litcoffee.html'>domeditaction-spec.litcoffee</a></li><li><a href='domedittracker-spec.litcoffee.html'>domedittracker-spec.litcoffee</a></li><li><a href='domutils-spec.litcoffee.html'>domutils-spec.litcoffee</a></li><li><a href='lurcheditor-spec.litcoffee.html'>lurcheditor-spec.litcoffee</a></li><li><a href='phantom-utils.litcoffee.html'>phantom-utils.litcoffee</a></li><li><a href='undoredo-spec.litcoffee.html'>undoredo-spec.litcoffee</a></li></ul><p>./testapp</p><ul><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li><li><a href='../testapp/index.html'>index.html</a></li></ul>
        </div>
    </body>
</html>

<html>
    <head>
        <link rel="stylesheet"
              href="../bootstrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" href="./main.css"/>
        <link rel="stylesheet" href="./obsidian.css"/>
        <link rel="shortcut icon" href="favicon.png"/>
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config( {
              tex2jax: { inlineMath: [ [ '$', '$' ], [ '\\(', '\\)' ] ] }
            } );
        </script>
        <script type="text/javascript"
                src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <title>webLurch docs: wp-spec</title>
    </head>
    <body>
        <div id="left">
            <p align=center>Page contents</p>
<p><a href='#word-processing-specification'>Word Processing Specification</a></p><ul>
<li><a href='#purpose-what-is-this-document-'>Purpose: What is this document?</a></li><li><a href='#inspiration-not-re-inventing-the-wheel'>Inspiration: Not re-inventing the wheel</a></li><li><a href='#specification-how-our-documents-will-be-structured'>Specification: How our documents will be structured</a></li><li><a href='#extensions-smart-characters'>Extensions: Smart characters</a></li><li><a href='#restrictions-general-principles'>Restrictions: General principles</a></li><li><a href='#cursor-where-can-it-be-positioned-'>Cursor: Where can it be positioned?</a></li><li><a href='#movement-how-will-the-cursor-move-'>Movement: How will the cursor move?</a></li><li><a href='#editing-how-we-keep-the-structural-rules'>Editing: How we keep the structural rules</a></li><li><a href='#junk-keeping-the-document-clean'>Junk: Keeping the document clean</a></li>
        </div>
        <div id="middle">
            <h1><a name='word-processing-specification'></a>Word Processing Specification &nbsp;  <font size=-1><a href='#word-processing-specification'><span class="glyphicon glyphicon-link"></span></a></font></h1><h2><a name='purpose-what-is-this-document-'></a>Purpose: What is this document? &nbsp;  <font size=-1><a href='#purpose-what-is-this-document-'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>This document explains the overall plan for building a word
processor inside a webpage.</p>
<p>I confess that I have already begun doing this, and so it is a
little bit late to begin writing this document! But, in my
defense, I will say two things. I did actually have a plan when I
began, but as the project unfolded, it became clear that my plan
needed improving; this document is the improved version of the
plan. Secondly, I am of the opinion that one cannot perfectly
plan a large project entirely beforehand; at some point you have
to just get your hands dirty and find out the nitty-gritty
details by so doing, thereby enabling you to return to the
planning stage, more informed. </p>
<p>The specific way in which I am now more informed to write this
document is as follows. I had originally assumed that the
application would designate some specific portion of the webpage
to be used for word processing, and the document consisted of
precisely those HTML elements that appeared inside that area. A
simple plan. But HTML documents support a truly enormous range of
features, while word processors, in general, do not. There are
many aspects of a webpage that you would not want to show up
inside your document, including forms, videos, drop-down menus,
and similar items. Having such items inside an editable region of
the webpage would tend to confuse the user, because they do not
fit the user&#39;s expectations for word processing. </p>
<p>My realization of these facts came from trying to design a
consistent way to place and move the cursor. But that specific
problem was just a narrow symptom of a larger disease. This new
and improved plan aims to be a cure for that disease. </p>
<h2><a name='inspiration-not-re-inventing-the-wheel'></a>Inspiration: Not re-inventing the wheel &nbsp;  <font size=-1><a href='#inspiration-not-re-inventing-the-wheel'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>The good news is that I do not need to create my own plan for
structuring the implementation of a word processor in a webpage.
For the past several years, I have been part of the development
of the desktop version of <em>Lurch,</em> and therefore have seen
firsthand the internal workings of a word processor, specifically
<a href="http://qt-project.org/doc/qt-5/qtextdocument.html">QTextDocument</a>
from <a href="http://qt-project.org/">the Qt project</a>.  And it&#39;s not just
any word processor, but it was one created by a team of talented
open-source software developers, and tested in many open source
projects, including <em>Lurch</em>. Thus we know that its design meets
all of our needs, because we are using it in the desktop version
of <em>Lurch</em> already. </p>
<h2><a name='specification-how-our-documents-will-be-structured'></a>Specification: How our documents will be structured &nbsp;  <font size=-1><a href='#specification-how-our-documents-will-be-structured'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>Here I repeat the general structure of a QTextDocument, and make
particular comments about how this connects to HTML documents,
thereby suggesting the new implementation of this design in a
webpage.  The reader should see the following bulleted list as a
<em>restriction;</em> I hereby declare that the <em>Lurch</em> word processor,
when built in a web page, will permit only documents that adhere
to the following structure.</p>
<ul>
<li><em>Text</em> - the smallest unit of a document<ul>
<li>Text is simply an ordinary string of Unicode characters.</li>
<li>In its simplest form, it is unformatted (an HTML Text
node), but it may have formats and styles attached as well
(an HTML SPAN element with one Text node child).</li>
<li>(We may need to add here the special case of the <code>&lt;BR&gt;</code> tag
as an individual character, or maybe not, because <code>&amp;#10;</code> is
line feed, and may work just as well.)</li>
<li>In Qt, this was a
<a href="http://qt-project.org/doc/qt-5/qtextfragment.html">QTextFragment</a>,
but in HTML it would either be text without a tag, or text inside
a SPAN to style it.</li>
<li>Examples:<ul>
<li>In <code>&lt;p&gt;Hello&lt;/p&gt;</code>, the paragraph has one child, a plain
text node.</li>
<li>In <code>&lt;span style=&quot;font-style: italic;&quot;&gt;one&lt;/span&gt; two</code>,
there are two text nodes, the first one inside a SPAN
that gives it style; the second one outside the SPAN.</li>
<li>I will add &quot;smart characters&quot; to the list of valid Text
objects, in the next section.</li>
</ul>
</li>
</ul>
</li>
<li><em>Block</em> - a paragraph-like object that serves to word-wrap a
sequence of Texts<ul>
<li>A Block is for containing a list of Text objects and
presenting them word-wrapped.</li>
<li>A paragraph (P element) is the simplest and most common
example of a Block, but a list item (LI in HTML) is also a
Block.  For now, we will assume that these are the only two
tags permitted as Blocks, but this specification can be
extended later.</li>
<li>Blocks cannot contain other blocks; they can only contain
Texts.</li>
<li>Blocks are named after the Qt object
<a href="http://qt-project.org/doc/qt-5/qtextblock.html">QTextBlock</a>.</li>
</ul>
</li>
<li><em>Frame</em> - a higher-level structure that contains and lays out
an array of Blocks<ul>
<li>A Frame is for containing a list of Blocks and/or Frames,
and it presents them in a way that depends on what type of
Frame it is; see examples below.</li>
<li>Frames can contain a mix of Blocks and Frames, but cannot
directly contain Texts.</li>
<li>For now, we will only permit DIV, OL, and UL elements as
Frames; see the examples below.</li>
<li>It is named after
<a href="http://qt-project.org/doc/qt-5/qtextframe.html">QTextFrame</a>,
and <em>not</em> after HTML frames.  Although there is some
potential name confusion there, HTML frames are so uncommon
in modern websites that I suspect the ambiguity is not a
big deal.  It also helps me stay consistent with my
borrowing of the Qt class names.</li>
<li>Examples:<ul>
<li>The entire word processing document, as a sequence of
paragraphs, will be a Frame.  It will lay out its
contents vertically, in order.</li>
<li>A list (either an OL or UL element) will be a Frame that
will contain only LI-type blocks, and will lay them out
vertically as well.</li>
<li>Desktop <em>Lurch</em> does not currently support tables, and the
first version of web <em>Lurch</em> probably will not either, for
simplicity, but if/when tables are added, they will be
constructed of nested Frames (the table body, rows, and
cells) that are nested in that order (body contains
rows, which contains cells) and which contain Blocks as
children of the cells only.  Their layout is complex to
describe, but familiar to anyone who has used an HTML
table.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Consider the following HTML as an example.</p>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>Dear Jim,<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>I'm writing to create...drum roll...<span class="hljs-tag">&lt;<span class="hljs-title">span</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"font-style: italic;"</span>&gt;</span>a new Lurch specification!!<span class="hljs-tag">&lt;/<span class="hljs-title">span</span>&gt;</span>  Here's why:<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">ol</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">li</span>&gt;</span>The current one has troubles.<span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">li</span>&gt;</span>There is a great source of inspiration available from our desktop app.<span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">li</span>&gt;</span>And so on.<span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
</code></pre><p>Its structure is as follows:</p>
<ul>
<li>The document itself, represented by the outermost DIV, is a
Frame.<ul>
<li>The first paragraph is a Block.<ul>
<li>It contains the Text node &quot;Dear Jim,&quot; and nothing else.</li>
</ul>
</li>
<li>The second paragraph is a Block.  It contains three Texts:<ul>
<li>&quot;I&#39;m writing to create...drum roll...&quot;</li>
<li>&quot;a new Lurch specification!!&quot; with the italic style
applied to it</li>
<li>&quot;  Here&#39;s why:&quot;</li>
</ul>
</li>
<li>The third piece of the document is not a Block, but another
Frame, the OL element.  It contains three children, each a
Block with one Text in it:<ul>
<li>Block containing &quot;The current one has troubles.&quot;</li>
<li>Block containing &quot;There is a great source of inspiration
available from our desktop app.&quot;</li>
<li>Block containing &quot;And so on.&quot;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2><a name='extensions-smart-characters'></a>Extensions: Smart characters &nbsp;  <font size=-1><a href='#extensions-smart-characters'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>In order for the web app to support all of the same content as
the desktop app, we must note one additional feature that is
required. The nickname that we gave to it in the desktop app was
&quot;smart characters,&quot; because each instance of this feature in the
document behaved as if it were a single character of text, but
had additional features. For instance, an image, no matter how
large, is a single, indivisible item, just like one character of
text (though usually much bigger). Another very important example
includes the opening and closing groupers around bubbles. The
most recent example of a smart character is a little piece of
typeset mathematics; they provide the special feature that when
the user clicks on them or moves their cursor into them, they
become editable. Supporting these smart characters in the web
version of the app requires adding them to the specification, as
follows.</p>
<p>We permit all of the following types of HTML content to appear in
our document, in addition to the types given above. Each of the
types below counts as an object in the Text category, and should
be treated as if it were exactly one character in length.</p>
<ul>
<li>an IMG tag</li>
<li>a SPAN element with the class &quot;lurch-char&quot;<ul>
<li>Example: <code>&lt;SPAN class=&quot;lurch-char&quot;&gt;&lt;IMG
src=&quot;open-ME-grouper.png&quot;/&gt;&lt;SPAN style=&quot;display:
none;&quot;&gt;[meaning data here]&lt;/SPAN&gt;&lt;/SPAN&gt;</code></li>
<li>The entire example would be treated as a single character,
so that the cursor can move over it in one step.</li>
<li>In this particular example, the open grouper would be seen,
but the internal SPAN is marked with a style that makes it
invisible. Of course, the software can still deal with its
contents, and read/write to them as needed for, e.g.,
validation.</li>
<li>Although this example stores meaning data in an invisible
internal SPAN element, another viable place to store such
data might be in <a href="http://www.w3schools.com/tags/att_global_data.asp">user-data
attributes</a>
on the outer SPAN element, e.g., <code>&lt;SPAN class=&quot;lurch-char&quot;
data-meaning=&quot;[data here]&quot;&gt;...&lt;/SPAN&gt;</code>.</li>
</ul>
</li>
</ul>
<p>Note that the examples immediately above are the <em>only</em> situation
in which nested SPAN tags will appear. Ordinary Text objects in a
Block will never nest SPAN elements. Only smart characters are
permitted to do so.</p>
<h2><a name='restrictions-general-principles'></a>Restrictions: General principles &nbsp;  <font size=-1><a href='#restrictions-general-principles'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>When we built the desktop app, we did not need to worry about
documents deviating from this structure. It was the only
structure possible, because the word processor we were using, a
<a href="http://qt-project.org/doc/qt-5/qtextedit.html">QTextEdit</a>,
provided only these types of document elements. There simply was
no other option. </p>
<p>On the web, however, there are two ways that content can get
placed inside of one of our word processing documents, as it sits
in a webpage. First, the content may be added by JavaScript code
from within our app. Second, it may be added by JavaScript code
written by someone else. (This latter case may include script code
in the webpage that contains the <em>Lurch</em> word processor, or script
code that someone simply executes from the browser&#39;s developer
console directly.) We handle these two cases separately.</p>
<p>To handle the first case, we just ensure that the software we
build preserves the restrictions above. If the initial state of
the document satisfies the above restrictions, and all editing
operations we give the user access to preserve these
restrictions, then the document will always satisfy these
restrictions. This will require careful development and testing
of our own code, but is manageable. I will discuss this more
below. Here I will just mention that a valid initial document is
simply the full-document Frame with one Block inside, as in
<code>&lt;div&gt;&lt;p&gt;&lt;/p&gt;&lt;/div&gt;</code>.</p>
<p>To handle the second case, we simply don&#39;t handle it. Even in the
current desktop version of the software, there are ways that the
user can mess the software up. The most obvious of these is to
enable the developer console, open it directly, and execute
arbitrary script code in any of their documents. However, we have
always said that a user who does that is taking their own risks,
and our software does not need to protect the user&#39;s document
against such behavior; it would be impossible anyway. This is a
similar case. If you use your browser&#39;s JavaScript console or some
other means to inject invalid data into your document, the
behavior of our app becomes undefined. Do not do that.</p>
<h2><a name='cursor-where-can-it-be-positioned-'></a>Cursor: Where can it be positioned? &nbsp;  <font size=-1><a href='#cursor-where-can-it-be-positioned-'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>Word processor users expect the following behavior for the cursor.</p>
<ul>
<li>The cursor can be placed before or after any character in the
document. This includes smart characters, which we treat as
single characters of text.</li>
<li>The cursor can only be placed within Blocks.  (Technically,
the cursor may be in a SPAN inside a Block, but this counts as
inside the Block, because if any type of insertion were needed
at that point that couldn&#39;t go inside the SPAN, it is trivial
to split the SPAN before doing the insertion.  For simplicity
from here on out, I will therefore treat the cursor as if it
is always immediately inside a Block.  This occurs, for
instance, in the &quot;Applying a text style&quot; case, in the
<a href="#editing-how-we-keep-the-structural-rules">Editing</a> section,
below.)</li>
<li>Every valid cursor position gives the user a distinct visual
appearance.<ul>
<li>Most of the time, this simply means that two different
cursor positions are at different locations on screen.</li>
<li>However, sometimes two distinct cursor locations are at the
same position (e.g., immediately inside/outside a bubble in
desktop <em>Lurch,</em> or immediately inside/outside an Equation
Editor instance in Microsoft <em>Word</em>). In those cases, the
visual distinction is created by the presence/absence of
the bubble on screen.</li>
</ul>
</li>
</ul>
<p>To support these user expectations, I now list all types of valid
cursor positions.</p>
<p>Every Block contains an easily-computable number of text
characters.</p>
<ul>
<li>Unformatted text contains a number of characters equal to its
length.</li>
<li>Formatted text is treated exactly the same way; the SPAN tags
that surround it are irrelevant for computing the number of
characters in it.</li>
<li>Smart characters, which count as text, count for one
character.</li>
</ul>
<p>The total number of characters in a Block is computed simply by summing the number of characters in all the Text objects inside the block.</p>
<p>The number of cursor positions in a Block is one more than its
number of characters, and they are the interstices between those
characters, including one position at the Block start and one at
the Block end. There are no cursor positions outside Blocks.</p>
<p>When a cursor falls on the boundary of a formatted Text object,
it leans leftward; that is, if the formatted text is to the right
of the cursor, the cursor will <em>not</em> be inside it, but if the
formatted text is to the left of the cursor, the cursor <em>will</em> be
inside it. As an example, consider the HTML code below.</p>
<pre class="hljs"><code><span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>A<span class="hljs-tag">&lt;<span class="hljs-title">SPAN</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"font-style: italic;"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-title">SPAN</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">SPAN</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"font-color: #aa0000;"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-title">SPAN</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">P</span>&gt;</span>
</code></pre><ul>
<li>If the cursor is to the left of A, it is not inside any SPAN
element.</li>
<li>If the cursor is to the left of B, it is not inside any SPAN
element. It is on the boundary of one, but &quot;leans&quot; leftward,
so remains outside.</li>
<li>If the cursor is to the left of C, it is inside the first
(italic) SPAN element. It is on the boundary of two SPANs, but
&quot;leans&quot; leftward, so sits in the first of the two.</li>
<li>If the cursor is to the right of C, it is inside the second
(red) SPAN element. It is on the boundary of that element, but
&quot;leans&quot; leftward, so remains inside.</li>
</ul>
<p>The total number of cursor positions in a document is the total
number of cursor positions in all of the document&#39;s Blocks. The
set of cursor positions in a document is the union of all the
sets of cursor positions in all of its Blocks.</p>
<h2><a name='movement-how-will-the-cursor-move-'></a>Movement: How will the cursor move? &nbsp;  <font size=-1><a href='#movement-how-will-the-cursor-move-'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>There is not yet a fully-detailed plan for cursor placement and
movement, but the following guidelines will later be solidified
into a fully specific plan.</p>
<ul>
<li>Cursor positions in a document are numbered $0$ through $n-1$,
where $n$ is the number of cursor positions in the document.</li>
<li>When a document is opened, the cursor should initially be
placed at cursor position 0.</li>
<li>In response to the user touching the left or right arrows, the
cursor position is incremented or decremented by one, using
the numbering system just mentioned. Such movements are
obviously capped to remain between $0$ and $n-1$, inclusive.</li>
<li>In response to the user clicking the mouse to position the
cursor, the software will seek the cursor position whose
visual position is nearest to the click point. If there is
more than one such visual position, which one is chosen is not
defined here.</li>
<li>In response to the user touching the up or down arrows, the
software will execute the same routine as it does when the
user clicks the mouse, but iteratively issuing virtual
&quot;clicks&quot; at points further up/down from the current cursor
position, until the cursor moves.</li>
<li>In response to the user touching the page-up or page-down
buttons, the software will perform a similar operation, but
jumping a larger distance before seeking the nearest cursor
position.</li>
</ul>
<p>Although this specification does not describe it, the cursor can
also leave its &quot;anchor&quot; in place while moving, thus highlighting
text to create a selection. The details of that exist in a
separate implementation plan, and thus are not discussed here.
(Essentially, two cursors exist, and all text strictly between
the two is highlighted by adding a &quot;lurch-selection&quot; class to its
elements.) This feature has actually already been implemented
before the need for this redesign became obvious, so the methods
for doing so are not only well-known, but exist in current code.</p>
<h2><a name='editing-how-we-keep-the-structural-rules'></a>Editing: How we keep the structural rules &nbsp;  <font size=-1><a href='#editing-how-we-keep-the-structural-rules'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>We must now briefly describe the types of editing operations that
will be permitted in our word processor, and give some evidence
for why they will preserve the document structure restrictions
described above, in the
<a href="#restrictions-general-principles">Restrictions</a> section.</p>
<ul>
<li>Copy is the easiest action to discuss, because it doesn&#39;t
actually edit this user&#39;s document at all, and thus can&#39;t
possibly move it to an invalid state! That one&#39;s safe.</li>
<li>Deleting<ul>
<li>If there is a selection, and the user presses Delete,
the word processor must delete all Text, Blocks,
and Frames that lie entirely within the selection. Such a
move cannot violate the document restrictions because no
new objects are inserted; only full subtrees are deleted.
The cursor will then be at the beginning of the former
selection, which is of necessity a valid cursor position,
because both ends of the selection are either (a) where the
cursor is now, or (b) where the cursor was recently, with
no edits taking place between then and now.</li>
<li>If there is no selection, but there is text after the
cursor and in the same block, then Delete is the same as
&quot;select next character, then delete.&quot;</li>
<li>If there is no selection, and the cursor is at the end of a
block, then the current block and the next one in the Frame
are merged into one block with the properties of the first,
and a list of Text children equal to the concatenation of
the Text children lists from both blocks.  This is
acceptable because it is equivalent to moving text from one
Block to another followed by removing a subtree; these
operations cannot violate the above restrictions.</li>
<li>If there is no selection, and the cursor is at teh end of
the last Block in the Frame, Delete does nothing.</li>
</ul>
</li>
<li>Backspace is the same as Delete but with &quot;before&quot; and &quot;after&quot;
interchanged.</li>
<li>Cut is the same as Copy-then-Delete. Since both have been
handled successfully above, this one is also safe.</li>
<li>Typing letters and symbols<ul>
<li>When there is no selection, it merely inserts new text
before the cursor. Because the cursor can never be anywhere
but inside a Block, it is always at a location where it&#39;s
valid to insert Text.</li>
<li>When there is a selection, typing can be broken into
&quot;Delete the selection as above, which preserves document
validity, then perform the typing action afterwards, with
no selection.&quot;</li>
</ul>
</li>
<li>Pressing enter creates a new Block after the current one (and
of the same type, so a P creates a new P, an LI creates a new
LI), then moves all text from the cursor position to the end
of the current Block into that newly created block, and then
places the cursor at the start of that new Block. Here is why
each of these steps is valid.<ul>
<li>Because the current Block must have a Frame as parent,
adding a new Block as its sibling guarantees that the new
Block is also in a valid location for Blocks.</li>
<li>Because all the content that will be moved is children of a
Block, it must be Text objects, and thus it is valid to put
it all into the new Block.</li>
<li>The cursor can be placed at the start of the new Block
because every Block permits the cursor to sit immediately
after its opening tag.</li>
</ul>
</li>
<li>Pressing shift-enter is just typing the <code>&amp;#10;</code> character (or
the <code>&lt;BR&gt;</code> tag, if needed, which counts as a single-character
Text item, as above).</li>
<li>Applying a paragraph style finds the list of Blocks containing
the cursor and any portion of the selection, and for each one,
modifies its style attribute. This does not alter any aspect
of document structure mentioned in the restrictions above.</li>
<li>Applying a text style (Note that here I&#39;m glossing over the
issues where, if the cursor is inside a SPAN, that SPAN may
need to be split before the following actions take place.
Recall the comments in the
<a href="#cursor-where-can-it-be-positioned-">Cursor</a> section, above.)<ul>
<li>When there is no selection, it inserts an empty SPAN
surrounding the cursor, and having the style that the user
is attempting to apply.  This is acceptable because the
cursor is always inside a Block, and thus it is acceptable
to insert an empty, styled Text node there.</li>
<li>When there is a selection, it finds all Text objects inside
the selection and applies the style to each. For Text
objects that are already SPAN elements, this simply
involves modifying their style attribute. For Text objects
that are unattributed Text nodes, this involves wrapping
them in a new SPAN and then modifying its style attribute.
The only potential danger here is that we are adding SPAN
tags, but because we explicitly avoid doing so when such
tags already exist, we therefore avoid the only possible
danger, that of nesting SPAN tags.</li>
</ul>
</li>
<li>Note that making a hyperlink can be achieved just by applying
attributes to a span, <a href="http://zachgraeve.com/2006/09/01/using-div-and-span-elements-as-clickable-links/">as described
here</a>.</li>
<li>Inserting a smart character (e.g., inserting an image) is the
same as typing a single character, because smart characters
have been defined, in this spec, to be treated exactly like
individual characters.</li>
<li>Inserting a bubble is essentially inserting two smart
characters at once, with the slight difference that one is
inserted at the cursor position and the other at the other end
of the selection (called the &quot;anchor&quot;). Because one is the
cursor&#39;s current position, and the other is a previous
position of the cursor (since which there have been no edits),
both remain valid cursor positions, and thus valid places to
insert text. Thus inserting a smart character (which functions
exactly like text) at each such position is a valid editing
operation.</li>
<li>Choosing the numbered list action: The following three would
require a lot of explanation about why they&#39;re valid, so it&#39;s
left as an exercise to the reader.<ul>
<li>If the current Block is an LI inside an UL, it modifies the
UL tag to be an OL tag instead.</li>
<li>If the current Block is an LI inside an OL, it changes the
LI to a P, and moves it outside the list. (This may involve
breaking the list into two if needed so that the P sits as
a sibling to the list, not as a child of the list. Or it
may involve removing the list entirely, if the current
Block were the only one in the list.)</li>
<li>If the current Block is a P, then it is replaced with the
nested structure LI-inside-OL.</li>
</ul>
</li>
<li>Choosing the bulleted list action is the same, except with OL
and UL interchanged.</li>
<li>Paste<ul>
<li>Pasting plain text is exactly the same as typing the text,
which has already been handled.</li>
<li>Pasting as plain text converts the contents of the
clipboard to plain text, then proceeds as in the previous
bullet.</li>
<li>Pasting rich text (HTML) will be handled as follows: First
paste the text into an invisible DIV outside the document.
Then traverse the DOM tree that&#39;s been created within that
DIV, and place into the current document, at the cursor
point, only those structures that satisfy the requirements
of the document structure, as given above. Obviously this
will need to be carefully tested, and is a complex
procedure, but in theory, an algorithm that filters out the
junk and only keeps the acceptable stuff exists.</li>
</ul>
</li>
<li>The undo and redo actions only traverse the history of states
the document has already been in, so assuming that the above
evidence correctly shows that the document can&#39;t get into an
invalid state via ordinary editing actions, then undo/redo
can&#39;t, either.</li>
</ul>
<h2><a name='junk-keeping-the-document-clean'></a>Junk: Keeping the document clean &nbsp;  <font size=-1><a href='#junk-keeping-the-document-clean'><span class="glyphicon glyphicon-link"></span></a></font></h2><p>You may have noticed that there are ways to create crufty
internal document states that would be externally invisible.  For
instance, one might delete some formatted text, leaving empty
SPAN elements sitting around. Although I do not have one perfect
plan for how to solve this, there are several options.</p>
<ul>
<li>Every time the document is saved, first police away these
potential abnormalities everywhere in the document.</li>
<li>After every single editing action, police away these potential
abnormalities in every Block that was involved in the editing
action.</li>
<li>Provide the app that uses our word processing foundation with
a function it can call to do such policing at whatever times
make sense; for example, <em>Lurch</em> itself might do the policing
before every run of validation, while other apps that use our
word processing foundation would do it at other times.</li>
</ul>

        </div>
        <div id="right">
            <h3 align=center>Navigation</h3><br><h3><a href='index.md.html'>webLurch home</a></h3><p>.</p><ul><li><a href='buildutils.litcoffee.html'>buildutils.litcoffee</a></li><li><a href='cake.litcoffee.html'>cake.litcoffee</a></li></ul><p>./app</p><ul><li><a href='../app/index.html'>index.html</a></li></ul><p>./doc</p><ul><li><a href='overview.md.html'>overview.md</a></li><li><a href='plan.md.html'>plan.md</a></li><li><a href='progress.md.html'>progress.md</a></li><li><a href='test-app-help.md.html'>test-app-help.md</a></li><li><a href='test-results.md.html'>test-results.md</a></li><li><a href='wp-spec.md.html'>wp-spec.md</a></li></ul><p>./src</p><ul><li><a href='domeditaction.litcoffee.html'>domeditaction.litcoffee</a></li><li><a href='domedittracker.litcoffee.html'>domedittracker.litcoffee</a></li><li><a href='domutils.litcoffee.html'>domutils.litcoffee</a></li><li><a href='lurcheditor.litcoffee.html'>lurcheditor.litcoffee</a></li><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li></ul><p>./test</p><ul><li><a href='all-histories-spec.litcoffee.html'>all-histories-spec.litcoffee</a></li><li><a href='basic-spec.litcoffee.html'>basic-spec.litcoffee</a></li><li><a href='domeditaction-spec.litcoffee.html'>domeditaction-spec.litcoffee</a></li><li><a href='domedittracker-spec.litcoffee.html'>domedittracker-spec.litcoffee</a></li><li><a href='domutils-spec.litcoffee.html'>domutils-spec.litcoffee</a></li><li><a href='lurcheditor-spec.litcoffee.html'>lurcheditor-spec.litcoffee</a></li><li><a href='phantom-utils.litcoffee.html'>phantom-utils.litcoffee</a></li><li><a href='undoredo-spec.litcoffee.html'>undoredo-spec.litcoffee</a></li><li><a href='utils-spec.litcoffee.html'>utils-spec.litcoffee</a></li></ul><p>./testapp</p><ul><li><a href='utils.litcoffee.html'>utils.litcoffee</a></li><li><a href='../testapp/index.html'>index.html</a></li></ul>
        </div>
    </body>
</html>

(function(){var Group,Groups,LoadSave,Overlay,grouperHTML,grouperInfo,maybeSetupTestRecorder,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},__slice=[].slice;grouperHTML=function(t,e,n,o,i){return null==o&&(o=!0),o=o?" hide":"",null==i&&(i="images/red-bracket-"+e+".png"),"<img src='"+i+"' class='grouper "+t+o+"' id='"+e+n+"'>"},window.grouperHTML=grouperHTML,grouperInfo=function(t){var e,n,o;return(e=/^(open|close)([0-9]+)$/.exec(null!=t&&"function"==typeof t.getAttribute?t.getAttribute("id"):void 0))?(o={openOrClose:e[1],id:parseInt(e[2])},n=/^grouper ([^ ]+)/.exec(null!=t&&"function"==typeof t.getAttribute?t.getAttribute("class"):void 0),n&&(o.type=n[1]),o):null},window.grouperInfo=grouperInfo,Group=function(){function t(t,e,n){var o,i,r,s;if(this.open=t,this.close=e,this.plugin=n,this.toJSON=__bind(this.toJSON,this),this.contentsChanged=__bind(this.contentsChanged,this),this.outerRange=__bind(this.outerRange,this),this.innerRange=__bind(this.innerRange,this),this.setContentAsText=__bind(this.setContentAsText,this),this.contentAsHTML=__bind(this.contentAsHTML,this),this.contentAsFragment=__bind(this.contentAsFragment,this),this.contentAsText=__bind(this.contentAsText,this),this.get=__bind(this.get,this),this.set=__bind(this.set,this),this.type=__bind(this.type,this),this.typeName=__bind(this.typeName,this),this.id=__bind(this.id,this),null==this.plugin)for(s=tinymce.editors,i=0,r=s.length;r>i;i++)if(o=s[i],o.getDoc()===this.open.ownerDocument){this.plugin=o.Groups;break}this.contentsChanged(!0,!0)}return t.prototype.id=function(){var t,e;return null!=(t=null!=(e=grouperInfo(this.open))?e.id:void 0)?t:null},t.prototype.typeName=function(){var t;return null!=(t=grouperInfo(this.open))?t.type:void 0},t.prototype.type=function(){var t,e;return null!=(t=this.plugin)&&null!=(e=t.groupTypes)?e[this.typeName()]:void 0},t.prototype.set=function(t,e){return/^[a-zA-Z0-9-]+$/.test(t)?(this.open.setAttribute("data-"+t,JSON.stringify([e])),null!=this.plugin?(this.plugin.editor.fire("change"),this.plugin.editor.isNotDirty=!1,this.contentsChanged()):void 0):void 0},t.prototype.get=function(t){var e;try{return JSON.parse(this.open.getAttribute("data-"+t))[0]}catch(n){return void(e=n)}},t.prototype.contentAsText=function(){var t;return null!=(t=this.innerRange())?t.toString():void 0},t.prototype.contentAsFragment=function(){var t;return null!=(t=this.innerRange())?t.cloneContents():void 0},t.prototype.contentAsHTML=function(){var t,e;return(t=this.contentAsFragment())?(e=this.open.ownerDocument.createElement("div"),e.appendChild(t),e.innerHTML):null},t.prototype.setContentAsText=function(t){var e,n,o;if(e=this.innerRange())return null!=(n=this.plugin)&&n.editor.selection.setRng(e),null!=(o=this.plugin)?o.editor.selection.setContent(t):void 0},t.prototype.innerRange=function(){var t,e;e=this.open.ownerDocument.createRange();try{return e.setStartAfter(this.open),e.setEndBefore(this.close),e}catch(n){return t=n,null}},t.prototype.outerRange=function(){var t,e;e=this.open.ownerDocument.createRange();try{return e.setStartBefore(this.open),e.setEndAfter(this.close),e}catch(n){return t=n,null}},t.prototype.contentsChanged=function(t,e){var n,o;return null==t&&(t=!0),null==e&&(e=!1),null!=(n=this.type())&&"function"==typeof n.contentsChanged&&n.contentsChanged(this,e),t&&null!=(o=this.parent)?o.contentsChanged(!0):void 0},t.prototype.toJSON=function(){var t,e,n,o,i,r,s,u;for(n={},r=this.open.attributes,o=0,i=r.length;i>o;o++)if(t=r[o],"data-"===t.nodeName.slice(0,6)&&"data-mce-"!==t.nodeName.slice(0,10))try{n[t.nodeName]=JSON.parse(t.nodeValue)[0]}catch(l){}return{id:this.id(),typeName:this.typeName(),deleted:this.deleted,text:this.contentAsText(),html:this.contentAsHTML(),parent:null!=(s=null!=(u=this.parent)?u.id():void 0)?s:null,children:function(){var t,n,o,i,r,s;for(i=null!=(o=this.children)?o:[],s=[],t=0,n=i.length;n>t;t++)e=i[t],s.push(null!=(r=null!=e?e.id():void 0)?r:null);return s}.call(this),data:n}},t}(),window.Group=Group,Groups=function(){function t(t){this.editor=t,this.drawGroups=__bind(this.drawGroups,this),this.grouperIndexOfRangeEndpoint=__bind(this.grouperIndexOfRangeEndpoint,this),this.groupsTouchingRange=__bind(this.groupsTouchingRange,this),this.rangeChanged=__bind(this.rangeChanged,this),this.groupAboveSelection=__bind(this.groupAboveSelection,this),this.groupAboveCursor=__bind(this.groupAboveCursor,this),this.groupAboveNode=__bind(this.groupAboveNode,this),this.grouperToGroup=__bind(this.grouperToGroup,this),this.ids=__bind(this.ids,this),this.registerGroup=__bind(this.registerGroup,this),this.scanDocument=__bind(this.scanDocument,this),this.enableScanning=__bind(this.enableScanning,this),this.disableScanning=__bind(this.disableScanning,this),this.hideOrShowGroupers=__bind(this.hideOrShowGroupers,this),this.allGroupers=__bind(this.allGroupers,this),this.groupCurrentSelection=__bind(this.groupCurrentSelection,this),this.updateButtonsAndMenuItems=__bind(this.updateButtonsAndMenuItems,this),this.addGroupType=__bind(this.addGroupType,this),this.setUsedID=__bind(this.setUsedID,this),this.addFreeId=__bind(this.addFreeId,this),this.nextFreeId=__bind(this.nextFreeId,this),this.groupTypes={},this.topLevel=[],this.freeIds=[0],this.editor.Overlay.addDrawHandler(this.drawGroups)}return t.prototype.nextFreeId=function(){return this.freeIds.length>1?this.freeIds.shift():this.freeIds[0]++},t.prototype.addFreeId=function(t){return t<this.freeIds[this.freeIds.length-1]?(this.freeIds.push(t),this.freeIds.sort()):void 0},t.prototype.setUsedID=function(t){var e,n;for(n=this.freeIds[this.freeIds.length-1];t>n;)this.freeIds.push(++n);return e=this.freeIds.indexOf(t),this.freeIds.splice(e,1),e===this.freeIds.length?this.freeIds.push(t+1):void 0},t.prototype.addGroupType=function(t,e){var n,o,i,r,s,u;return null==e&&(e={}),t=function(){var e,n,o;for(o=[],e=0,n=t.length;n>e;e++)r=t[e],/[a-zA-Z_-]/.test(r)&&o.push(r);return o}().join(""),this.groupTypes[t]=e,e.hasOwnProperty("text")?(s=this,i={text:e.text,context:null!=(u=e.context)?u:"Insert",onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this),onPostRender:function(){return s.groupTypes[t].menuItem=this,s.updateButtonsAndMenuItems()}},null!=e.shortcut&&(i.shortcut=e.shortcut),null!=e.icon&&(i.icon=e.icon),this.editor.addMenuItem(t,i),n={tooltip:e.tooltip,onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this),onPostRender:function(){return s.groupTypes[t].button=this,s.updateButtonsAndMenuItems()}},o=null!=e.image?"image":null!=e.icon?"icon":"text",n[o]=e[o],this.editor.addButton(t,n)):void 0},t.prototype.updateButtonsAndMenuItems=function(){var t,e,n,o,i,r,s,u,l,a,c,h;if(e=null!=(r=this.editor)&&null!=(s=r.selection)&&null!=(u=s.getRng())?u.cloneRange():void 0){o=e.cloneRange(),e.collapse(!0),o.collapse(!1),t=this.groupAboveCursor(e)===this.groupAboveCursor(o),l=this.groupTypes,h=[];for(n in l)__hasProp.call(l,n)&&(i=l[n],null!=i&&null!=(a=i.button)&&a.disabled(!t),h.push(null!=i&&null!=(c=i.menuItem)?c.disabled(!t):void 0));return h}},t.prototype.groupCurrentSelection=function(t){var e,n,o,i,r,s,u,l,a,c,h,d,p,f;if(this.groupTypes.hasOwnProperty(t))return i=$(null!=(p=this.allGroupers())?p[0]:void 0).hasClass("hide"),r=this.nextFreeId(),a=grouperHTML(t,"open",r,i,this.groupTypes[t]["open-img"]),e=grouperHTML(t,"close",r,i,this.groupTypes[t]["close-img"]),d=this.editor.selection,d.getStart()===d.getEnd()?(o='<span id="put_cursor_here">â€‹</span>',n=this.editor.selection.getContent(),this.editor.insertContent(a+n+o+e),o=$(this.editor.getBody()).find("#put_cursor_here"),e=o.get(0).nextSibling,d.select(o.get(0)),o.remove(),d.select(e),d.collapse(!0),l=this.grouperToGroup(e),null!=(f=l.parent)?f.contentsChanged():void 0):(h=d.getRng(),s=h.startContainer,u=h.startOffset,h.collapse(!1),d.setRng(h),this.disableScanning(),this.editor.insertContent(e),h.setStart(s,u),h.setEnd(s,u),d.setRng(h),this.editor.insertContent(a),this.enableScanning(),h.setStart(s,u),h.setEnd(s,u),c=this.groupAboveCursor(h),null!=c?c.contentsChanged():void 0)},t.prototype.allGroupers=function(){return this.editor.getDoc().getElementsByClassName("grouper")},t.prototype.hideOrShowGroupers=function(){var t,e;return t=$(this.allGroupers()),$(null!=t?t[0]:void 0).hasClass("hide")?t.removeClass("hide"):t.addClass("hide"),null!=(e=this.editor.Overlay)&&e.redrawContents(),this.editor.focus()},t.prototype.disableScanning=function(){return this.scanLocks=(null!=this.scanLocks?this.scanLocks:this.scanLocks=0)+1},t.prototype.enableScanning=function(){var t;return this.scanLocks=Math.max((null!=(t=this.scanLocks)?t:0)-1,0),0===this.scanLocks?this.scanDocument():void 0},t.prototype.scanDocument=function(){var t,e,n,o,i,r,s,u,l,a,c,h,d,p,f,g,m,y,v,b,w,_,C,x,k,T,S,N;if(!(this.scanLocks>0)){for(h=Array.prototype.slice.apply(this.allGroupers()),u=[],m=[],this.topLevel=[],o=this.freeIds.slice(0),p=function(t){var e,n,o,i;for(n=o=0,i=u.length;i>o;n=++o)if(e=u[n],e.id===t)return n;return-1},y=0,_=h.length;_>y;y++)if(c=h[y],null==(f=grouperInfo(c)))$(c).remove();else if("open"===f.openOrClose)u.unshift({id:f.id,grouper:c,children:[]});else if(-1===p(f.id))$(c).remove();else{for(;u[0].id!==f.id;)$(u.shift().grouper).remove();for(a=u.shift(),m.push(f.id),this.registerGroup(a.grouper,c),g=this[f.id],g.children=a.children,T=g.children,v=0,C=T.length;C>v;v++)i=T[v],i.parent=g;u.length>0?u[0].children.push(g):(this.topLevel.push(g),g.parent=null)}for(;u.length>0;)$(u.shift().grouper).remove();for(m.sort(),r=0,this.freeIds=[];m.length>0&&(r===m[0]?m.shift():this.freeIds.push(r),r++,!(r>20)););for(this.freeIds.push(r),e=this.freeIds.slice(0);o[o.length-1]<e[e.length-1];)o.push(o[o.length-1]+1);for(;e[e.length-1]<o[o.length-1];)e.push(e[e.length-1]+1);for(n=function(){var n,i,r;for(r=[],n=0,i=e.length;i>n;n++)t=e[n],__indexOf.call(o,t)<0&&r.push(t);return r}(),s=[],b=0,x=n.length;x>b;b++)d=n[b],s.push(this[d]),null!=(S=this[d])&&(S.deleted=!0),delete this[d];for(w=0,k=s.length;k>w;w++)l=s[w],null!=l&&null!=(N=l.type())&&"function"==typeof N.deleted&&N.deleted(l);return delete this.idsCache,setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)&&e.redrawContents(),t.updateButtonsAndMenuItems()}}(this),0)}},t.prototype.registerGroup=function(t,e){var n,o;return n=this[o=grouperInfo(t).id],((null!=n?n.open:void 0)!==t||(null!=n?n.close:void 0)!==e)&&(this[o]=new Group(t,e,this)),o},t.prototype.ids=function(){var t,e,n,o,i;if(null==this.idsCache)for(this.idsCache=[],e=function(t){return function(n){var o,i,r,s,u;for(t.idsCache.push(n.id()),s=n.children,u=[],i=0,r=s.length;r>i;i++)o=s[i],u.push(e(o));return u}}(this),i=this.topLevel,n=0,o=i.length;o>n;n++)t=i[n],e(t);return this.idsCache},t.prototype.grouperToGroup=function(t){var e,n;return null!=(e=null!=(n=grouperInfo(t))?n.id:void 0)?this[e]:null},t.prototype.groupAboveNode=function(t){var e,n,o,i,r,s;if(0===(e=this.allGroupers()).length)return null;if(i=function(t,e){return Node.DOCUMENT_POSITION_FOLLOWING&t.compareDocumentPosition(e)},o={index:0,grouper:e[0],leftOfNode:!0},o.grouper===t)return this.grouperToGroup(o.grouper);if(!i(o.grouper,t))return null;if(s={index:e.length-1,grouper:e[e.length-1]},s.grouper===t)return this.grouperToGroup(s.grouper);if(i(s.grouper,t))return null;for(;;){if(o.grouper===t)return this.grouperToGroup(o.grouper);if(s.grouper===t)return this.grouperToGroup(s.grouper);if(o.index+1===s.index)return(n=this.grouperToGroup(o.grouper))?o.grouper===n.open?n:n.parent:null;r=Math.floor((o.index+s.index)/2),i(e[r],t)?o={index:r,grouper:e[r],leftOfNode:!0}:s={index:r,grouper:e[r],leftOfNode:!1}}},t.prototype.groupAboveCursor=function(t){var e,n,o;return t.startContainer instanceof this.editor.getWin().Text?this.groupAboveNode(t.startContainer):t.startContainer.childNodes.length>t.startOffset?(e=t.startContainer.childNodes[t.startOffset],o=this.groupAboveNode(e),(null!=o?o.open:void 0)===e?o.parent:o):t.startContainer.childNodes.length>0?(n=t.startContainer.childNodes[t.startOffset-1],o=this.groupAboveNode(n),(null!=o?o.close:void 0)===n?o.parent:o):this.groupAboveNode(t.startContainer)},t.prototype.groupAboveSelection=function(t){var e,n,o,i,r;for(e=t.cloneRange(),e.collapse(!0),e=this.groupAboveCursor(e),n=[];null!==e;)n.unshift(e),e=e.parent;for(i=t.cloneRange(),i.collapse(!1),i=this.groupAboveCursor(i),r=[];null!==i;)r.unshift(i),i=i.parent;for(o=null;n.length>0&&r.length>0&&n[0]===r[0];)o=n.shift(),r.shift();return o},t.prototype.rangeChanged=function(t){var e,n,o,i,r;for(i=this.groupsTouchingRange(t),r=[],n=0,o=i.length;o>n;n++)e=i[n],r.push(e.contentsChanged(!1));return r},t.prototype.groupsTouchingRange=function(t){var e,n,o,i,r,s,u,l,a,c,h;if(0===(e=this.allGroupers()).length)return[];if(n=1+this.grouperIndexOfRangeEndpoint(t,!0,e),r=this.grouperIndexOfRangeEndpoint(t,!1,e),n>r){for(u=t.startContainer,u instanceof this.editor.getWin().Element&&t.startOffset<u.childNodes.length&&(u=u.childNodes[t.startOffset]),o=this.groupAboveNode(u),l=o?o.open===u?o.parent?[o.parent]:[]:[o]:[];s=null!=(h=l[l.length-1])?h.parent:void 0;)l.push(s);return l}for(a=[],l=[],i=c=n;r>=n?r>=c:c>=r;i=r>=n?++c:--c)o=this.grouperToGroup(e[i]),e[i]===o.open?a.push(o):(l.push(o),a.pop());for(;a.length>0;)l.push(a.pop());for(;s=l[l.length-1].parent;)l.push(s);return l},t.prototype.grouperIndexOfRangeEndpoint=function(t,e,n){var o,i,r,s;if(0===(null!=n?n:n=this.allGroupers()).length)return-1;if(o=e?Range.END_TO_START:Range.END_TO_END,i=function(e){return function(n){var i;return i=e.editor.getDoc().createRange(),i.selectNode(n),t.compareBoundaryPoints(o,i)>-1}}(this),e=0,!i(n[e]))return-1;if(s=n.length-1,i(n[s]))return s;for(;;){if(e+1===s)return e;r=Math.floor((e+s)/2),i(n[r])?e=r:s=r}},t.prototype.drawGroups=function(t,e){var n,o,i,r,s,u,l,a,c,h,d,p,f,g,m,y,v,b,w,_,C,x,k,T,S,N,A,I,O,M,D,G;if(this.bubbleTags=[],!(this.scanLocks>0)){for(r=this.groupAboveSelection(this.editor.selection.getRng()),n=null,d=3,p=2,f=4,h=Math.pi/4,w=[];r;){if(C=r.type(),i=null!=(M=null!=C?C.color:void 0)?M:"#444444",a=$(r.open),o=$(r.close),c=a.position(),a={top:c.top,left:c.left,bottom:c.top+a.height(),right:c.left+a.width()},c=o.position(),o={top:c.top,left:c.left,bottom:c.top+o.height(),right:c.left+o.width()},(a.top===a.bottom||o.top===o.bottom||a.left===a.right||o.left===o.right)&&!$(r.open).hasClass("hide"))return void setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0}}(this),100);x=a.left-d/3,T=a.top-d,k=o.right+d/3,S=o.bottom+d,(b=null!=C&&"function"==typeof C.tagContents?C.tagContents(r):void 0)&&(y=this.editor.getWin().getComputedStyle(r.open),w.push({content:b,corner:{x:x,y:T},color:i,style:"font-size:"+y.fontSize+"; font-family:"+y.fontFamily+";",group:r})),e.fillStyle=e.strokeStyle=i,a.top===o.top?e.roundedRect(x,T,k,S,f):(null==n&&(n=getComputedStyle(this.editor.getBody()),s=parseInt(n["margin-left"]),g=parseInt(n["margin-right"])),e.roundedZone(x,T,k,S,a.bottom,o.top,s,g,f)),e.globalAlpha=1,e.lineWidth=1.5,e.stroke(),e.globalAlpha=.3,e.fill(),r=r.parent,d+=p}for(_=[];w.length>0;){if(v=w.shift(),e.font=v.font,!(m=e.measureHTML(v.content,v.style)))return void setTimeout(function(t){return function(){var e;return null!=(e=t.editor.Overlay)?e.redrawContents():void 0}}(this),10);for(x=v.corner.x-p,T=v.corner.y-m.height-2*p,k=x+2*p+m.width,S=v.corner.y,N=0,I=_.length;I>N;N++)l=_[N],rectanglesCollide(x,T,k,S,l.x1,l.y1,l.x2,l.y2)&&(u=l.y1-S,T+=u,S+=u);S=v.corner.y,D=[x,T,k,S],v.x1=D[0],v.y1=D[1],v.x2=D[2],v.y2=D[3],_.unshift(v)}for(G=[],A=0,O=_.length;O>A;A++)v=_[A],e.roundedRect(v.x1,v.y1,v.x2,v.y2,f),e.globalAlpha=1,e.fillStyle="#ffffff",e.fill(),e.lineWidth=1.5,e.strokeStyle=v.color,e.stroke(),e.globalAlpha=.7,e.fillStyle=v.color,e.fill(),e.fillStyle="#000000",e.globalAlpha=1,e.drawHTML(v.content,v.x1+p,v.y1,v.style),G.push(this.bubbleTags.unshift(v));return G}},t}(),tinymce.PluginManager.add("groups",function(t,e){var n,o,i,r;for(t.Groups=new Groups(t),t.on("init",function(e){return t.dom.loadCSS("groupsplugin.css")}),r=t.settings.groupTypes,o=0,i=r.length;i>o;o++)n=r[o],t.Groups.addGroupType(n.name,n);return t.addMenuItem("hideshowgroups",{text:"Hide/show groups",context:"View",onclick:function(){return t.Groups.hideOrShowGroupers()}}),t.on("change SetContent",function(e){var n,o,i;return t.Groups.scanDocument(),(null!=e&&null!=(i=e.level)?i.bookmark:void 0)?(n=t.selection.getBookmark(),t.selection.moveToBookmark(e.level.bookmark),o=t.selection.getRng(),t.selection.moveToBookmark(n),t.Groups.rangeChanged(o)):void 0}),t.on("KeyUp",function(e){var n,o,i,r;return o=[33,34,35,36,37,38,39,40],n=[16,17,18,91],i=e.keyCode,__indexOf.call(o,i)>=0||(r=e.keyCode,__indexOf.call(n,r)>=0)?void 0:(t.Groups.scanDocument(),t.Groups.rangeChanged(t.selection.getRng()))}),t.on("NodeChange",function(e){return t.Groups.updateButtonsAndMenuItems()}),t.on("contextMenu",function(e){var n,o,i,r,s,u,l,a,c,h,d,p,f,g,m;for(e.preventDefault(),h=e.clientX,d=e.clientY,(a=t.getDoc().nodeFromPoint(h,d))&&(o=t.Groups.groupAboveNode(a)),n=t.settings.contextmenu||"link image inserttable | cell row column deletetable",r=[],g=n.split(/[ ,]/),p=0,f=g.length;f>p;p++)u=g[p],i=t.menuItems[u],"|"===u&&(i={text:u}),i&&(i.shortcut="",r.push(i));return(l=null!=o&&null!=(m=o.type())?m.contextMenuItems(o):void 0)&&(r.push({text:"|"}),r=r.concat(l)),s=new tinymce.ui.Menu({items:r,context:"contextmenu"}).addClass("contextmenu").renderTo(),t.on("remove",function(){return s.remove(),s=null}),c=$(t.getContentAreaContainer()).position(),s.moveTo(h+c.left,d+c.top)}),t.on("mousedown",function(e){var n,o,i,r,s,u,l,a,c,h,d,p;for(s=e.clientX,u=e.clientY,c=t.Groups.bubbleTags,p=[],l=0,a=c.length;a>l;l++){if(r=c[l],r.x1<s&&s<r.x2&&r.y1<u&&u<r.y2){o=null!=(h=r.group)&&null!=(d=h.type())?d.tagMenuItems(r.group):void 0,null==o&&(o=[{text:"no actions available",disabled:!0}]),n=new tinymce.ui.Menu({items:o,context:"contextmenu"}).addClass("contextmenu").renderTo(),t.on("remove",function(){return n.remove(),n=null}),i=$(t.getContentAreaContainer()).position(),n.moveTo(s+i.left,u+i.top),e.preventDefault();break}p.push(void 0)}return p})}),LoadSave=function(){function t(e){var n;this.editor=e,this.manageFiles=__bind(this.manageFiles,this),this.handleOpen=__bind(this.handleOpen,this),this.tryToOpen=__bind(this.tryToOpen,this),this.load=__bind(this.load,this),this.tryToSave=__bind(this.tryToSave,this),this.save=__bind(this.save,this),this.tryToClear=__bind(this.tryToClear,this),this.clear=__bind(this.clear,this),this.setFileSystem=__bind(this.setFileSystem,this),this.setAppName=__bind(this.setAppName,this),this.setFilepath=__bind(this.setFilepath,this),this.setFilename=__bind(this.setFilename,this),this.setDocumentDirty=__bind(this.setDocumentDirty,this),this.recomputePageTitle=__bind(this.recomputePageTitle,this),this.setAppName(t.prototype.appName),this.setFileSystem(this.appName),this.setFilepath(FileSystem.prototype.pathSeparator),setTimeout(function(t){return function(){return t.clear()}}(this),0),this.saveMetaData=this.loadMetaData=null,this.editor.on("change",function(t){return function(e){return t.setDocumentDirty(!0)}}(this)),n=function(t){return function(e,n){var o,i;return o={icon:n.icon,shortcut:n.shortcut,onclick:n.onclick,tooltip:n.tooltip},i=null!=n.icon?"icon":"text",o[i]=n[i],t.editor.addButton(e,o),t.editor.addMenuItem(e,n)}}(this),n("newfile",{text:"New",icon:"newdocument",context:"file",shortcut:"ctrl+N",tooltip:"New file",onclick:function(t){return function(){return t.tryToClear()}}(this)}),n("savefile",{text:"Save",icon:"save",context:"file",shortcut:"ctrl+S",tooltip:"Save file",onclick:function(t){return function(){return t.tryToSave()}}(this)}),this.editor.addMenuItem("saveas",{text:"Save as...",context:"file",shortcut:"ctrl+shift+S",onclick:function(t){return function(){return t.tryToSave(null,"")}}(this)}),n("openfile",{text:"Open...",icon:"browse",context:"file",shortcut:"ctrl+O",tooltip:"Open file...",onclick:function(t){return function(){return t.handleOpen()}}(this)}),this.editor.addMenuItem("managefiles",{text:"Manage files...",context:"file",onclick:function(t){return function(){return t.manageFiles()}}(this)}),t.prototype.instances.push(this)}return t.prototype.appName=null,t.setAppName=function(e){var n,o,i,r,s;for(null==e&&(e=null),t.prototype.appName=e,r=t.prototype.instances,s=[],o=0,i=r.length;i>o;o++)n=r[o],s.push(n.setAppName(e));return s},t.prototype.instances=[],t.prototype.recomputePageTitle=function(){return document.title=""+(this.appName?this.appName+": ":"")+" "+(this.filename||"(untitled)")+" "+(this.documentDirty?"*":"")},t.prototype.setDocumentDirty=function(t){return null==t&&(t=!0),this.documentDirty=t,this.recomputePageTitle()},t.prototype.setFilename=function(t){return null==t&&(t=null),this.filename=t,this.recomputePageTitle()},t.prototype.setFilepath=function(t){return null==t&&(t=null),this.filepath=t},t.prototype.setAppName=function(t){var e;return null==t&&(t=null),e=this.appName===this.fileSystem,this.appName=t,e&&(this.fileSystem=this.appName),this.recomputePageTitle()},t.prototype.setFileSystem=function(t){return null==t&&(t=this.appName),this.fileSystem=t},t.prototype.clear=function(){return this.editor.setContent(""),this.setDocumentDirty(!1),this.setFilename(null)},t.prototype.tryToClear=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.tryToSave(function(e){return e?t.clear():void 0}),t.editor.windowManager.close()}}(this)},{text:"Discard",onclick:function(t){return function(){return t.clear(),t.editor.windowManager.close()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):(this.clear(),void this.editor.focus())},t.prototype.save=function(){var t,e;if(null!==this.filename)return e=new FileSystem(this.fileSystem),e.cd(this.filepath),t=[this.editor.getContent(),"function"==typeof this.saveMetaData?this.saveMetaData():void 0],e.write(this.filename,t,!0)?this.setDocumentDirty(!1):void 0},t.prototype.tryToSave=function(t,e){var n,o,i,r;return null==e&&(e=this.filename),e?(this.setFilename(e),i=this.save(),this.editor.focus(),"function"==typeof t?t(i):void 0):(o=function(){var t,n,o,i,r,s;if(n=document.getElementsByClassName("mce-window")[0]){for(r=n.getElementsByTagName("button"),s=[],o=0,i=r.length;i>o;o++){if(t=r[o],"Save"===t.textContent){e?(t.removeAttribute("disabled"),t.parentNode.style.backgroundImage=null,t.parentNode.style.backgroundColor=null):(t.setAttribute("disabled",!0),t.parentNode.style.backgroundImage="none",t.parentNode.style.backgroundColor="#ccc");break}s.push(void 0)}return s}},e=null,this.saveFileNameChangedHandler=function(t){return e=t,o()},n=null,this.changedFolderHandler=function(t){return n=t},r=function(t){return function(e,n){var o;return o=new FileSystem(t.fileSystem),o.cd(e),null!==o.type(n)}}(this),this.buttonClickedHandler=function(o){return function(){var s,u;return u=arguments[0],s=2<=arguments.length?__slice.call(arguments,1):[],"Save"===u?r(n,e)&&!confirm("Are you sure you want to overwrite the file "+e+"?")?void o.tellDialog("setFileBrowserMode","save file"):(o.setFilepath(n),o.setFilename(e),o.editor.windowManager.close(),i=o.save(),"function"==typeof t?t(i):void 0):"Cancel"===u?(o.editor.windowManager.close(),"function"==typeof t?t(!1):void 0):void 0}}(this),this.editor.windowManager.open({title:"Save file...",url:"filedialog/filedialog.html",width:600,height:400,buttons:[{text:"Save",subtype:"primary",onclick:function(t){return function(){return t.buttonClickedHandler("Save")}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.buttonClickedHandler("Cancel")}}(this)}]},{fsName:this.fileSystem,mode:"save file"}))},t.prototype.load=function(t,e){var n,o,i,r;if(null!==e)return null===t&&(t="."),i=new FileSystem(this.fileSystem),i.cd(t),r=i.read(e),n=r[0],o=r[1],this.editor.setContent(n),this.editor.focus(),this.setFilepath(t),this.setFilename(e),this.setDocumentDirty(!1),o&&"function"==typeof this.loadMetaData?this.loadMetaData(o):void 0},t.prototype.tryToOpen=function(t){var e,n,o;return null==t&&(t=function(t){return function(e,n){return t.load(e,n)}}(this)),o=function(t){return function(){var t,n,o,i,r,s;if(n=document.getElementsByClassName("mce-window")[0]){for(r=n.getElementsByTagName("button"),s=[],o=0,i=r.length;i>o;o++){if(t=r[o],"Open"===t.textContent){e?(t.removeAttribute("disabled"),t.parentNode.style.backgroundImage=null,t.parentNode.style.backgroundColor=null):(t.setAttribute("disabled",!0),t.parentNode.style.backgroundImage="none",t.parentNode.style.backgroundColor="#ccc");break}s.push(void 0)}return s}}}(this),e=null,this.selectedFileHandler=function(t){return e=t,o()},n=null,this.changedFolderHandler=function(t){return n=t},this.buttonClickedHandler=function(o){return function(){var i,r;return r=arguments[0],i=2<=arguments.length?__slice.call(arguments,1):[],"Open"===r?(o.editor.windowManager.close(),"function"==typeof t?t(n,e):void 0):"Cancel"===r?(o.editor.windowManager.close(),"function"==typeof t?t(null,null):void 0):void 0}}(this),this.editor.windowManager.open({title:"Open file...",url:"filedialog/filedialog.html",width:600,height:400,buttons:[{text:"Open",subtype:"primary",onclick:function(t){return function(){return t.buttonClickedHandler("Open")}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.buttonClickedHandler("Cancel")}}(this)}]},{fsName:this.fileSystem,mode:"open file"}),o()},t.prototype.handleOpen=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.editor.windowManager.close(),t.tryToSave(function(e){return e?t.tryToOpen():void 0})}}(this)},{text:"Discard",onclick:function(t){return function(){return t.editor.windowManager.close(),t.tryToOpen()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):this.tryToOpen()},t.prototype.tellDialog=function(){var t,e,n,o,i;for(t=1<=arguments.length?__slice.call(arguments,0):[],n=document.getElementsByTagName("iframe"),o=0,i=n.length;i>o;o++)if(e=n[o],"filedialog/filedialog.html"===e.getAttribute("src"))return e.contentWindow.postMessage(t,"*")},t.prototype.manageFiles=function(){return this.editor.windowManager.open({title:"Manage files",url:"filedialog/filedialog.html",width:700,height:500,buttons:[{text:"New folder",onclick:function(t){return function(){return t.tellDialog("buttonClicked","New folder")}}(this)},{text:"Done",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]},{fsName:this.fileSystem,mode:"manage files"})},t}(),tinymce.PluginManager.add("loadsave",function(t,e){return t.LoadSave=new LoadSave(t)}),window.onmessage=function(t){var e,n,o,i,r;for(e=""+t.data[0]+"Handler",r=LoadSave.prototype.instances,o=0,i=r.length;i>o;o++)if(n=r[o],n.hasOwnProperty(e))return n[e].apply(null,t.data.slice(1))},window.setAppName=function(t){return null==t&&(t=null),LoadSave.prototype.appName=t},Overlay=function(){function t(t){this.editor=t,this.redrawContents=__bind(this.redrawContents,this),this.editor.on("init",function(t){return function(){return t.container=t.editor.getContentAreaContainer(),t.canvas=document.createElement("canvas"),$(t.container).after(t.canvas),t.canvas.style.position="absolute",t.canvas.style["background-color"]="rgba(0,0,0,0)",t.canvas.style["pointer-events"]="none",t.canvas.style["z-index"]="10"}}(this)),this.drawHandlers=[],this.editor.on("NodeChange",this.redrawContents),$(window).resize(this.redrawContents)}return t.prototype.redrawContents=function(t){var e,n,o,i,r,s,u,l;if(this.positionCanvas(),e=null!=(s=this.canvas)?s.getContext("2d"):void 0){for(this.clearCanvas(e),e.translate(0,$(this.container).position().top),u=this.drawHandlers,l=[],i=0,r=u.length;r>i;i++){n=u[i];try{l.push(n(this.canvas,e))}catch(a){o=a,l.push(console.log("Error in overlay draw function: "+o.stack))}}return l}},t.prototype.addDrawHandler=function(t){return this.drawHandlers.push(t)},t.prototype.getEditorFrame=function(){var t,e,n,o;for(o=window.frames,e=0,n=o.length;n>e;e++)if(t=o[e],t.document===this.editor.getDoc())return t;return null},t.prototype.positionCanvas=function(){var t,e;return e=$(this.container),t=$(this.canvas),null!=e.position()?(t.css("top",0),t.css("left",e.position().left),t.width(e.width()),t.height(e.position().top+e.height()),this.canvas.width=t.width(),this.canvas.height=t.height()):void 0},t.prototype.clearCanvas=function(t){return t.clearRect(0,0,this.canvas.width,this.canvas.height)},t}(),tinymce.PluginManager.add("overlay",function(t,e){return t.Overlay=new Overlay(t)}),setAppName("Lurch"),$(function(){var editor;return editor=document.createElement("textarea"),editor.setAttribute("id","editor"),document.body.appendChild(editor),maybeSetupTestRecorder(),tinymce.init({selector:"#editor",auto_focus:"editor",browser_spellcheck:!0,gecko_spellcheck:!0,statusbar:!1,plugins:"advlist table charmap colorpicker image link importcss paste print save searchreplace textcolor fullscreen -loadsave -overlay -groups",object_resizing:":not(img.grouper)",toolbar:["newfile openfile savefile managefiles | print | undo redo | cut copy paste | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent blockquote | table","fontselect styleselect | bold italic underline textcolor subscript superscript removeformat | link unlink | charmap image | spellchecker searchreplace | me"],menu:{file:{title:"File",items:"newfile openfile | savefile saveas | managefiles | print"},edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall"},insert:{title:"Insert",items:"link media | template hr | me"},view:{title:"View",items:"visualaid hideshowgroups"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"},help:{title:"Help",items:"about website"}},contextmenu:"link image inserttable | cell row column deletetable",setup:function(t){return t.addMenuItem("about",{text:"About...",context:"help",onclick:function(){return alert("webLurch\n\npre-alpha, not yet intended for general consumption!")}}),t.addMenuItem("website",{text:"Lurch website",context:"help",onclick:function(){return window.open("http://www.lurchmath.org","_blank")}}),t.on("init",function(){var e,n;return installDOMUtilitiesIn(t.getWin()),t.getBody().style.fontSize="16px",setTimeout(function(){var e,n,o,i,r,s;for(t.execCommand("mceFullScreen"),n=t.iframeElement;n&&n!==t.container;)n===t.iframeElement.parentNode?n.style.height="auto":n.style.height="100%",n=n.parentNode;for(r=t.getDoc().getElementsByTagName("html"),s=[],o=0,i=r.length;i>o;o++)e=r[o],s.push(e.style.height="auto");return s},0),e=t.getContainer().getElementsByClassName("mce-menubtn")[0],n=document.createElement("img"),n.setAttribute("src","icons/apple-touch-icon-76x76.png"),n.style.width=n.style.height="26px",n.style.padding="2px",e.insertBefore(n,e.childNodes[0]),t.getBody().addEventListener("focus",function(){return 0!==t.windowManager.getWindows().length?t.windowManager.close():void 0})})},groupTypes:[{name:"me",text:"Meaningful expression",image:"./images/red-bracket-icon.png",tooltip:"Make text a meaningful expression",color:"#996666",tagContents:function(t){var e;return""+(null!=(e=t.contentAsText())?e.length:void 0)+" characters"},contentsChanged:function(t,e){return Background.addTask("notify",[t],function(t){return console.log(t)})},deleted:function(t){return console.log("You deleted this group:",t)},contextMenuItems:function(t){return[{text:t.contentAsText(),onclick:function(){return alert("Example code for testing");
}}]},tagMenuItems:function(group){return[{text:"Compute",onclick:function(){var e,text;if(text=group.contentAsText(),!/^[0-9+*/ -]+$/.test(text))return void alert("Not a mathematical expression");try{return alert(""+text+" evaluates to:\n"+eval(text))}catch(_error){return e=_error,alert("Error in "+text+":\n"+e)}}}]}}]})}),Background.registerFunction("arith",function(group){var e,lhs,_ref,_ref1;return(lhs=null!=group&&null!=(_ref=group.text)&&null!=(_ref1=_ref.split("="))?_ref1[0]:void 0)?""+lhs+"="+function(){if(!/^[0-9+*/ ()-]+$/.test(lhs))return"???";try{return eval(lhs)}catch(_error){return e=_error,"???"}}():null}),Background.registerFunction("notify",function(t){return null!=t?t.text:void 0}),Background.registerFunction("count",function(t){var e,n;for(e=0,n=(new Date).getTime()+1e3;(new Date).getTime()<n;)e++;return"from "+(n-1e3)+" to "+n+", counted "+e}),maybeSetupTestRecorder=function(){var t,e,n;return"?test"===location.search?(n=open("./testrecorder.html","recording","status=no, location=no, toolbar=no, menubar=no, left="+(window.screenX+$(window).width())+", top="+window.screenY+", width=400, height=600"),n||alert("You have asked to run webLurch in test-recording mode, which requires a popup window.  Your browser has blocked the popup window.  Change its settings or allow this popup to use test-recording mode."),e=[],(t=function(){var o,i,r,s,u,l,a,c,h,d,p,f;s=function(t){return alert("You "+t+", which the test recorder does not yet support.  The current test has therefore become corrupted, and you should reload this page and start your test again.  You will need to limit yourself to using only supported keys, menu items, and mouse operations.")};try{if(__indexOf.call(e,"keypress")<0&&(tinymce.activeEditor.on("keypress",function(t){var e;return e=String.fromCharCode(t.keyCode),/[A-Za-z0-9 ]/.test(e)?n.editorKeyPress(t.keyCode,t.shiftKey,t.ctrlKey,t.altKey):s("pressed the key with code "+t.keyCode)}),e.push("keypress")),__indexOf.call(e,"keyup")<0&&(tinymce.activeEditor.on("keyup",function(t){var e,o,i,r;return i=String.fromCharCode(t.keyCode),/[A-Za-z0-9 ]/.test(i)||(o=[16,17,18,91],r=t.keyCode,__indexOf.call(o,r)>=0)?void 0:(e={8:"backspace",13:"enter",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",46:"delete"},e.hasOwnProperty(t.keyCode)?n.editorKeyPress(e[t.keyCode],t.shiftKey,t.ctrlKey,t.altKey):s("pressed the key with code "+t.keyCode))}),e.push("keyup")),__indexOf.call(e,"click")<0&&(tinymce.activeEditor.on("click",function(t){return t.shiftKey?s("shift-clicked"):t.ctrlKey?s("ctrl-clicked"):t.altKey?s("alt-clicked"):n.editorMouseClick(t.clientX,t.clientY)}),e.push("click")),r=function(t){return Array.prototype.slice.apply(tinymce.activeEditor.theme.panel.find(t))},__indexOf.call(e,"buttons")<0){for(p=r("button"),l=function(t){return t.on("click",function(){return n.buttonClicked(t.settings.icon)})},a=0,h=p.length;h>a;a++)o=p[a],l(o);e.push("buttons")}for(f=__slice.call(r("splitbutton")).concat(__slice.call(r("listbox")),__slice.call(r("menubutton"))),c=0,d=f.length;d>c;c++)u=f[c],u.disabled(!0);return n.enterReadyState()}catch(g){return i=g,setTimeout(t,100)}})()):void 0}}).call(this);
//# sourceMappingURL=app.min.js.map
(function(){var t,e,n,i=function(t,e){return function(){return t.apply(e,arguments)}},r=[].slice;t=function(){function t(t){this.editor=t,this.scanDocument=i(this.scanDocument,this),this.hideOrShowGroupers=i(this.hideOrShowGroupers,this),this.allGroupers=i(this.allGroupers,this),this.groupCurrentSelection=i(this.groupCurrentSelection,this),this.addGroupType=i(this.addGroupType,this),this.setUsedID=i(this.setUsedID,this),this.addFreeId=i(this.addFreeId,this),this.nextFreeId=i(this.nextFreeId,this),this.groupTypes={},this.freeIds=[0]}return t.prototype.nextFreeId=function(){return this.freeIds.length>1?this.freeIds.shift():this.freeIds[0]++},t.prototype.addFreeId=function(t){return t<this.freeIds[this.freeIds.length-1]?(this.freeIds.push(t),this.freeIds.sort()):void 0},t.prototype.setUsedID=function(t){var e,n;for(n=this.freeIds[this.freeIds.length-1];t>n;)this.freeIds.push(++n);return e=this.freeIds.indexOf(t),this.freeIds.splice(e,1),e===this.freeIds.length?this.freeIds.push(t+1):void 0},t.prototype.addGroupType=function(t,e){var n,i,r,o,s;return null==e&&(e={}),t=function(){var e,n,i;for(i=[],e=0,n=t.length;n>e;e++)o=t[e],/[a-zA-Z_-]/.test(o)&&i.push(o);return i}().join(""),this.groupTypes[t]=e,e.hasOwnProperty("text")?(r={text:e.text,context:null!=(s=e.context)?s:"Insert",onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this)},null!=e.shortcut&&(r.shortcut=e.shortcut),null!=e.icon&&(r.icon=e.icon),this.editor.addMenuItem(t,r),n={tooltip:e.tooltip,onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this)},i=null!=e.image?"image":null!=e.icon?"icon":"text",n[i]=e[i],this.editor.addButton(t,n)):void 0},t.prototype.groupCurrentSelection=function(t){var e,n,i,r,o,s,a,l,u;if(this.groupTypes.hasOwnProperty(t))return r=$(null!=(a=this.allGroupers())?a[0]:void 0).hasClass("hide"),o=this.nextFreeId(),s=this.grouperHTML(t,null!=(l=this.groupTypes[t]["open-img"])?l:"images/red-bracket-open.png","open",o,r),e=this.grouperHTML(t,null!=(u=this.groupTypes[t]["close-img"])?u:"images/red-bracket-close.png","close",o,r),i='<span id="put_cursor_here">â€‹</span>',n=this.editor.selection.getContent(),this.editor.insertContent(s+n+i+e),i=$(this.editor.getBody()).find("#put_cursor_here"),this.editor.selection.select(i.get(0)),i.remove()},t.prototype.grouperHTML=function(t,e,n,i,r){return null==r&&(r=!0),r=r?" hide":"","<img src='"+e+"' class='grouper "+t+r+"' id='"+n+i+"'>"},t.prototype.grouperInfo=function(t){var e;return e=/^(open|close)([0-9]+)$/.exec(null!=t&&"function"==typeof t.getAttribute?t.getAttribute("id"):void 0),e?{type:e[1],id:e[2]}:null},t.prototype.allGroupers=function(){return this.editor.getDoc().getElementsByClassName("grouper")},t.prototype.hideOrShowGroupers=function(){var t;return t=$(this.allGroupers()),$(null!=t?t[0]:void 0).hasClass("hide")?t.removeClass("hide"):t.addClass("hide")},t.prototype.scanDocument=function(){var t,e,n,i,r,o,s,a,l;for(n=Array.prototype.slice.apply(this.allGroupers()),i=[],t=[],s=0,a=n.length;a>s;s++)if(e=n[s],null==(o=this.grouperInfo(e)))$(e).remove();else if("open"===o.type)i.unshift(o.id),t.unshift(e);else if(r=i.indexOf(o.id),-1===r)$(e).remove();else{for(;i[0]!==o.id;)i.shift(),$(t.shift()).remove();i.shift(),t.shift()}for(l=[];i.length>0;)i.shift(),l.push($(t.shift()).remove());return l},t}(),tinymce.PluginManager.add("groups",function(e,n){var i,r,o,s;for(e.Groups=new t(e),e.on("init",function(t){return e.dom.loadCSS("groupsplugin.css")}),s=e.settings.groupTypes,r=0,o=s.length;o>r;r++)i=s[r],e.Groups.addGroupType(i.name,i);return e.addMenuItem("hideshowgroups",{text:"Hide/show groups",context:"View",onclick:function(){return e.Groups.hideOrShowGroupers()}})}),e=function(){function t(e){var n;this.editor=e,this.manageFiles=i(this.manageFiles,this),this.handleOpen=i(this.handleOpen,this),this.tryToOpen=i(this.tryToOpen,this),this.load=i(this.load,this),this.tryToSave=i(this.tryToSave,this),this.save=i(this.save,this),this.tryToClear=i(this.tryToClear,this),this.clear=i(this.clear,this),this.setFileSystem=i(this.setFileSystem,this),this.setAppName=i(this.setAppName,this),this.setFilepath=i(this.setFilepath,this),this.setFilename=i(this.setFilename,this),this.setDocumentDirty=i(this.setDocumentDirty,this),this.recomputePageTitle=i(this.recomputePageTitle,this),this.setAppName(t.prototype.appName),this.setFileSystem(this.appName),this.setFilepath(FileSystem.prototype.pathSeparator),setTimeout(function(t){return function(){return t.clear()}}(this),0),this.saveMetaData=this.loadMetaData=null,this.editor.on("change",function(t){return function(e){return t.setDocumentDirty(!0)}}(this)),n=function(t){return function(e,n){var i,r;return i={icon:n.icon,shortcut:n.shortcut,onclick:n.onclick,tooltip:n.tooltip},r=null!=n.icon?"icon":"text",i[r]=n[r],t.editor.addButton(e,i),t.editor.addMenuItem(e,n)}}(this),n("newfile",{text:"New",icon:"newdocument",context:"file",shortcut:"ctrl+N",tooltip:"New file",onclick:function(t){return function(){return t.tryToClear()}}(this)}),n("savefile",{text:"Save",icon:"save",context:"file",shortcut:"ctrl+S",tooltip:"Save file",onclick:function(t){return function(){return t.tryToSave()}}(this)}),this.editor.addMenuItem("saveas",{text:"Save as...",context:"file",shortcut:"ctrl+shift+S",onclick:function(t){return function(){return t.tryToSave(null,"")}}(this)}),n("openfile",{text:"Open...",icon:"browse",context:"file",shortcut:"ctrl+O",tooltip:"Open file...",onclick:function(t){return function(){return t.handleOpen()}}(this)}),this.editor.addMenuItem("managefiles",{text:"Manage files...",context:"file",onclick:function(t){return function(){return t.manageFiles()}}(this)}),t.prototype.instances.push(this)}return t.prototype.appName=null,t.setAppName=function(e){var n,i,r,o,s;for(null==e&&(e=null),t.prototype.appName=e,o=t.prototype.instances,s=[],i=0,r=o.length;r>i;i++)n=o[i],s.push(n.setAppName(e));return s},t.prototype.instances=[],t.prototype.recomputePageTitle=function(){return document.title=""+(this.appName?this.appName+": ":"")+" "+(this.filename||"(untitled)")+" "+(this.documentDirty?"*":"")},t.prototype.setDocumentDirty=function(t){return null==t&&(t=!0),this.documentDirty=t,this.recomputePageTitle()},t.prototype.setFilename=function(t){return null==t&&(t=null),this.filename=t,this.recomputePageTitle()},t.prototype.setFilepath=function(t){return null==t&&(t=null),this.filepath=t},t.prototype.setAppName=function(t){var e;return null==t&&(t=null),e=this.appName===this.fileSystem,this.appName=t,e&&(this.fileSystem=this.appName),this.recomputePageTitle()},t.prototype.setFileSystem=function(t){return null==t&&(t=this.appName),this.fileSystem=t},t.prototype.clear=function(){return this.editor.setContent(""),this.setDocumentDirty(!1),this.setFilename(null)},t.prototype.tryToClear=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.tryToSave(function(e){return e?t.clear():void 0}),t.editor.windowManager.close()}}(this)},{text:"Discard",onclick:function(t){return function(){return t.clear(),t.editor.windowManager.close()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):(this.clear(),void this.editor.focus())},t.prototype.save=function(){var t,e;if(null!==this.filename)return e=new FileSystem(this.fileSystem),e.cd(this.filepath),t=[this.editor.getContent(),"function"==typeof this.saveMetaData?this.saveMetaData():void 0],e.write(this.filename,t,!0)?this.setDocumentDirty(!1):void 0},t.prototype.tryToSave=function(t,e){var n,i,o,s;return null==e&&(e=this.filename),e?(this.setFilename(e),o=this.save(),this.editor.focus(),"function"==typeof t?t(o):void 0):(i=function(){var t,n,i,r,o,s;if(n=document.getElementsByClassName("mce-window")[0]){for(o=n.getElementsByTagName("button"),s=[],i=0,r=o.length;r>i;i++){if(t=o[i],"Save"===t.textContent){e?(t.removeAttribute("disabled"),t.parentNode.style.backgroundImage=null,t.parentNode.style.backgroundColor=null):(t.setAttribute("disabled",!0),t.parentNode.style.backgroundImage="none",t.parentNode.style.backgroundColor="#ccc");break}s.push(void 0)}return s}},e=null,this.saveFileNameChangedHandler=function(t){return e=t,i()},n=null,this.changedFolderHandler=function(t){return n=t},s=function(t){return function(e,n){var i;return i=new FileSystem(t.fileSystem),i.cd(e),null!==i.type(n)}}(this),this.buttonClickedHandler=function(i){return function(){var a,l;return l=arguments[0],a=2<=arguments.length?r.call(arguments,1):[],"Save"===l?s(n,e)&&!confirm("Are you sure you want to overwrite the file "+e+"?")?void i.tellDialog("setFileBrowserMode","save file"):(i.setFilepath(n),i.setFilename(e),i.editor.windowManager.close(),o=i.save(),"function"==typeof t?t(o):void 0):"Cancel"===l?(i.editor.windowManager.close(),"function"==typeof t?t(!1):void 0):void 0}}(this),this.editor.windowManager.open({title:"Save file...",url:"filedialog/filedialog.html",width:600,height:400,buttons:[{text:"Save",subtype:"primary",onclick:function(t){return function(){return t.buttonClickedHandler("Save")}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.buttonClickedHandler("Cancel")}}(this)}]},{fsName:this.fileSystem,mode:"save file"}))},t.prototype.load=function(t,e){var n,i,r,o;if(null!==e)return null===t&&(t="."),r=new FileSystem(this.fileSystem),r.cd(t),o=r.read(e),n=o[0],i=o[1],this.editor.setContent(n),this.editor.focus(),this.setFilepath(t),this.setFilename(e),this.setDocumentDirty(!1),i&&"function"==typeof this.loadMetaData?this.loadMetaData(i):void 0},t.prototype.tryToOpen=function(t){var e,n,i;return null==t&&(t=function(t){return function(e,n){return t.load(e,n)}}(this)),i=function(t){return function(){var t,n,i,r,o,s;if(n=document.getElementsByClassName("mce-window")[0]){for(o=n.getElementsByTagName("button"),s=[],i=0,r=o.length;r>i;i++){if(t=o[i],"Open"===t.textContent){e?(t.removeAttribute("disabled"),t.parentNode.style.backgroundImage=null,t.parentNode.style.backgroundColor=null):(t.setAttribute("disabled",!0),t.parentNode.style.backgroundImage="none",t.parentNode.style.backgroundColor="#ccc");break}s.push(void 0)}return s}}}(this),e=null,this.selectedFileHandler=function(t){return e=t,i()},n=null,this.changedFolderHandler=function(t){return n=t},this.buttonClickedHandler=function(i){return function(){var o,s;return s=arguments[0],o=2<=arguments.length?r.call(arguments,1):[],"Open"===s?(i.editor.windowManager.close(),"function"==typeof t?t(n,e):void 0):"Cancel"===s?(i.editor.windowManager.close(),"function"==typeof t?t(null,null):void 0):void 0}}(this),this.editor.windowManager.open({title:"Open file...",url:"filedialog/filedialog.html",width:600,height:400,buttons:[{text:"Open",subtype:"primary",onclick:function(t){return function(){return t.buttonClickedHandler("Open")}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.buttonClickedHandler("Cancel")}}(this)}]},{fsName:this.fileSystem,mode:"open file"}),i()},t.prototype.handleOpen=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.editor.windowManager.close(),t.tryToSave(function(e){return e?t.tryToOpen():void 0})}}(this)},{text:"Discard",onclick:function(t){return function(){return t.editor.windowManager.close(),t.tryToOpen()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):this.tryToOpen()},t.prototype.tellDialog=function(){var t,e,n,i,o;for(t=1<=arguments.length?r.call(arguments,0):[],n=document.getElementsByTagName("iframe"),i=0,o=n.length;o>i;i++)if(e=n[i],"filedialog/filedialog.html"===e.getAttribute("src"))return e.contentWindow.postMessage(t,"*")},t.prototype.manageFiles=function(){return this.editor.windowManager.open({title:"Manage files",url:"filedialog/filedialog.html",width:700,height:500,buttons:[{text:"New folder",onclick:function(t){return function(){return t.tellDialog("buttonClicked","New folder")}}(this)},{text:"Done",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]},{fsName:this.fileSystem,mode:"manage files"})},t}(),tinymce.PluginManager.add("loadsave",function(t,n){return t.LoadSave=new e(t)}),window.onmessage=function(t){var n,i,r,o,s;for(n=""+t.data[0]+"Handler",s=e.prototype.instances,r=0,o=s.length;o>r;r++)if(i=s[r],i.hasOwnProperty(n))return i[n].apply(null,t.data.slice(1))},window.setAppName=function(t){return null==t&&(t=null),e.prototype.appName=t},n=function(){function t(t){this.editor=t,this.editor.on("init",function(t){return function(){return t.canvas=document.createElement("canvas"),t.editor.getContentAreaContainer().appendChild(t.canvas),t.canvas.style.position="absolute",t.canvas.style.top=t.canvas.style.left="0px",t.canvas.style["background-color"]="rgba(0,0,0,0)",t.canvas.style["pointer-events"]="none",t.canvas.style["z-index"]="10"}}(this)),this.drawHandlers=[],this.editor.on("NodeChange",function(t){return function(e){var n,i,r,o,s,a,l;for(t.positionCanvas(),n=t.canvas.getContext("2d"),t.clearCanvas(n),a=t.drawHandlers,l=[],o=0,s=a.length;s>o;o++){i=a[o];try{l.push(i(t.canvas,n))}catch(u){r=u,l.push(console.log("Error in overlay draw function: "+r))}}return l}}(this))}return t.prototype.addDrawHandler=function(t){return this.drawHandlers.push(t)},t.prototype.getEditorFrame=function(){var t,e,n,i;for(i=window.frames,e=0,n=i.length;n>e;e++)if(t=i[e],t.document===this.editor.getDoc())return t;return null},t.prototype.positionCanvas=function(){var t,e,n;for(this.canvas.width=this.canvas.parentNode.offsetWidth,this.canvas.height=this.canvas.parentNode.offsetHeight,e=n=this.getEditorFrame(),t=function(t){return tinymce.DOM.hasClass(t,"mce-container-body")};n&&!t(n);)n=n.parentNode;return n?this.canvas.style.top=n.clientHeight-e.clientHeight:void 0},t.prototype.clearCanvas=function(t){return t.clearRect(0,0,this.canvas.width,this.canvas.height)},t}(),tinymce.PluginManager.add("overlay",function(t,e){return t.Overlay=new n(t)}),setAppName("Lurch"),$(function(){var t;return t=document.createElement("textarea"),t.setAttribute("id","editor"),document.body.appendChild(t),tinymce.init({selector:"#editor",auto_focus:"editor",browser_spellcheck:!0,gecko_spellcheck:!0,statusbar:!1,plugins:"advlist table charmap colorpicker contextmenu image link importcss paste print save searchreplace textcolor fullscreen -loadsave -overlay -groups",toolbar:["newfile openfile savefile managefiles | print | undo redo | cut copy paste | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent blockquote | table","fontselect styleselect | bold italic underline textcolor subscript superscript removeformat | link unlink | charmap image | spellchecker searchreplace | me"],menu:{file:{title:"File",items:"newfile openfile | savefile saveas | managefiles | print"},edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall"},insert:{title:"Insert",items:"link media | template hr | me"},view:{title:"View",items:"visualaid hideshowgroups"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"},help:{title:"Help",items:"about website"}},contextmenu:"link image inserttable | cell row column deletetable",setup:function(t){return t.addMenuItem("about",{text:"About...",context:"help",onclick:function(){return alert("webLurch\n\npre-alpha, not intended for general consumption!")}}),t.addMenuItem("website",{text:"Lurch website",context:"help",onclick:function(){return window.open("http://www.lurchmath.org","_blank")}}),t.on("init",function(){var e,n;return t.getBody().style.fontSize="16px",setTimeout(function(){var e,n,i,r,o,s;for(t.execCommand("mceFullScreen"),n=t.iframeElement;n&&n!==t.container;)n===t.iframeElement.parentNode?n.style.height="auto":n.style.height="100%",n=n.parentNode;for(o=t.getDoc().getElementsByTagName("html"),s=[],i=0,r=o.length;r>i;i++)e=o[i],s.push(e.style.height="auto");return s},0),e=t.getContainer().getElementsByClassName("mce-menubtn")[0],n=document.createElement("img"),n.setAttribute("src","icons/apple-touch-icon-76x76.png"),n.style.width=n.style.height="26px",n.style.padding="2px",e.insertBefore(n,e.childNodes[0]),t.getBody().addEventListener("focus",function(){return 0!==t.windowManager.getWindows().length?t.windowManager.close():void 0})})},groupTypes:[{name:"me",text:"Meaningful expression",image:"./images/red-bracket-icon.png",tooltip:"Make text a meaningful expression"}]})})}).call(this);
//# sourceMappingURL=app.min.js.map
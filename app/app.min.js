(function(){var t,e,n,i,o,r,s,a=function(t,e){return function(){return t.apply(e,arguments)}},l=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},u=[].slice;o=function(t,e,n,i,o){return null==i&&(i=!0),i=i?" hide":"",null==o&&(o="images/red-bracket-"+e+".png"),"<img src='"+o+"' class='grouper "+t+i+"' id='"+e+n+"'>"},window.grouperHTML=o,r=function(t){var e;return e=/^(open|close)([0-9]+)$/.exec(null!=t&&"function"==typeof t.getAttribute?t.getAttribute("id"):void 0),e?{type:e[1],id:parseInt(e[2])}:null},window.grouperInfo=r,t=function(){function t(t,e){this.open=t,this.close=e}return t.prototype.id=function(){var t,e;return null!=(t=null!=(e=r(this.open))?e.id:void 0)?t:null},t}(),window.Group=t,e=function(){function e(t){this.editor=t,this.registerGroup=a(this.registerGroup,this),this.scanDocument=a(this.scanDocument,this),this.enableScanning=a(this.enableScanning,this),this.disableScanning=a(this.disableScanning,this),this.hideOrShowGroupers=a(this.hideOrShowGroupers,this),this.allGroupers=a(this.allGroupers,this),this.groupCurrentSelection=a(this.groupCurrentSelection,this),this.addGroupType=a(this.addGroupType,this),this.setUsedID=a(this.setUsedID,this),this.addFreeId=a(this.addFreeId,this),this.nextFreeId=a(this.nextFreeId,this),this.groupTypes={},this.freeIds=[0]}return e.prototype.nextFreeId=function(){return this.freeIds.length>1?this.freeIds.shift():this.freeIds[0]++},e.prototype.addFreeId=function(t){return t<this.freeIds[this.freeIds.length-1]?(this.freeIds.push(t),this.freeIds.sort()):void 0},e.prototype.setUsedID=function(t){var e,n;for(n=this.freeIds[this.freeIds.length-1];t>n;)this.freeIds.push(++n);return e=this.freeIds.indexOf(t),this.freeIds.splice(e,1),e===this.freeIds.length?this.freeIds.push(t+1):void 0},e.prototype.addGroupType=function(t,e){var n,i,o,r,s;return null==e&&(e={}),t=function(){var e,n,i;for(i=[],e=0,n=t.length;n>e;e++)r=t[e],/[a-zA-Z_-]/.test(r)&&i.push(r);return i}().join(""),this.groupTypes[t]=e,e.hasOwnProperty("text")?(o={text:e.text,context:null!=(s=e.context)?s:"Insert",onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this)},null!=e.shortcut&&(o.shortcut=e.shortcut),null!=e.icon&&(o.icon=e.icon),this.editor.addMenuItem(t,o),n={tooltip:e.tooltip,onclick:function(e){return function(){return e.groupCurrentSelection(t)}}(this)},i=null!=e.image?"image":null!=e.icon?"icon":"text",n[i]=e[i],this.editor.addButton(t,n)):void 0},e.prototype.groupCurrentSelection=function(t){var e,n,i,r,s,a,l,u,c,h,d,p,f;if(this.groupTypes.hasOwnProperty(t))return r=$(null!=(f=this.allGroupers())?f[0]:void 0).hasClass("hide"),s=this.nextFreeId(),u=o(t,"open",s,r,this.groupTypes[t]["open-img"]),e=o(t,"close",s,r,this.groupTypes[t]["close-img"]),p=this.editor.selection,p.getStart()===p.getEnd()?(i='<span id="put_cursor_here">â€‹</span>',n=this.editor.selection.getContent(),this.editor.insertContent(u+n+i+e),i=$(this.editor.getBody()).find("#put_cursor_here"),p.select(i.get(0)),i.remove()):(c=p.getRng(),a=c.startContainer,l=c.startOffset,h=c.endContainer,d=c.endOffset,c.collapse(!1),p.setRng(c),this.disableScanning(),this.editor.insertContent(e),c.setStart(a,l),c.setEnd(a,l),p.setRng(c),this.editor.insertContent(u),this.enableScanning())},e.prototype.allGroupers=function(){return this.editor.getDoc().getElementsByClassName("grouper")},e.prototype.hideOrShowGroupers=function(){var t;return t=$(this.allGroupers()),$(null!=t?t[0]:void 0).hasClass("hide")?t.removeClass("hide"):t.addClass("hide")},e.prototype.disableScanning=function(){return this.scanLocks=(null!=this.scanLocks?this.scanLocks:this.scanLocks=0)+1},e.prototype.enableScanning=function(){var t;return this.scanLocks=Math.max((null!=(t=this.scanLocks)?t:0)-1,0),0===this.scanLocks?this.scanDocument():void 0},e.prototype.scanDocument=function(){var t,e,n,i,o,s,a,u,c,h,d,p,f,m,g,y,v,w,b;if(!(this.scanLocks>0)){for(u=Array.prototype.slice.apply(this.allGroupers()),h=[],s=[],m=[],i=this.freeIds.slice(0),g=0,v=u.length;v>g;g++)if(a=u[g],null==(p=r(a)))$(a).remove();else if("open"===p.type)h.unshift(p.id),s.unshift(a);else if(d=h.indexOf(p.id),-1===d)$(a).remove();else{for(;h[0]!==p.id;)h.shift(),$(s.shift()).remove();m.push(h.shift()),f=s.shift(),this.registerGroup(f,a)}for(;h.length>0;)h.shift(),$(s.shift()).remove();for(m.sort(),o=0,this.freeIds=[];m.length>0&&(o===m[0]?m.shift():this.freeIds.push(o),o++,!(o>20)););for(this.freeIds.push(o),e=this.freeIds.slice(0);i[i.length-1]<e[e.length-1];)i.push(i[i.length-1]+1);for(;e[e.length-1]<i[i.length-1];)e.push(e[e.length-1]+1);for(n=function(){var n,o,r;for(r=[],n=0,o=e.length;o>n;n++)t=e[n],l.call(i,t)<0&&r.push(t);return r}(),b=[],y=0,w=n.length;w>y;y++)c=n[y],b.push(delete this[c]);return b}},e.prototype.registerGroup=function(e,n){var i,o;return i=this[o=r(e).id],((null!=i?i.open:void 0)!==e||(null!=i?i.close:void 0)!==n)&&(this[o]=new t(e,n)),o},e}(),tinymce.PluginManager.add("groups",function(t,n){var i,o,r,s;for(t.Groups=new e(t),t.on("init",function(e){return t.dom.loadCSS("groupsplugin.css")}),s=t.settings.groupTypes,o=0,r=s.length;r>o;o++)i=s[o],t.Groups.addGroupType(i.name,i);return t.addMenuItem("hideshowgroups",{text:"Hide/show groups",context:"View",onclick:function(){return t.Groups.hideOrShowGroupers()}}),t.on("change",function(e){return t.Groups.scanDocument()}),t.on("KeyUp",function(e){var n;if(!(33<=(n=e.keyCode)&&40>=n))return t.Groups.scanDocument()})}),n=function(){function t(e){var n;this.editor=e,this.manageFiles=a(this.manageFiles,this),this.handleOpen=a(this.handleOpen,this),this.tryToOpen=a(this.tryToOpen,this),this.load=a(this.load,this),this.tryToSave=a(this.tryToSave,this),this.save=a(this.save,this),this.tryToClear=a(this.tryToClear,this),this.clear=a(this.clear,this),this.setFileSystem=a(this.setFileSystem,this),this.setAppName=a(this.setAppName,this),this.setFilepath=a(this.setFilepath,this),this.setFilename=a(this.setFilename,this),this.setDocumentDirty=a(this.setDocumentDirty,this),this.recomputePageTitle=a(this.recomputePageTitle,this),this.setAppName(t.prototype.appName),this.setFileSystem(this.appName),this.setFilepath(FileSystem.prototype.pathSeparator),setTimeout(function(t){return function(){return t.clear()}}(this),0),this.saveMetaData=this.loadMetaData=null,this.editor.on("change",function(t){return function(e){return t.setDocumentDirty(!0)}}(this)),n=function(t){return function(e,n){var i,o;return i={icon:n.icon,shortcut:n.shortcut,onclick:n.onclick,tooltip:n.tooltip},o=null!=n.icon?"icon":"text",i[o]=n[o],t.editor.addButton(e,i),t.editor.addMenuItem(e,n)}}(this),n("newfile",{text:"New",icon:"newdocument",context:"file",shortcut:"ctrl+N",tooltip:"New file",onclick:function(t){return function(){return t.tryToClear()}}(this)}),n("savefile",{text:"Save",icon:"save",context:"file",shortcut:"ctrl+S",tooltip:"Save file",onclick:function(t){return function(){return t.tryToSave()}}(this)}),this.editor.addMenuItem("saveas",{text:"Save as...",context:"file",shortcut:"ctrl+shift+S",onclick:function(t){return function(){return t.tryToSave(null,"")}}(this)}),n("openfile",{text:"Open...",icon:"browse",context:"file",shortcut:"ctrl+O",tooltip:"Open file...",onclick:function(t){return function(){return t.handleOpen()}}(this)}),this.editor.addMenuItem("managefiles",{text:"Manage files...",context:"file",onclick:function(t){return function(){return t.manageFiles()}}(this)}),t.prototype.instances.push(this)}return t.prototype.appName=null,t.setAppName=function(e){var n,i,o,r,s;for(null==e&&(e=null),t.prototype.appName=e,r=t.prototype.instances,s=[],i=0,o=r.length;o>i;i++)n=r[i],s.push(n.setAppName(e));return s},t.prototype.instances=[],t.prototype.recomputePageTitle=function(){return document.title=""+(this.appName?this.appName+": ":"")+" "+(this.filename||"(untitled)")+" "+(this.documentDirty?"*":"")},t.prototype.setDocumentDirty=function(t){return null==t&&(t=!0),this.documentDirty=t,this.recomputePageTitle()},t.prototype.setFilename=function(t){return null==t&&(t=null),this.filename=t,this.recomputePageTitle()},t.prototype.setFilepath=function(t){return null==t&&(t=null),this.filepath=t},t.prototype.setAppName=function(t){var e;return null==t&&(t=null),e=this.appName===this.fileSystem,this.appName=t,e&&(this.fileSystem=this.appName),this.recomputePageTitle()},t.prototype.setFileSystem=function(t){return null==t&&(t=this.appName),this.fileSystem=t},t.prototype.clear=function(){return this.editor.setContent(""),this.setDocumentDirty(!1),this.setFilename(null)},t.prototype.tryToClear=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.tryToSave(function(e){return e?t.clear():void 0}),t.editor.windowManager.close()}}(this)},{text:"Discard",onclick:function(t){return function(){return t.clear(),t.editor.windowManager.close()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):(this.clear(),void this.editor.focus())},t.prototype.save=function(){var t,e;if(null!==this.filename)return e=new FileSystem(this.fileSystem),e.cd(this.filepath),t=[this.editor.getContent(),"function"==typeof this.saveMetaData?this.saveMetaData():void 0],e.write(this.filename,t,!0)?this.setDocumentDirty(!1):void 0},t.prototype.tryToSave=function(t,e){var n,i,o,r;return null==e&&(e=this.filename),e?(this.setFilename(e),o=this.save(),this.editor.focus(),"function"==typeof t?t(o):void 0):(i=function(){var t,n,i,o,r,s;if(n=document.getElementsByClassName("mce-window")[0]){for(r=n.getElementsByTagName("button"),s=[],i=0,o=r.length;o>i;i++){if(t=r[i],"Save"===t.textContent){e?(t.removeAttribute("disabled"),t.parentNode.style.backgroundImage=null,t.parentNode.style.backgroundColor=null):(t.setAttribute("disabled",!0),t.parentNode.style.backgroundImage="none",t.parentNode.style.backgroundColor="#ccc");break}s.push(void 0)}return s}},e=null,this.saveFileNameChangedHandler=function(t){return e=t,i()},n=null,this.changedFolderHandler=function(t){return n=t},r=function(t){return function(e,n){var i;return i=new FileSystem(t.fileSystem),i.cd(e),null!==i.type(n)}}(this),this.buttonClickedHandler=function(i){return function(){var s,a;return a=arguments[0],s=2<=arguments.length?u.call(arguments,1):[],"Save"===a?r(n,e)&&!confirm("Are you sure you want to overwrite the file "+e+"?")?void i.tellDialog("setFileBrowserMode","save file"):(i.setFilepath(n),i.setFilename(e),i.editor.windowManager.close(),o=i.save(),"function"==typeof t?t(o):void 0):"Cancel"===a?(i.editor.windowManager.close(),"function"==typeof t?t(!1):void 0):void 0}}(this),this.editor.windowManager.open({title:"Save file...",url:"filedialog/filedialog.html",width:600,height:400,buttons:[{text:"Save",subtype:"primary",onclick:function(t){return function(){return t.buttonClickedHandler("Save")}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.buttonClickedHandler("Cancel")}}(this)}]},{fsName:this.fileSystem,mode:"save file"}))},t.prototype.load=function(t,e){var n,i,o,r;if(null!==e)return null===t&&(t="."),o=new FileSystem(this.fileSystem),o.cd(t),r=o.read(e),n=r[0],i=r[1],this.editor.setContent(n),this.editor.focus(),this.setFilepath(t),this.setFilename(e),this.setDocumentDirty(!1),i&&"function"==typeof this.loadMetaData?this.loadMetaData(i):void 0},t.prototype.tryToOpen=function(t){var e,n,i;return null==t&&(t=function(t){return function(e,n){return t.load(e,n)}}(this)),i=function(t){return function(){var t,n,i,o,r,s;if(n=document.getElementsByClassName("mce-window")[0]){for(r=n.getElementsByTagName("button"),s=[],i=0,o=r.length;o>i;i++){if(t=r[i],"Open"===t.textContent){e?(t.removeAttribute("disabled"),t.parentNode.style.backgroundImage=null,t.parentNode.style.backgroundColor=null):(t.setAttribute("disabled",!0),t.parentNode.style.backgroundImage="none",t.parentNode.style.backgroundColor="#ccc");break}s.push(void 0)}return s}}}(this),e=null,this.selectedFileHandler=function(t){return e=t,i()},n=null,this.changedFolderHandler=function(t){return n=t},this.buttonClickedHandler=function(i){return function(){var o,r;return r=arguments[0],o=2<=arguments.length?u.call(arguments,1):[],"Open"===r?(i.editor.windowManager.close(),"function"==typeof t?t(n,e):void 0):"Cancel"===r?(i.editor.windowManager.close(),"function"==typeof t?t(null,null):void 0):void 0}}(this),this.editor.windowManager.open({title:"Open file...",url:"filedialog/filedialog.html",width:600,height:400,buttons:[{text:"Open",subtype:"primary",onclick:function(t){return function(){return t.buttonClickedHandler("Open")}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.buttonClickedHandler("Cancel")}}(this)}]},{fsName:this.fileSystem,mode:"open file"}),i()},t.prototype.handleOpen=function(){return this.documentDirty?this.editor.windowManager.open({title:"Save first?",buttons:[{text:"Save",onclick:function(t){return function(){return t.editor.windowManager.close(),t.tryToSave(function(e){return e?t.tryToOpen():void 0})}}(this)},{text:"Discard",onclick:function(t){return function(){return t.editor.windowManager.close(),t.tryToOpen()}}(this)},{text:"Cancel",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]}):this.tryToOpen()},t.prototype.tellDialog=function(){var t,e,n,i,o;for(t=1<=arguments.length?u.call(arguments,0):[],n=document.getElementsByTagName("iframe"),i=0,o=n.length;o>i;i++)if(e=n[i],"filedialog/filedialog.html"===e.getAttribute("src"))return e.contentWindow.postMessage(t,"*")},t.prototype.manageFiles=function(){return this.editor.windowManager.open({title:"Manage files",url:"filedialog/filedialog.html",width:700,height:500,buttons:[{text:"New folder",onclick:function(t){return function(){return t.tellDialog("buttonClicked","New folder")}}(this)},{text:"Done",onclick:function(t){return function(){return t.editor.windowManager.close()}}(this)}]},{fsName:this.fileSystem,mode:"manage files"})},t}(),tinymce.PluginManager.add("loadsave",function(t,e){return t.LoadSave=new n(t)}),window.onmessage=function(t){var e,i,o,r,s;for(e=""+t.data[0]+"Handler",s=n.prototype.instances,o=0,r=s.length;r>o;o++)if(i=s[o],i.hasOwnProperty(e))return i[e].apply(null,t.data.slice(1))},window.setAppName=function(t){return null==t&&(t=null),n.prototype.appName=t},i=function(){function t(t){this.editor=t,this.editor.on("init",function(t){return function(){return t.canvas=document.createElement("canvas"),t.editor.getContentAreaContainer().appendChild(t.canvas),t.canvas.style.position="absolute",t.canvas.style.top=t.canvas.style.left="0px",t.canvas.style["background-color"]="rgba(0,0,0,0)",t.canvas.style["pointer-events"]="none",t.canvas.style["z-index"]="10"}}(this)),this.drawHandlers=[],this.editor.on("NodeChange",function(t){return function(e){var n,i,o,r,s,a,l;for(t.positionCanvas(),n=t.canvas.getContext("2d"),t.clearCanvas(n),a=t.drawHandlers,l=[],r=0,s=a.length;s>r;r++){i=a[r];try{l.push(i(t.canvas,n))}catch(u){o=u,l.push(console.log("Error in overlay draw function: "+o))}}return l}}(this))}return t.prototype.addDrawHandler=function(t){return this.drawHandlers.push(t)},t.prototype.getEditorFrame=function(){var t,e,n,i;for(i=window.frames,e=0,n=i.length;n>e;e++)if(t=i[e],t.document===this.editor.getDoc())return t;return null},t.prototype.positionCanvas=function(){var t,e,n;for(this.canvas.width=this.canvas.parentNode.offsetWidth,this.canvas.height=this.canvas.parentNode.offsetHeight,e=n=this.getEditorFrame(),t=function(t){return tinymce.DOM.hasClass(t,"mce-container-body")};n&&!t(n);)n=n.parentNode;return n?this.canvas.style.top=n.clientHeight-e.clientHeight:void 0},t.prototype.clearCanvas=function(t){return t.clearRect(0,0,this.canvas.width,this.canvas.height)},t}(),tinymce.PluginManager.add("overlay",function(t,e){return t.Overlay=new i(t)}),setAppName("Lurch"),$(function(){var t;return t=document.createElement("textarea"),t.setAttribute("id","editor"),document.body.appendChild(t),s(),tinymce.init({selector:"#editor",auto_focus:"editor",browser_spellcheck:!0,gecko_spellcheck:!0,statusbar:!1,plugins:"advlist table charmap colorpicker contextmenu image link importcss paste print save searchreplace textcolor fullscreen -loadsave -overlay -groups",toolbar:["newfile openfile savefile managefiles | print | undo redo | cut copy paste | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent blockquote | table","fontselect styleselect | bold italic underline textcolor subscript superscript removeformat | link unlink | charmap image | spellchecker searchreplace | me"],menu:{file:{title:"File",items:"newfile openfile | savefile saveas | managefiles | print"},edit:{title:"Edit",items:"undo redo | cut copy paste pastetext | selectall"},insert:{title:"Insert",items:"link media | template hr | me"},view:{title:"View",items:"visualaid hideshowgroups"},format:{title:"Format",items:"bold italic underline strikethrough superscript subscript | formats | removeformat"},table:{title:"Table",items:"inserttable tableprops deletetable | cell row column"},help:{title:"Help",items:"about website"}},contextmenu:"link image inserttable | cell row column deletetable",setup:function(t){return t.addMenuItem("about",{text:"About...",context:"help",onclick:function(){return alert("webLurch\n\npre-alpha, not intended for general consumption!")}}),t.addMenuItem("website",{text:"Lurch website",context:"help",onclick:function(){return window.open("http://www.lurchmath.org","_blank")}}),t.on("init",function(){var e,n;return t.getBody().style.fontSize="16px",setTimeout(function(){var e,n,i,o,r,s;for(t.execCommand("mceFullScreen"),n=t.iframeElement;n&&n!==t.container;)n===t.iframeElement.parentNode?n.style.height="auto":n.style.height="100%",n=n.parentNode;for(r=t.getDoc().getElementsByTagName("html"),s=[],i=0,o=r.length;o>i;i++)e=r[i],s.push(e.style.height="auto");return s},0),e=t.getContainer().getElementsByClassName("mce-menubtn")[0],n=document.createElement("img"),n.setAttribute("src","icons/apple-touch-icon-76x76.png"),n.style.width=n.style.height="26px",n.style.padding="2px",e.insertBefore(n,e.childNodes[0]),t.getBody().addEventListener("focus",function(){return 0!==t.windowManager.getWindows().length?t.windowManager.close():void 0})})},groupTypes:[{name:"me",text:"Meaningful expression",image:"./images/red-bracket-icon.png",tooltip:"Make text a meaningful expression"}]})}),s=function(){var t,e,n;return"?test"===location.search?(n=open("./testrecorder.html","recording","status=no, location=no, toolbar=no, menubar=no, left="+(window.screenX+$(window).width())+", top="+window.screenY+", width=400, height=600"),n||alert("You have asked to run webLurch in test-recording mode, which requires a popup window.  Your browser has blocked the popup window.  Change its settings or allow this popup to use test-recording mode."),e=[],(t=function(){var i,o,r,s,a,c,h,d,p,f,m,g;s=function(t){return alert("You "+t+", which the test recorder does not yet support.  The current test has therefore become corrupted, and you should reload this page and start your test again.  You will need to limit yourself to using only supported keys, menu items, and mouse operations.")};try{if(l.call(e,"keypress")<0&&(tinymce.activeEditor.on("keypress",function(t){var e;return e=String.fromCharCode(t.keyCode),/[A-Za-z0-9 ]/.test(e)?n.editorKeyPress(t.keyCode,t.shiftKey,t.ctrlKey,t.altKey):s("pressed the key with code "+t.keyCode)}),e.push("keypress")),l.call(e,"keyup")<0&&(tinymce.activeEditor.on("keyup",function(t){var e,i,o,r;return o=String.fromCharCode(t.keyCode),/[A-Za-z0-9 ]/.test(o)||(i=[16,17,18,91],r=t.keyCode,l.call(i,r)>=0)?void 0:(e={8:"backspace",13:"enter",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",46:"delete"},e.hasOwnProperty(t.keyCode)?n.editorKeyPress(e[t.keyCode],t.shiftKey,t.ctrlKey,t.altKey):s("pressed the key with code "+t.keyCode))}),e.push("keyup")),l.call(e,"click")<0&&(tinymce.activeEditor.on("click",function(t){return t.shiftKey?s("shift-clicked"):t.ctrlKey?s("ctrl-clicked"):t.altKey?s("alt-clicked"):n.editorMouseClick(t.clientX,t.clientY)}),e.push("click")),r=function(t){return Array.prototype.slice.apply(tinymce.activeEditor.theme.panel.find(t))},l.call(e,"buttons")<0){for(m=r("button"),c=function(t){return t.on("click",function(){return n.buttonClicked(t.settings.icon)})},h=0,p=m.length;p>h;h++)i=m[h],c(i);e.push("buttons")}for(g=u.call(r("splitbutton")).concat(u.call(r("listbox")),u.call(r("menubutton"))),d=0,f=g.length;f>d;d++)a=g[d],a.disabled(!0);return n.enterReadyState()}catch(y){return o=y,setTimeout(t,100)}})()):void 0}}).call(this);
//# sourceMappingURL=app.min.js.map
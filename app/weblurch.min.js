(function(){var t,e,i,n=[].slice,r={}.hasOwnProperty,o=function(t,e){function i(){this.constructor=t}for(var n in e)r.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},s=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};window.DOMEditAction=t=function(){function t(){var i,r,o,s,h,l,a,d,c,u,p,f,m,g,N,y;if(d=arguments[0],h=arguments[1],r=3<=arguments.length?n.call(arguments,2):[],"compound"===d){for(this.type=d,this.subactions=null==h?[]:h instanceof Array?h:[h].concat(r),g=this.subactions,c=0,f=g.length;f>c;c++)if(i=g[c],!(i instanceof t))throw Error("Compound action array\ncontaind a non-action: "+i);if(0===this.subactions.length)this.node=[],this.tracker=null;else for(this.node=this.subactions[0].node,this.tracker=this.subactions[0].tracker,N=this.subactions.slice(1),u=0,m=N.length;m>u;u++)for(i=N[u],o=i.length,o>this.node.length&&(o=this.node.length),s=p=1;o>=1?o>p:p>o;s=o>=1?++p:--p)if(this.node[s]!==i[s]){this.node=this.node.slice(0,s);break}return this.description="Document edit",this}if(!(h instanceof Node))throw Error("This is not a node: "+h);if(this.tracker=e.instanceOver(h),this.type=d,this.node=h.address(null!=(y=this.tracker)?y.getElement():void 0),"appendChild"===d){if(1!==r.length)throw Error("Wrong # of parameters: "+r);if(!(r[0]instanceof Node))throw Error("Invalid parameter: "+r);this.toAppend=r[0].toJSON()}else if("insertBefore"===d){if(1!==r.length&&2!==r.length)throw Error("Wrong # of parameters: "+r);if(!(r[0]instanceof Node))throw Error("Invalid parameter: "+r[0]);if(this.toInsert=r[0].toJSON(),2===r.length){if(!(r[1]instanceof Node))throw Error("Invalid parameter: "+r[0]);if(r[1].parentNode!==h)throw Error("Invalid child: "+r[0]);this.insertBefore=r[1].indexInParent()}else this.insertBefore=h.childNodes.length}else if("normalize"===d){if(0!==r.length)throw Error("Wrong # of parameters: "+r);this.sequences={},a=this,l=function(t){return function(e,i){var n,r,o,s,h,a;for(null==i&&(i=[]),n=e.childNodes[0],r=0,a=[];n;){if(s=i.concat([r]),n instanceof Text&&n.nextSibling instanceof Text){for(h=[];n instanceof Text;)h.push(n.textContent),n=n.nextSibling;o=JSON.stringify(s),t.sequences[o]=h}else l(n,s),n=n.nextSibling;a.push(r++)}return a}}(this),l(h)}else if("removeAttribute"===d){if(1!==r.length)throw Error("Wrong # of parameters: "+r);this.name=r[0]+"",this.value=h.getAttribute(this.name)}else if("removeAttributeNode"===d){if(1!==r.length)throw Error("Wrong # of parameters: "+r);if(!(r[0]instanceof Attr))throw Error("Invalid attribute node: "+r[0]);this.name=r[0].name,this.value=h.getAttribute(this.name)}else if("removeChild"===d){if(1!==r.length)throw Error("Wrong # of parameters: "+r);if(!(r[0]instanceof Node))throw Error("Invalid parameter: "+r[0]);if(r[0].parentNode!==h)throw Error("Invalid child: "+r[0]);this.childIndex=r[0].indexInParent(),this.child=r[0].toJSON()}else if("replaceChild"===d){if(2!==r.length)throw Error("Wrong # of parameters: "+r);if(!(r[0]instanceof Node))throw Error("Invalid parameter: "+r[0]);if(!(r[1]instanceof Node))throw Error("Invalid parameter: "+r[1]);if(r[1].parentNode!==h)throw Error("Invalid child: "+r[1]);this.childIndex=r[1].indexInParent(),this.oldChild=r[1].toJSON(),this.newChild=r[0].toJSON()}else if("setAttribute"===d){if(2!==r.length)throw Error("Wrong # of parameters: "+r);this.name=r[0]+"",this.newValue=r[1]+"",this.oldValue=h.getAttribute(this.name)||""}else{if("setAttributeNode"!==d)throw Error("Invalid DOMEditAction type: "+d);if(1!==r.length)throw Error("Wrong # of parameters: "+r);if(!(r[0]instanceof Attr))throw Error("Invalid parameter: "+r[0]);this.name=r[0].name,this.newValue=r[0].value,this.oldValue=h.getAttribute(this.name)||""}}return t.prototype.isNullAction=function(){var t,e,i,n;if("appendChild"===this.type||"insertBefore"===this.type||"removeChild"===this.type)return!1;if("removeAttribute"===this.type||"removeAttributeNode"===this.type)return console.log("old attribute is",this.name,this.value),null===this.value;if("normalize"===this.type)return JSON.equals(this.sequences,{});if("replaceChild"===this.type)return JSON.equals(this.oldChild,this.newChild);if("setAttribute"===this.type||"setAttributeNode"===this.type)return this.oldValue===this.newValue;if("compound"===this.type){for(n=this.subactions,e=0,i=n.length;i>e;e++)if(t=n[e],!t.isNullAction())return!1;return!0}throw Error("Invalid DOMEditAction type: "+this.type)},t.prototype.toString=function(){var t,e,i,n,r,o;return t=50,"appendChild"===this.type?(o=Node.fromJSON(this.toAppend).textContent,o.length>t&&(o=o.slice(0,+t+1||9e9)+"..."),0===o.length&&(o="a node"),"Add "+o):"insertBefore"===this.type?(o=Node.fromJSON(this.toInsert).textContent,o.length>t&&(o=o.slice(0,+t+1||9e9)+"..."),0===o.length&&(o="a node"),"Insert "+o):"normalize"===this.type?"Normalize text":"removeAttribute"===this.type||"removeAttributeNode"===this.type?"Remove "+this.name+" attribute":"removeChild"===this.type?(o=Node.fromJSON(this.child).textContent,o.length>t&&(o=o.slice(0,+t+1||9e9)+"..."),0===o.length&&(o="a node"),"Remove "+o):"replaceChild"===this.type?(n=Node.fromJSON(this.oldChild).textContent,n.length>t&&(n=n.slice(0,+t+1||9e9)+"..."),0===n.length&&(n="a node"),r=Node.fromJSON(this.newChild).textContent,r.length>t&&(r=r.slice(0,+t+1||9e9)+"..."),0===r.length&&(r="a node"),"Replace "+n+" with "+r):"setAttribute"===this.type||"setAttributeNode"===this.type?(i=this.oldValue||"empty",e=this.newValue||"empty","Change "+this.name+" from "+i+" to "+e):"compound"===this.type?this.description:"Error, unknown edit action type: "+this.type},t.prototype.toJSON=function(){return{type:this.type,node:this.node,toAppend:this.toAppend,toInsert:this.toInsert,insertBefore:this.insertBefore,sequences:this.sequences,name:this.name,value:this.value,child:this.child,childIndex:this.childIndex,oldChild:this.oldChild,newChild:this.newChild,oldValue:this.oldValue,newValue:this.newValue,description:this.description,subactions:this.subactions}},t.prototype.redo=function(){var t,e,i,n,r,o,s,h;if(!this.tracker)throw Error("Cannot redo action with no DOMEditTracker");if(i=this.tracker.getElement().index(this.node),"appendChild"===this.type)return i.appendChild(Node.fromJSON(this.toAppend));if("insertBefore"===this.type)return e=Node.fromJSON(this.toInsert),this.insertBefore===i.childNodes.length?i.appendChild(e):i.insertBefore(e,i.childNodes[this.insertBefore]);if("normalize"===this.type)return i.normalize();if("removeAttribute"===this.type||"removeAttributeNode"===this.type)return i.removeAttribute(this.name);if("removeChild"===this.type)return i.removeChild(i.childNodes[this.childIndex]);if("replaceChild"===this.type)return n=Node.fromJSON(this.newChild),i.replaceChild(n,i.childNodes[this.childIndex]);if("setAttribute"===this.type||"setAttributeNode"===this.type)return i.setAttribute(this.name,this.newValue);if("compound"===this.type){for(s=this.subactions,h=[],r=0,o=s.length;o>r;r++)t=s[r],h.push(t.redo());return h}},t.prototype.undo=function(){var t,e,i,n,o,s,h,l,a,d,c,u,p,f,m;if(!this.tracker)throw Error("Cannot undo action with no DOMEditTracker");if(s=this.tracker.getElement().index(this.node),"appendChild"===this.type)return s.removeChild(s.childNodes[s.childNodes.length-1]);if("insertBefore"===this.type)return s.removeChild(s.childNodes[this.insertBefore]);if("normalize"===this.type){n={},c=this.sequences;for(o in c)r.call(c,o)&&(n[o]=s.index(JSON.parse(o)));u=this.sequences,f=[];for(o in u)r.call(u,o)&&(i=n[o],f.push(function(){var t,e,n,r;for(n=this.sequences[o],r=[],t=0,e=n.length;e>t;t++)l=n[t],l.length<i.textContent.length?(i.splitText(l.length),r.push(i=i.nextSibling)):r.push(void 0);return r}.call(this)));return f}if("removeAttribute"===this.type||"removeAttributeNode"===this.type)return s.setAttribute(this.name,this.value);if("removeChild"===this.type)return e=Node.fromJSON(this.child),this.childIndex===s.childNodes.length?s.appendChild(e):s.insertBefore(e,s.childNodes[this.childIndex]);if("replaceChild"===this.type)return h=Node.fromJSON(this.oldChild),s.replaceChild(h,s.childNodes[this.childIndex]);if("setAttribute"===this.type||"setAttributeNode"===this.type)return""!==this.oldValue?s.setAttribute(this.name,this.oldValue):s.removeAttribute(this.name);if("compound"===this.type){for(p=this.subactions.slice(0).reverse(),m=[],a=0,d=p.length;d>a;a++)t=p[a],m.push(t.undo());return m}},t}(),window.DOMEditTracker=e=function(){function e(t){if(t&&"DIV"!==(null!=t?t.tagName:void 0))throw new Error("DOMEditTracker can only be constructed in a DIV node");this.element=t||null,this.stack=[],this.stackPointer=0,this.stackRecording=!0,this.compoundActions=null,this.compoundName=null,this.listeners=[],e.instances.push(this)}return e.instances=[],e.instanceOver=function(t){var e,i,n,r;if(!(t instanceof Node))return null;for(r=this.instances,i=0,n=r.length;n>i;i++)if(e=r[i],e.getElement()===t)return e;return this.instanceOver(t.parentNode)},e.prototype.getElement=function(){return this.element},e.prototype.getEditActions=function(){return this.stack.slice(0)},e.prototype.clearStack=function(){return this.stack=[]},e.prototype.nodeEditHappened=function(e){var i,n,r,o;if(e instanceof t){for(o=this.listeners,n=0,r=o.length;r>n;n++)(i=o[n])(e);if(this.stackRecording)return null!==this.compoundActions?void this.compoundActions.push(e):(this.stackPointer<this.stack.length&&(this.stack=this.stack.slice(0,this.stackPointer)),this.stack.push(e),this.stackPointer=this.stack.length)}},e.prototype.startCompoundAction=function(t){return null===this.compoundActions?(this.compoundActions=[],this.compoundName=t):void 0},e.prototype.endCompoundAction=function(){var e;if(null!==this.compoundActions)return e=new t("compound",this.compoundActions),this.compoundName&&(e.name=this.compoundName),this.compoundActions=null,this.compoundName=null,this.nodeEditHappened(e)},e.prototype.canUndo=function(){return this.stackPointer>0},e.prototype.canRedo=function(){return this.stackPointer<this.stack.length},e.prototype.undoDescription=function(){return 0===this.stackPointer?"":"Undo "+this.stack[this.stackPointer-1].toString()},e.prototype.redoDescription=function(){return this.stackPointer===this.stack.length?"":"Redo "+this.stack[this.stackPointer].toString()},e.prototype.undo=function(){return this.endCompoundAction(),this.stackPointer>0?(this.stackRecording=!1,this.stack[this.stackPointer-1].undo(),this.stackRecording=!0,this.stackPointer--):void 0},e.prototype.redo=function(){return null===this.compoundActions?this.stackPointer<this.stack.length?(this.stackRecording=!1,this.stack[this.stackPointer].redo(),this.stackRecording=!0,this.stackPointer++):void 0:void 0},e.prototype.listen=function(t){return this.listeners.push(t)},e}(),Node.prototype.address=function(t){var e;return null==t&&(t=null),this===t?[]:this.parentNode?(e=this.parentNode.address(t),null===e?null:e.concat([this.indexInParent()])):t?null:[]},Node.prototype.indexInParent=function(){return this.parentNode?Array.prototype.slice.apply(this.parentNode.childNodes).indexOf(this):-1},Node.prototype.index=function(t){var e;if(!(t instanceof Array))throw Error("Node address function requires an array");return 0===t.length?this:"number"!=typeof t[0]?void 0:null!=(e=this.childNodes[t[0]])?e.index(t.slice(1)):void 0},Node.prototype.toJSON=function(t){var e,i,n,r,o,s;if(null==t&&(t=!0),this instanceof Text)return this.textContent;if(this instanceof Comment)return t?{comment:!0,content:this.textContent}:{m:!0,n:this.textContent};if(!(this instanceof Element))throw Error("Cannot serialize this node: "+this);if(n={tagName:this.tagName},this.attributes.length)for(n.attributes={},s=this.attributes,r=0,o=s.length;o>r;r++)e=s[r],n.attributes[e.name]=e.value;return this.childNodes.length&&(n.children=function(){var e,n,r,o;for(r=this.childNodes,o=[],e=0,n=r.length;n>e;e++)i=r[e],o.push(i.toJSON(t));return o}.call(this)),t||(n.t=n.tagName,delete n.tagName,n.a=n.attributes,delete n.attributes,n.c=n.children,delete n.children),n},Node.fromJSON=function(t){var e,i,n,o,s,h,l,a;if("string"==typeof t)return document.createTextNode(t);if("comment"in t&&t.comment)return document.createComment(t.content);if("m"in t&&t.m)return document.createComment(t.n);if(!1 in t&&!1 in t)throw Error("Object has no t[agName]: "+this);if(s=document.createElement(t.tagName||t.t),e=t.attributes||t.a)for(o in e)r.call(e,o)&&(h=e[o],s.setAttribute(o,h));if(n=t.children||t.c)for(l=0,a=n.length;a>l;l++)i=n[l],s.appendChild(Node.fromJSON(i));return s},"appendChild insertBefore normalize removeAttribute\nremoveAttributeNode removeChild replaceChild\nsetAttribute setAttributeNode".split(/\s+/).map(function(i){var r,o;return o=Node.prototype[i]?Node:Element,r=o.prototype[i],o.prototype[i]=function(){var o,s,h,l;return o=1<=arguments.length?n.call(arguments,0):[],l=e.instanceOver(this),l&&(s=function(t,e,i){i.prototype=t.prototype;var n=new i,r=t.apply(n,e);return Object(r)===r?r:n}(t,[i,this].concat(n.call(o)),function(){})),h=r.call.apply(r,[this].concat(n.call(o))),l&&l.nodeEditHappened(s),h}}),Node.prototype.nextLeaf=function(t){var e;for(null==t&&(t=null),e=this;e&&e!==t&&!e.nextSibling;)e=e.parentNode;if(e=null!=e?e.nextSibling:void 0,!e)return null;for(;e.childNodes.length>0;)e=e.childNodes[0];return e},Node.prototype.previousLeaf=function(t){var e;for(null==t&&(t=null),e=this;e&&e!==t&&!e.previousSibling;)e=e.parentNode;if(e=null!=e?e.previousSibling:void 0,!e)return null;for(;e.childNodes.length>0;)e=e.childNodes[e.childNodes.length-1];return e},window.LurchEditor=i=function(t){function e(t){var i,n;e.__super__.constructor.call(this,t),n=this.cleanIds(t),this.freeIds=0===n.length?[0]:function(){var t,e,r;for(r=[],i=t=0,e=Math.max.apply(Math,n)+1;e>=0?e>=t:t>=e;i=e>=0?++t:--t)s.call(n,i)<0&&r.push(i);return r}(),this.assignIds(t),this.clearStack(),this.cursor={position:null,anchor:null}}var i;return o(e,t),e.prototype.nextFreeId=function(){return this.freeIds.length>1?this.freeIds.shift():this.freeIds[0]++},e.prototype.addFreeId=function(t){return t<this.freeIds[this.freeIds.length-1]?(this.freeIds.push(t),this.freeIds.sort(function(t,e){return t-e})):void 0},e.prototype.cleanIds=function(t){var e,i,n,r,o,h;if(n=[],!(t instanceof Node))return n;for(t.id&&(/^\d+$/.test(t.id)?n.push(parseInt(t.id)):t.removeAttribute("id")),h=t.childNodes,r=0,o=h.length;o>r;r++)e=h[r],n=n.concat(function(){var t,r,o,h;for(o=this.cleanIds(e),h=[],t=0,r=o.length;r>t;t++)i=o[t],s.call(n,i)<0&&h.push(i);return h}.call(this));return n},e.prototype.assignIds=function(t){var e,i,n,r,o;if(t instanceof Node){for(t instanceof HTMLElement&&!t.id&&(t.id=this.nextFreeId()),r=t.childNodes,o=[],i=0,n=r.length;n>i;i++)e=r[i],o.push(this.assignIds(e));return o}},e.prototype.address=function(t){return this.element?null!=t?t.address(this.element):void 0:null},e.prototype.index=function(t){return this.element?this.element.index(t):null},e.prototype.positionId="lurch-cursor-position",e.prototype.anchorId="lurch-cursor-anchor",e.prototype.updateCursor=function(){var t,i,n;for(this.cursor={position:null,anchor:null},i=t=document.getElementById(e.prototype.positionId);i&&!this.cursor.position;)i===this.element&&(this.cursor.position=t),i=i.parentNode;for(i=t=document.getElementById(e.prototype.anchorId),n=[];i&&!this.cursor.anchor;)i===this.element&&(this.cursor.anchor=t),n.push(i=i.parentNode);return n},e.prototype.elementsSupportingCursor=function(){var t,e,n,r;for(n="a abbr acronym address article aside b bdi bdo big\nblockquote caption center cite code dd details dfn div\ndl dt em fieldset figcaption figure footer form header\nh1 h2 h3 h4 h5 h6 i kbd label legend li mark nav ol p\npre q s samp section small span strong sub summary sup\ntd th time u ul var".trim().split(/\s+/),r=[],t=0,e=n.length;e>t;t++)i=n[t],r.push(i.toUpperCase());return r}(),e.prototype.cursorPositionsIn=function(t){var i,n,r,o,h,l,a;if(t instanceof Text)return t.length-1;if(0===t.childNodes.length)return l=t.tagName,s.call(e.prototype.elementsSupportingCursor,l)>=0?1:0;for(r=t.childNodes.length+1,a=t.childNodes,n=o=0,h=a.length;h>o;n=++o)i=a[n],r+=this.cursorPositionsIn(i);return r},e}(e),JSON.equals=function(t,e){var i,n,r,o,s;if(t instanceof Object!=e instanceof Object)return!1;if(!(t instanceof Object))return t===e;if(n=Object.keys(t).sort(),r=Object.keys(e).sort(),JSON.stringify(n)!==JSON.stringify(r))return!1;for(o=0,s=n.length;s>o;o++)if(i=n[o],!JSON.equals(t[i],e[i]))return!1;return!0}}).call(this);
//# sourceMappingURL=weblurch.min.js.map
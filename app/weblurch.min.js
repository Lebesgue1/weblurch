(function(){var t,e,i,n=[].slice,r={}.hasOwnProperty,o=function(t,e){function i(){this.constructor=t}for(var n in e)r.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},s=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};window.DOMEditAction=t=function(){function t(){var t,i,r,o,s,h;if(s=arguments[0],i=arguments[1],t=3<=arguments.length?n.call(arguments,2):[],!(i instanceof Node))throw Error("This is not a node: "+i);if(this.tracker=e.instanceOver(i),this.type=s,this.node=i.address(this.tracker.getElement()),"appendChild"===s){if(1!==t.length)throw Error("Wrong # of parameters: "+t);if(!(t[0]instanceof Node))throw Error("Invalid parameter: "+t);this.toAppend=t[0].toJSON()}else if("insertBefore"===s){if(1!==t.length&&2!==t.length)throw Error("Wrong # of parameters: "+t);if(!(t[0]instanceof Node))throw Error("Invalid parameter: "+t[0]);if(this.toInsert=t[0].toJSON(),2===t.length){if(!(t[1]instanceof Node))throw Error("Invalid parameter: "+t[0]);if(t[1].parentNode!==i)throw Error("Invalid child: "+t[0]);this.insertBefore=t[1].indexInParent()}else this.insertBefore=i.childNodes.length}else if("normalize"===s){if(0!==t.length)throw Error("Wrong # of parameters: "+t);this.sequences={},o=this,r=function(t){return function(e,i){var n,o,s,h,a,d;for(null==i&&(i=[]),n=e.childNodes[0],o=0,d=[];n;){if(h=i.concat([o]),n instanceof Text&&n.nextSibling instanceof Text){for(a=[];n instanceof Text;)a.push(n.textContent),n=n.nextSibling;s=JSON.stringify(h),t.sequences[s]=a}else r(n,h),n=n.nextSibling;d.push(o++)}return d}}(this),r(i)}else if("removeAttribute"===s){if(1!==t.length)throw Error("Wrong # of parameters: "+t);this.name=t[0]+"",this.value=i.getAttribute(this.name)}else if("removeAttributeNode"===s){if(1!==t.length)throw Error("Wrong # of parameters: "+t);if(!(t[0]instanceof Attr))throw Error("Invalid attribute node: "+t[0]);h=t[0],this.name=h.name,this.value=h.value}else if("removeChild"===s){if(1!==t.length)throw Error("Wrong # of parameters: "+t);if(!(t[0]instanceof Node))throw Error("Invalid parameter: "+t[0]);if(t[0].parentNode!==i)throw Error("Invalid child: "+t[0]);this.childIndex=t[0].indexInParent(),this.child=t[0].toJSON()}else if("replaceChild"===s){if(2!==t.length)throw Error("Wrong # of parameters: "+t);if(!(t[0]instanceof Node))throw Error("Invalid parameter: "+t[0]);if(!(t[1]instanceof Node))throw Error("Invalid parameter: "+t[1]);if(t[1].parentNode!==i)throw Error("Invalid child: "+t[1]);this.childIndex=t[1].indexInParent(),this.oldChild=t[1].toJSON(),this.newChild=t[0].toJSON()}else if("setAttribute"===s){if(2!==t.length)throw Error("Wrong # of parameters: "+t);this.name=t[0]+"",this.newValue=t[1]+"",this.oldValue=i.getAttribute(this.name)||""}else{if("setAttributeNode"!==s)throw Error("Invalid DOMEditAction type: "+s);if(1!==t.length)throw Error("Wrong # of parameters: "+t);if(!(t[0]instanceof Attr))throw Error("Invalid parameter: "+t[0]);this.name=t[0].name,this.newValue=t[0].value,this.oldValue=i.getAttribute(this.name)||""}}return t.prototype.toString=function(){var t,e,i,n,r,o;return t=50,"appendChild"===this.type?(o=Node.fromJSON(this.toAppend).textContent,o.length>t&&(o=o.slice(0,+t+1||9e9)+"..."),0===o.length&&(o="a node"),"Add "+o):"insertBefore"===this.type?(o=Node.fromJSON(this.toInsert).textContent,o.length>t&&(o=o.slice(0,+t+1||9e9)+"..."),0===o.length&&(o="a node"),"Insert "+o):"normalize"===this.type?"Normalize text":"removeAttribute"===this.type||"removeAttributeNode"===this.type?"Remove "+this.name+" attribute":"removeChild"===this.type?(o=Node.fromJSON(this.child).textContent,o.length>t&&(o=o.slice(0,+t+1||9e9)+"..."),0===o.length&&(o="a node"),"Remove "+o):"replaceChild"===this.type?(n=Node.fromJSON(this.oldChild).textContent,n.length>t&&(n=n.slice(0,+t+1||9e9)+"..."),0===n.length&&(n="a node"),r=Node.fromJSON(this.newChild).textContent,r.length>t&&(r=r.slice(0,+t+1||9e9)+"..."),0===r.length&&(r="a node"),"Replace "+n+" with "+r):"setAttribute"===this.type||"setAttributeNode"===this.type?(i=this.oldValue||"empty",e=this.newValue||"empty","Change "+this.name+" from "+i+" to "+e):"Error, unknown edit action type: "+this.type},t.prototype.toJSON=function(){return{type:this.type,node:this.node,toAppend:this.toAppend,toInsert:this.toInsert,insertBefore:this.insertBefore,sequences:this.sequences,name:this.name,value:this.value,child:this.child,childIndex:this.childIndex,oldChild:this.oldChild,newChild:this.newChild,oldValue:this.oldValue,newValue:this.newValue}},t.prototype.redo=function(){var t,e,i;return e=this.tracker.getElement().index(this.node),"appendChild"===this.type?e.appendChild(Node.fromJSON(this.toAppend)):"insertBefore"===this.type?(t=Node.fromJSON(this.toInsert),this.insertBefore===e.childNodes.length?e.appendChild(t):e.insertBefore(t,e.childNodes[this.insertBefore])):"normalize"===this.type?e.normalize():"removeAttribute"===this.type||"removeAttributeNode"===this.type?e.removeAttribute(this.name):"removeChild"===this.type?e.removeChild(e.childNodes[this.childIndex]):"replaceChild"===this.type?(i=Node.fromJSON(this.newChild),e.replaceChild(i,e.childNodes[this.childIndex])):"setAttribute"===this.type||"setAttributeNode"===this.type?e.setAttribute(this.name,this.newValue):void 0},t.prototype.undo=function(){var t,e,i,n,o,s,h,a,d,l;if(o=this.tracker.getElement().index(this.node),"appendChild"===this.type)return o.removeChild(o.childNodes[o.childNodes.length-1]);if("insertBefore"===this.type)return o.removeChild(o.childNodes[this.insertBefore]);if("normalize"===this.type){i={},a=this.sequences;for(n in a)r.call(a,n)&&(i[n]=o.index(JSON.parse(n)));d=this.sequences,l=[];for(n in d)r.call(d,n)&&(e=i[n],l.push(function(){var t,i,r,o;for(r=this.sequences[n],o=[],t=0,i=r.length;i>t;t++)h=r[t],h.length<e.textContent.length?(e.splitText(h.length),o.push(e=e.nextSibling)):o.push(void 0);return o}.call(this)));return l}return"removeAttribute"===this.type||"removeAttributeNode"===this.type?o.setAttribute(this.name,this.value):"removeChild"===this.type?(t=Node.fromJSON(this.child),this.childIndex===o.childNodes.length?o.appendChild(t):o.insertBefore(t,o.childNodes[this.childIndex])):"replaceChild"===this.type?(s=Node.fromJSON(this.oldChild),o.replaceChild(s,o.childNodes[this.childIndex])):"setAttribute"===this.type||"setAttributeNode"===this.type?""!==this.oldValue?o.setAttribute(this.name,this.oldValue):o.removeAttribute(this.name):void 0},t}(),window.DOMEditTracker=e=function(){function e(t){if(this.element=null,t&&"DIV"!==(null!=t?t.tagName:void 0))throw new Error("DOMEditTracker can only be constructed in a DIV node");this.element=t,this.stack=[],this.stackPointer=0,this.stackRecording=!0,e.instances.push(this)}return e.instances=[],e.instanceOver=function(t){var e,i,n,r;if(!(t instanceof Node))return null;for(r=this.instances,i=0,n=r.length;n>i;i++)if(e=r[i],e.getElement()===t)return e;return this.instanceOver(t.parentNode)},e.prototype.getElement=function(){return this.element},e.prototype.getEditActions=function(){return this.stack.slice(0)},e.prototype.clearStack=function(){return this.stack=[]},e.prototype.nodeEditHappened=function(e){return this.stackRecording&&e instanceof t?(this.stackPointer<this.stack.length&&(this.stack=this.stack.slice(0,this.stackPointer)),this.stack.push(e),this.stackPointer=this.stack.length):void 0},e.prototype.canUndo=function(){return this.stackPointer>0},e.prototype.canRedo=function(){return this.stackPointer<this.stack.length},e.prototype.undoDescription=function(){return 0===this.stackPointer?"":"Undo "+this.stack[this.stackPointer-1].toString()},e.prototype.redoDescription=function(){return this.stackPointer===this.stack.length?"":"Redo "+this.stack[this.stackPointer].toString()},e.prototype.undo=function(){return this.stackPointer>0?(this.stackRecording=!1,this.stack[this.stackPointer-1].undo(),this.stackRecording=!0,this.stackPointer--):void 0},e.prototype.redo=function(){return this.stackPointer<this.stack.length?(this.stackRecording=!1,this.stack[this.stackPointer].redo(),this.stackRecording=!0,this.stackPointer++):void 0},e}(),Node.prototype.address=function(t){var e;return null==t&&(t=null),this===t?[]:this.parentNode?(e=this.parentNode.address(t),null===e?null:e.concat([this.indexInParent()])):t?null:[]},Node.prototype.indexInParent=function(){return this.parentNode?Array.prototype.slice.apply(this.parentNode.childNodes).indexOf(this):-1},Node.prototype.index=function(t){var e;if(!(t instanceof Array))throw Error("Node address function requires an array");return 0===t.length?this:"number"!=typeof t[0]?void 0:null!=(e=this.childNodes[t[0]])?e.index(t.slice(1)):void 0},Node.prototype.toJSON=function(t){var e,i,n,r,o,s;if(null==t&&(t=!0),this instanceof Text)return this.textContent;if(this instanceof Comment)return t?{comment:!0,content:this.textContent}:{m:!0,n:this.textContent};if(!(this instanceof Element))throw Error("Cannot serialize this node: "+this);if(n={tagName:this.tagName},this.attributes.length)for(n.attributes={},s=this.attributes,r=0,o=s.length;o>r;r++)e=s[r],n.attributes[e.name]=e.value;return this.childNodes.length&&(n.children=function(){var e,n,r,o;for(r=this.childNodes,o=[],e=0,n=r.length;n>e;e++)i=r[e],o.push(i.toJSON(t));return o}.call(this)),t||(n.t=n.tagName,delete n.tagName,n.a=n.attributes,delete n.attributes,n.c=n.children,delete n.children),n},Node.fromJSON=function(t){var e,i,n,o,s,h,a,d;if("string"==typeof t)return document.createTextNode(t);if("comment"in t&&t.comment)return document.createComment(t.content);if("m"in t&&t.m)return document.createComment(t.n);if(!1 in t&&!1 in t)throw Error("Object has no t[agName]: "+this);if(s=document.createElement(t.tagName||t.t),e=t.attributes||t.a)for(o in e)r.call(e,o)&&(h=e[o],s.setAttribute(o,h));if(n=t.children||t.c)for(a=0,d=n.length;d>a;a++)i=n[a],s.appendChild(Node.fromJSON(i));return s},"appendChild insertBefore normalize removeAttribute\nremoveAttributeNode removeChild replaceChild\nsetAttribute setAttributeNode".split(/\s+/).map(function(i){var r,o;return o=Node.prototype[i]?Node:Element,r=o.prototype[i],o.prototype[i]=function(){var o,s,h,a;return o=1<=arguments.length?n.call(arguments,0):[],a=e.instanceOver(this),a&&(s=function(t,e,i){i.prototype=t.prototype;var n=new i,r=t.apply(n,e);return Object(r)===r?r:n}(t,[i,this].concat(n.call(o)),function(){})),h=r.call.apply(r,[this].concat(n.call(o))),a&&a.nodeEditHappened(s),h}}),window.LurchEditor=i=function(t){function e(t){var i,n;e.__super__.constructor.call(this,t),n=this.cleanIds(t),this.freeIds=0===n.length?[0]:function(){var t,e,r;for(r=[],i=t=0,e=Math.max.apply(Math,n)+1;e>=0?e>=t:t>=e;i=e>=0?++t:--t)s.call(n,i)<0&&r.push(i);return r}(),this.assignIds(t),this.clearStack()}return o(e,t),e.prototype.nextFreeId=function(){return this.freeIds.length>1?this.freeIds.shift():this.freeIds[0]++},e.prototype.addFreeId=function(t){return t<this.freeIds[this.freeIds.length-1]?(this.freeIds.push(t),this.freeIds.sort(function(t,e){return t-e})):void 0},e.prototype.cleanIds=function(t){var e,i,n,r,o,h;if(n=[],!(t instanceof Node))return n;for(t.id&&(/^\d+$/.test(t.id)?n.push(parseInt(t.id)):t.removeAttribute("id")),h=t.childNodes,r=0,o=h.length;o>r;r++)e=h[r],n=n.concat(function(){var t,r,o,h;for(o=this.cleanIds(e),h=[],t=0,r=o.length;r>t;t++)i=o[t],s.call(n,i)<0&&h.push(i);return h}.call(this));return n},e.prototype.assignIds=function(t){var e,i,n,r,o;if(t instanceof Node){for(t instanceof HTMLElement&&!t.id&&(t.id=this.nextFreeId()),r=t.childNodes,o=[],i=0,n=r.length;n>i;i++)e=r[i],o.push(this.assignIds(e));return o}},e.prototype.address=function(t){return this.element?null!=t?t.address(this.element):void 0:null},e.prototype.index=function(t){return this.element?this.element.index(t):null},e}(e)}).call(this);
//# sourceMappingURL=weblurch.min.js.map
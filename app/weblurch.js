// Generated by CoffeeScript 1.7.1
(function() {
  var DOMEditAction, DOMEditTracker, LurchEditor,
    __slice = [].slice,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  window.DOMEditAction = DOMEditAction = (function() {
    function DOMEditAction() {
      var data, node, process, that, type, _ref;
      type = arguments[0], node = arguments[1], data = 3 <= arguments.length ? __slice.call(arguments, 2) : [];
      if (!(node instanceof Node)) {
        throw Error('This is not a node: ' + node);
      }
      this.tracker = DOMEditTracker.instanceOver(node);
      this.type = type;
      this.node = node.address(this.tracker.getElement());
      if (type === 'appendChild') {
        if (data.length !== 1) {
          throw Error('Wrong # of parameters: ' + data);
        }
        if (!(data[0] instanceof Node)) {
          throw Error('Invalid parameter: ' + data);
        }
        this.toAppend = data[0].toJSON();
      } else if (type === 'insertBefore') {
        if (data.length !== 1 && data.length !== 2) {
          throw Error('Wrong # of parameters: ' + data);
        }
        if (!(data[0] instanceof Node)) {
          throw Error('Invalid parameter: ' + data[0]);
        }
        this.toInsert = data[0].toJSON();
        if (data.length === 2) {
          if (!(data[1] instanceof Node)) {
            throw Error('Invalid parameter: ' + data[0]);
          }
          if (data[1].parentNode !== node) {
            throw Error('Invalid child: ' + data[0]);
          }
          this.insertBefore = data[1].indexInParent();
        } else {
          this.insertBefore = node.childNodes.length;
        }
      } else if (type === 'normalize') {
        if (data.length !== 0) {
          throw Error('Wrong # of parameters: ' + data);
        }
        this.sequences = {};
        that = this;
        process = (function(_this) {
          return function(N, address) {
            var child, index, key, nextAddr, strings, _results;
            if (address == null) {
              address = [];
            }
            child = N.childNodes[0];
            index = 0;
            _results = [];
            while (child) {
              nextAddr = address.concat([index]);
              if (child instanceof Text && child.nextSibling instanceof Text) {
                strings = [];
                while (child instanceof Text) {
                  strings.push(child.textContent);
                  child = child.nextSibling;
                }
                key = JSON.stringify(nextAddr);
                _this.sequences[key] = strings;
              } else {
                process(child, nextAddr);
                child = child.nextSibling;
              }
              _results.push(index++);
            }
            return _results;
          };
        })(this);
        process(node);
      } else if (type === 'removeAttribute') {
        if (data.length !== 1) {
          throw Error('Wrong # of parameters: ' + data);
        }
        this.name = data[0] + '';
        this.value = node.getAttribute(this.name);
      } else if (type === 'removeAttributeNode') {
        if (data.length !== 1) {
          throw Error('Wrong # of parameters: ' + data);
        }
        if (!(data[0] instanceof Attr)) {
          throw Error('Invalid attribute node: ' + data[0]);
        }
        _ref = data[0], this.name = _ref.name, this.value = _ref.value;
      } else if (type === 'removeChild') {
        if (data.length !== 1) {
          throw Error('Wrong # of parameters: ' + data);
        }
        if (!(data[0] instanceof Node)) {
          throw Error('Invalid parameter: ' + data[0]);
        }
        if (data[0].parentNode !== node) {
          throw Error('Invalid child: ' + data[0]);
        }
        this.childIndex = data[0].indexInParent();
        this.child = data[0].toJSON();
      } else if (type === 'replaceChild') {
        if (data.length !== 2) {
          throw Error('Wrong # of parameters: ' + data);
        }
        if (!(data[0] instanceof Node)) {
          throw Error('Invalid parameter: ' + data[0]);
        }
        if (!(data[1] instanceof Node)) {
          throw Error('Invalid parameter: ' + data[1]);
        }
        if (data[1].parentNode !== node) {
          throw Error('Invalid child: ' + data[1]);
        }
        this.childIndex = data[1].indexInParent();
        this.oldChild = data[1].toJSON();
        this.newChild = data[0].toJSON();
      } else if (type === 'setAttribute') {
        if (data.length !== 2) {
          throw Error('Wrong # of parameters: ' + data);
        }
        this.name = data[0] + '';
        this.newValue = data[1] + '';
        this.oldValue = (node.getAttribute(this.name)) || '';
      } else if (type === 'setAttributeNode') {
        if (data.length !== 1) {
          throw Error('Wrong # of parameters: ' + data);
        }
        if (!(data[0] instanceof Attr)) {
          throw Error('Invalid parameter: ' + data[0]);
        }
        this.name = data[0].name;
        this.newValue = data[0].value;
        this.oldValue = (node.getAttribute(this.name)) || '';
      } else {
        throw Error('Invalid DOMEditAction type: ' + type);
      }
    }

    DOMEditAction.prototype.toString = function() {
      var max, newv, oldv, orig, repl, text;
      max = 50;
      if (this.type === 'appendChild') {
        text = Node.fromJSON(this.toAppend).textContent;
        if (text.length > max) {
          text = text.slice(0, +max + 1 || 9e9) + '...';
        }
        if (text.length === 0) {
          text = 'a node';
        }
        return "Add " + text;
      } else if (this.type === 'insertBefore') {
        text = Node.fromJSON(this.toInsert).textContent;
        if (text.length > max) {
          text = text.slice(0, +max + 1 || 9e9) + '...';
        }
        if (text.length === 0) {
          text = 'a node';
        }
        return "Insert " + text;
      } else if (this.type === 'normalize') {
        return "Normalize text";
      } else if (this.type === 'removeAttribute' || this.type === 'removeAttributeNode') {
        return "Remove " + this.name + " attribute";
      } else if (this.type === 'removeChild') {
        text = Node.fromJSON(this.child).textContent;
        if (text.length > max) {
          text = text.slice(0, +max + 1 || 9e9) + '...';
        }
        if (text.length === 0) {
          text = 'a node';
        }
        return "Remove " + text;
      } else if (this.type === 'replaceChild') {
        orig = Node.fromJSON(this.oldChild).textContent;
        if (orig.length > max) {
          orig = orig.slice(0, +max + 1 || 9e9) + '...';
        }
        if (orig.length === 0) {
          orig = 'a node';
        }
        repl = Node.fromJSON(this.newChild).textContent;
        if (repl.length > max) {
          repl = repl.slice(0, +max + 1 || 9e9) + '...';
        }
        if (repl.length === 0) {
          repl = 'a node';
        }
        return "Replace " + orig + " with " + repl;
      } else if (this.type === 'setAttribute' || this.type === 'setAttributeNode') {
        oldv = this.oldValue || 'empty';
        newv = this.newValue || 'empty';
        return "Change " + this.name + " from " + oldv + " to " + newv;
      } else {
        return "Error, unknown edit action type: " + this.type;
      }
    };

    DOMEditAction.prototype.toJSON = function() {
      return {
        type: this.type,
        node: this.node,
        toAppend: this.toAppend,
        toInsert: this.toInsert,
        insertBefore: this.insertBefore,
        sequences: this.sequences,
        name: this.name,
        value: this.value,
        child: this.child,
        childIndex: this.childIndex,
        oldChild: this.oldChild,
        newChild: this.newChild,
        oldValue: this.oldValue,
        newValue: this.newValue
      };
    };

    DOMEditAction.prototype.redo = function() {
      var newnode, original, replacement;
      original = this.tracker.getElement().index(this.node);
      if (this.type === 'appendChild') {
        return original.appendChild(Node.fromJSON(this.toAppend));
      } else if (this.type === 'insertBefore') {
        newnode = Node.fromJSON(this.toInsert);
        if (this.insertBefore === original.childNodes.length) {
          return original.appendChild(newnode);
        } else {
          return original.insertBefore(newnode, original.childNodes[this.insertBefore]);
        }
      } else if (this.type === 'normalize') {
        return original.normalize();
      } else if (this.type === 'removeAttribute' || this.type === 'removeAttributeNode') {
        return original.removeAttribute(this.name);
      } else if (this.type === 'removeChild') {
        return original.removeChild(original.childNodes[this.childIndex]);
      } else if (this.type === 'replaceChild') {
        replacement = Node.fromJSON(this.newChild);
        return original.replaceChild(replacement, original.childNodes[this.childIndex]);
      } else if (this.type === 'setAttribute' || this.type === 'setAttributeNode') {
        return original.setAttribute(this.name, this.newValue);
      }
    };

    DOMEditAction.prototype.undo = function() {
      var addBack, d, descendants, key, original, replacement, string, _ref, _ref1, _results;
      original = this.tracker.getElement().index(this.node);
      if (this.type === 'appendChild') {
        return original.removeChild(original.childNodes[original.childNodes.length - 1]);
      } else if (this.type === 'insertBefore') {
        return original.removeChild(original.childNodes[this.insertBefore]);
      } else if (this.type === 'normalize') {
        descendants = {};
        _ref = this.sequences;
        for (key in _ref) {
          if (!__hasProp.call(_ref, key)) continue;
          descendants[key] = original.index(JSON.parse(key));
        }
        _ref1 = this.sequences;
        _results = [];
        for (key in _ref1) {
          if (!__hasProp.call(_ref1, key)) continue;
          d = descendants[key];
          _results.push((function() {
            var _i, _len, _ref2, _results1;
            _ref2 = this.sequences[key];
            _results1 = [];
            for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
              string = _ref2[_i];
              if (string.length < d.textContent.length) {
                d.splitText(string.length);
                _results1.push(d = d.nextSibling);
              } else {
                _results1.push(void 0);
              }
            }
            return _results1;
          }).call(this));
        }
        return _results;
      } else if (this.type === 'removeAttribute' || this.type === 'removeAttributeNode') {
        return original.setAttribute(this.name, this.value);
      } else if (this.type === 'removeChild') {
        addBack = Node.fromJSON(this.child);
        if (this.childIndex === original.childNodes.length) {
          return original.appendChild(addBack);
        } else {
          return original.insertBefore(addBack, original.childNodes[this.childIndex]);
        }
      } else if (this.type === 'replaceChild') {
        replacement = Node.fromJSON(this.oldChild);
        return original.replaceChild(replacement, original.childNodes[this.childIndex]);
      } else if (this.type === 'setAttribute' || this.type === 'setAttributeNode') {
        if (this.oldValue !== '') {
          return original.setAttribute(this.name, this.oldValue);
        } else {
          return original.removeAttribute(this.name);
        }
      }
    };

    return DOMEditAction;

  })();

  window.DOMEditTracker = DOMEditTracker = (function() {
    DOMEditTracker.instances = [];

    DOMEditTracker.instanceOver = function(node) {
      var tracker, _i, _len, _ref;
      if (!(node instanceof Node)) {
        return null;
      }
      _ref = this.instances;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        tracker = _ref[_i];
        if (tracker.getElement() === node) {
          return tracker;
        }
      }
      return this.instanceOver(node.parentNode);
    };

    function DOMEditTracker(div) {
      this.element = null;
      if (div && (div != null ? div.tagName : void 0) !== 'DIV') {
        throw new Error('DOMEditTracker can only be ' + 'constructed in a DIV node');
      }
      this.element = div;
      this.stack = [];
      this.stackPointer = 0;
      this.stackRecording = true;
      DOMEditTracker.instances.push(this);
    }

    DOMEditTracker.prototype.getElement = function() {
      return this.element;
    };

    DOMEditTracker.prototype.getEditActions = function() {
      return this.stack.slice(0);
    };

    DOMEditTracker.prototype.clearStack = function() {
      return this.stack = [];
    };

    DOMEditTracker.prototype.nodeEditHappened = function(action) {
      if (!this.stackRecording || !(action instanceof DOMEditAction)) {
        return;
      }
      if (this.stackPointer < this.stack.length) {
        this.stack = this.stack.slice(0, this.stackPointer);
      }
      this.stack.push(action);
      return this.stackPointer = this.stack.length;
    };

    DOMEditTracker.prototype.canUndo = function() {
      return this.stackPointer > 0;
    };

    DOMEditTracker.prototype.canRedo = function() {
      return this.stackPointer < this.stack.length;
    };

    DOMEditTracker.prototype.undoDescription = function() {
      if (this.stackPointer === 0) {
        return '';
      } else {
        return "Undo " + (this.stack[this.stackPointer - 1].toString());
      }
    };

    DOMEditTracker.prototype.redoDescription = function() {
      if (this.stackPointer === this.stack.length) {
        return '';
      } else {
        return "Redo " + (this.stack[this.stackPointer].toString());
      }
    };

    DOMEditTracker.prototype.undo = function() {
      if (this.stackPointer > 0) {
        this.stackRecording = false;
        this.stack[this.stackPointer - 1].undo();
        this.stackRecording = true;
        return this.stackPointer--;
      }
    };

    DOMEditTracker.prototype.redo = function() {
      if (this.stackPointer < this.stack.length) {
        this.stackRecording = false;
        this.stack[this.stackPointer].redo();
        this.stackRecording = true;
        return this.stackPointer++;
      }
    };

    return DOMEditTracker;

  })();

  Node.prototype.address = function(ancestor) {
    var recur;
    if (ancestor == null) {
      ancestor = null;
    }
    if (this === ancestor) {
      return [];
    }
    if (!this.parentNode) {
      if (ancestor) {
        return null;
      } else {
        return [];
      }
    }
    recur = this.parentNode.address(ancestor);
    if (recur === null) {
      return null;
    }
    return recur.concat([this.indexInParent()]);
  };

  Node.prototype.indexInParent = function() {
    if (this.parentNode) {
      return Array.prototype.slice.apply(this.parentNode.childNodes).indexOf(this);
    } else {
      return -1;
    }
  };

  Node.prototype.index = function(address) {
    var _ref;
    if (!(address instanceof Array)) {
      throw Error('Node address function requires an array');
    }
    if (address.length === 0) {
      return this;
    }
    if (typeof address[0] !== 'number') {
      return void 0;
    }
    return (_ref = this.childNodes[address[0]]) != null ? _ref.index(address.slice(1)) : void 0;
  };

  Node.prototype.toJSON = function(verbose) {
    var attribute, chi, result, _i, _len, _ref;
    if (verbose == null) {
      verbose = true;
    }
    if (this instanceof Text) {
      return this.textContent;
    }
    if (this instanceof Comment) {
      if (verbose) {
        return {
          comment: true,
          content: this.textContent
        };
      } else {
        return {
          m: true,
          n: this.textContent
        };
      }
    }
    if (!(this instanceof Element)) {
      throw Error("Cannot serialize this node: " + this);
    }
    result = {
      tagName: this.tagName
    };
    if (this.attributes.length) {
      result.attributes = {};
      _ref = this.attributes;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        attribute = _ref[_i];
        result.attributes[attribute.name] = attribute.value;
      }
    }
    if (this.childNodes.length) {
      result.children = (function() {
        var _j, _len1, _ref1, _results;
        _ref1 = this.childNodes;
        _results = [];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          chi = _ref1[_j];
          _results.push(chi.toJSON(verbose));
        }
        return _results;
      }).call(this);
    }
    if (!verbose) {
      result.t = result.tagName;
      delete result.tagName;
      result.a = result.attributes;
      delete result.attributes;
      result.c = result.children;
      delete result.children;
    }
    return result;
  };

  Node.fromJSON = function(json) {
    var attributes, child, children, key, result, value, _i, _len;
    if (typeof json === 'string') {
      return document.createTextNode(json);
    }
    if ('comment' in json && json.comment) {
      return document.createComment(json.content);
    }
    if ('m' in json && json.m) {
      return document.createComment(json.n);
    }
    if (!'tagName' in json && !'t' in json) {
      throw Error("Object has no t[agName]: " + this);
    }
    result = document.createElement(json.tagName || json.t);
    if (attributes = json.attributes || json.a) {
      for (key in attributes) {
        if (!__hasProp.call(attributes, key)) continue;
        value = attributes[key];
        result.setAttribute(key, value);
      }
    }
    if (children = json.children || json.c) {
      for (_i = 0, _len = children.length; _i < _len; _i++) {
        child = children[_i];
        result.appendChild(Node.fromJSON(child));
      }
    }
    return result;
  };

  'appendChild insertBefore normalize removeAttribute\nremoveAttributeNode removeChild replaceChild\nsetAttribute setAttributeNode'.split(/\s+/).map(function(methodName) {
    var original, which;
    which = Node.prototype[methodName] ? Node : Element;
    original = which.prototype[methodName];
    return which.prototype[methodName] = function() {
      var args, event, result, tracker;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      tracker = DOMEditTracker.instanceOver(this);
      if (tracker) {
        event = (function(func, args, ctor) {
          ctor.prototype = func.prototype;
          var child = new ctor, result = func.apply(child, args);
          return Object(result) === result ? result : child;
        })(DOMEditAction, [methodName, this].concat(__slice.call(args)), function(){});
      }
      result = original.call.apply(original, [this].concat(__slice.call(args)));
      if (tracker) {
        tracker.nodeEditHappened(event);
      }
      return result;
    };
  });

  window.LurchEditor = LurchEditor = (function(_super) {
    __extends(LurchEditor, _super);

    LurchEditor.prototype.nextFreeId = function() {
      if (this.freeIds.length > 1) {
        return this.freeIds.shift();
      } else {
        return this.freeIds[0]++;
      }
    };

    LurchEditor.prototype.addFreeId = function(id) {
      if (id < this.freeIds[this.freeIds.length - 1]) {
        this.freeIds.push(id);
        return this.freeIds.sort(function(a, b) {
          return a - b;
        });
      }
    };

    function LurchEditor(div) {
      var i, usedIds;
      LurchEditor.__super__.constructor.call(this, div);
      usedIds = this.cleanIds(div);
      this.freeIds = usedIds.length === 0 ? [0] : (function() {
        var _i, _ref, _results;
        _results = [];
        for (i = _i = 0, _ref = (Math.max.apply(Math, usedIds)) + 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
          if (__indexOf.call(usedIds, i) < 0) {
            _results.push(i);
          }
        }
        return _results;
      })();
      this.assignIds(div);
      this.clearStack();
    }

    LurchEditor.prototype.cleanIds = function(node) {
      var child, id, result, _i, _len, _ref;
      result = [];
      if (!(node instanceof Node)) {
        return result;
      }
      if (node.id) {
        if (/^\d+$/.test(node.id)) {
          result.push(parseInt(node.id));
        } else {
          node.removeAttribute('id');
        }
      }
      _ref = node.childNodes;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        result = result.concat((function() {
          var _j, _len1, _ref1, _results;
          _ref1 = this.cleanIds(child);
          _results = [];
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            id = _ref1[_j];
            if (__indexOf.call(result, id) < 0) {
              _results.push(id);
            }
          }
          return _results;
        }).call(this));
      }
      return result;
    };

    LurchEditor.prototype.assignIds = function(node) {
      var child, _i, _len, _ref, _results;
      if (!(node instanceof Node)) {
        return;
      }
      if (node instanceof HTMLElement && !node.id) {
        node.id = this.nextFreeId();
      }
      _ref = node.childNodes;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        _results.push(this.assignIds(child));
      }
      return _results;
    };

    LurchEditor.prototype.address = function(node) {
      if (this.element) {
        return node != null ? node.address(this.element) : void 0;
      } else {
        return null;
      }
    };

    LurchEditor.prototype.index = function(address) {
      if (this.element) {
        return this.element.index(address);
      } else {
        return null;
      }
    };

    return LurchEditor;

  })(DOMEditTracker);

}).call(this);

//# sourceMappingURL=weblurch.map

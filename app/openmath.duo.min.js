(function(){var e,t,n,r,i=function(e,t){return function(){return e.apply(t,arguments)}},a={}.hasOwnProperty,s=[].slice,o=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};("undefined"==typeof n||null===n)&&(n=null!=(r="undefined"!=typeof module&&null!==module?module.exports:void 0)?r:window),n.OMNode=n.OM=e=t=function(){function e(t){this.tree=t,this.setAttribute=i(this.setAttribute,this),this.removeAttribute=i(this.removeAttribute,this),this.getAttribute=i(this.getAttribute,this),this.remove=i(this.remove,this),this.findInParent=i(this.findInParent,this),this.simpleEncode=i(this.simpleEncode,this),this.copy=i(this.copy,this),this.sameObjectAs=i(this.sameObjectAs,this),this.equals=i(this.equals,this),this.encode=i(this.encode,this),Object.defineProperty(this,"parent",{get:function(){return this.tree.p?new e(this.tree.p):void 0}}),Object.defineProperty(this,"type",{get:function(){return this.tree.t}}),Object.defineProperty(this,"value",{get:function(){return"bi"!==this.tree.t?this.tree.v:void 0}}),Object.defineProperty(this,"name",{get:function(){return this.tree.n}}),Object.defineProperty(this,"cd",{get:function(){return this.tree.cd}}),Object.defineProperty(this,"uri",{get:function(){return this.tree.uri}}),Object.defineProperty(this,"symbol",{get:function(){return this.tree.s?new e(this.tree.s):void 0}}),Object.defineProperty(this,"body",{get:function(){return this.tree.b?new e(this.tree.b):void 0}}),Object.defineProperty(this,"children",{get:function(){var t,n,r,i,a,s;for(a=null!=(i=this.tree.c)?i:[],s=[],n=0,r=a.length;r>n;n++)t=a[n],s.push(new e(t));return s}}),Object.defineProperty(this,"variables",{get:function(){var t,n,r,i,a;if("bi"===this.tree.t){for(i=this.tree.v,a=[],n=0,r=i.length;r>n;n++)t=i[n],a.push(new e(t));return a}return[]}})}var t;return e.checkJSON=function(e){var t,n,r,i,c,u,f,l,h,p,d,b,y,v,g,m,O,k,A;if(!(e instanceof Object))return"Expected an object, found "+typeof e;if(e.hasOwnProperty("a")){m=e.a;for(c in m)if(a.call(m,c)){l=m[c];try{f=JSON.parse(c)}catch(x){return r=x,"Key "+c+" invalid JSON"}if("sy"!==f.t)return"Key "+c+" is not a symbol";if(u=this.checkJSON(f))return u;if(u=this.checkJSON(l))return u}}switch(t=function(){var t,n,r,i;for(t=1<=arguments.length?s.call(arguments,0):[],i=Object.keys(e),n=0,r=i.length;r>n;n++)if(c=i[n],o.call(t,c)<0&&"t"!==c&&"a"!==c)return"Key "+c+" not valid in object of type "+e.t;return null},i=/^[:A-Za-z_][:A-Za-z_.0-9-]*$/,e.t){case"i":if(u=t("v"))return u;if(!/^[+-]?[0-9]+$/.test(""+e.v))return"Not an integer: "+e.v;break;case"f":if(u=t("v"))return u;if("number"!=typeof e.v)return"Not a number: "+e.v+" of type "+typeof e.v;if(isNaN(e.v))return"OpenMath floats cannot be NaN";if(!isFinite(e.v))return"OpenMath floats must be finite";break;case"st":if(u=t("v"))return u;if("string"!=typeof e.v)return"Value for st type was "+typeof e.v+", not string";break;case"ba":if(u=t("v"))return u;if(!(e.v instanceof Uint8Array))return"Value for ba type was not an instance of Uint8Array";break;case"sy":if(u=t("n","cd","uri"))return u;if("string"!=typeof e.n)return"Name for sy type was "+typeof e.n+", not string";if("string"!=typeof e.cd)return"CD for sy type was "+typeof e.cd+", not string";if(null!=e.uri&&"string"!=typeof e.uri)return"URI for sy type was "+typeof e.uri+", not string";if(!i.test(e.n))return"Invalid identifier as symbol name: "+e.n;if(!i.test(e.cd))return"Invalid identifier as symbol CD: "+e.cd;break;case"v":if(u=t("n"))return u;if("string"!=typeof e.n)return"Name for v type was "+typeof e.n+", not string";if(!i.test(e.n))return"Invalid identifier as variable name: "+e.n;break;case"a":if(u=t("c"))return u;if(!(e.c instanceof Array))return"Children of application object was not an array";if(0===e.c.length)return"Application object must have at least one child";for(O=e.c,p=0,y=O.length;y>p;p++)if(n=O[p],u=this.checkJSON(n))return u;break;case"bi":if(u=t("s","v","b"))return u;if(u=this.checkJSON(e.s))return u;if("sy"!==e.s.t)return"Head of a binding must be a symbol";if(!(e.v instanceof Array))return"In a binding, the v value must be an array";for(k=e.v,d=0,v=k.length;v>d;d++){if(h=k[d],u=this.checkJSON(h))return u;if("v"!==h.t)return"In a binding, all values in the v array must have type v"}if(u=this.checkJSON(e.b))return u;break;case"e":if(u=t("s","c"))return u;if(u=this.checkJSON(e.s))return u;if("sy"!==e.s.t)return"Head of an error must be a symbol";if(!(e.c instanceof Array))return"In an error, the c key must be an array";for(A=e.c,b=0,g=A.length;g>b;b++)if(n=A[b],u=this.checkJSON(n))return u;break;default:return"Invalid type: "+e.t}return null},e.decode=function(t){var n,r,i;if("string"==typeof t)try{t=JSON.parse(t)}catch(s){return n=s,n.message}return(r=this.checkJSON(t))?r:(i=function(e){var t,n,r,s,o,c,u,f,l,h,p,d,b;for(l=null!=(f=e.c)?f:[],s=0,c=l.length;c>s;s++)t=l[s],t.p=e,i(t);for(p=null!=(h=e.v)?h:[],o=0,u=p.length;u>o;o++)r=p[o],r.p=e,i(r);b=null!=(d=e.a)?d:{};for(n in b)a.call(b,n)&&(r=b[n],r.p=e,i(r));return null!=e.s&&(e.s.p=e,i(e.s)),null!=e.b?(e.b.p=e,i(e.b)):void 0},i(t),t.p=null,new e(t))},e.prototype.encode=function(){return JSON.stringify(this.tree,function(e,t){return"p"===e?void 0:t})},e.prototype.equals=function(e,t){var n;return null==t&&(t=!0),(n=function(e,r){var i,s,o,c,u,f;if(e===r)return!0;if(e instanceof Array||e instanceof Uint8Array){if(e instanceof Array&&!(r instanceof Array))return!1;if(e instanceof Uint8Array&&!(r instanceof Uint8Array))return!1;if(e.length!==r.length)return!1;for(s=u=0,f=e.length;f>u;s=++u)if(i=e[s],!n(i,r[s]))return!1;return!0}if(!(e instanceof Object))return!1;if(!(r instanceof Object))return!1;for(o in e)if(a.call(e,o)&&(c=e[o],"p"!==o&&(t||"a"!==o))){if(!r.hasOwnProperty(o))return!1;if(!n(c,r[o]))return!1}for(o in r)if(a.call(r,o)&&(c=r[o],"p"!==o&&(t||"a"!==o)&&!e.hasOwnProperty(o)))return!1;return!0})(this.tree,e.tree)},e.prototype.sameObjectAs=function(e){return this.tree===(null!=e?e.tree:void 0)},e.prototype.copy=function(){var t;return t=function(e){var n,r,i;switch(e.t){case"i":case"f":case"st":return{t:e.t,v:e.v};case"v":return{t:"v",n:e.n};case"sy":return r={t:"sy",n:e.n,cd:e.cd},e.hasOwnProperty("uri")&&(r.uri=e.uri),r;case"ba":return{t:"ba",v:new Uint8Array(e.v)};case"e":case"a":return r={t:e.t,c:function(){var r,i,a,s;for(a=e.c,s=[],r=0,i=a.length;i>r;r++)n=a[r],s.push(t(n));return s}()},"e"===e.t&&(r.s=t(e.s)),r;case"bi":return{t:"bi",s:t(e.s),v:function(){var n,r,a,s;for(a=e.v,s=[],n=0,r=a.length;r>n;n++)i=a[n],s.push(t(i));return s}(),b:t(e.b)}}},e.decode(t(this.tree))},e.integer=function(t){return e.decode({t:"i",v:t})},e["float"]=function(t){return e.decode({t:"f",v:t})},e.string=function(t){return e.decode({t:"st",v:t})},e.bytearray=function(t){return e.decode({t:"ba",v:t})},e.symbol=function(t,n,r){return e.decode(null!=r?{t:"sy",n:t,cd:n,uri:r}:{t:"sy",n:t,cd:n})},e.variable=function(t){return e.decode({t:"v",n:t})},e.application=function(){var t,n,r,i,a;for(n=1<=arguments.length?s.call(arguments,0):[],r={t:"a",c:[]},i=0,a=n.length;a>i;i++)t=n[i],r.c.push(t instanceof e?JSON.parse(t.encode()):t);return e.decode(r)},e.attribution=function(){var t,n,r,i;if(r=arguments[0],t=2<=arguments.length?s.call(arguments,1):[],!(r instanceof Object))return"Invalid first parameter to attribution";if(t.length%2!==0)return"Incomplete key-value pair in attribution";for(r instanceof e&&(r=JSON.parse(r.encode()));t.length>0;)null==r.a&&(r.a={}),n=t.shift(),n=n instanceof e?n.encode():JSON.stringify(n),i=t.shift(),r.a[n]=i instanceof e?JSON.parse(i.encode()):i;return e.decode(r)},e.binding=function(){var t,n,r,i,a,o,c,u;if(n=arguments[0],a=3<=arguments.length?s.call(arguments,1,o=arguments.length-1):(o=1,[]),t=arguments[o++],!(n instanceof Object))return"Invalid first parameter to binding";if(!(t instanceof Object))return"Invalid last parameter to binding";for(r={t:"bi",s:n instanceof e?JSON.parse(n.encode()):n,v:[],b:t instanceof e?JSON.parse(t.encode()):t},c=0,u=a.length;u>c;c++)i=a[c],r.v.push(i instanceof e?JSON.parse(i.encode()):i);return e.decode(r)},e.error=function(){var t,n,r,i,a,o;if(t=arguments[0],r=2<=arguments.length?s.call(arguments,1):[],!(t instanceof Object))return"Invalid first parameter to binding";for(i={t:"e",s:t instanceof e?JSON.parse(t.encode()):t,c:[]},a=0,o=r.length;o>a;a++)n=r[a],i.c.push(n instanceof e?JSON.parse(n.encode()):n);return e.decode(i)},t=[{name:"symbol",pattern:/[:A-Za-z_][:A-Za-z_0-9-]*\.[:A-Za-z_][:A-Za-z_0-9-]*/},{name:"variable",pattern:/[:A-Za-z_][:A-Za-z_0-9-]*/},{name:"float",pattern:/[+-]?(?:[0-9]+\.[0-9]*|[0-9]*\.[0-9]+)/},{name:"integer",pattern:/[+-]?[0-9]+/},{name:"string",pattern:/"(?:[^"\\]|\\"|\\\\)*"|'(?:[^'\\]|\\'|\\\\)*'/},{name:"comma",pattern:/,/},{name:"openParen",pattern:/\(/},{name:"closeParen",pattern:/\)/},{name:"openBracket",pattern:/\[/},{name:"closeBracket",pattern:/\]/}],e.simpleDecode=function(n){var r,i,a,s,o,c,u,f,l,h,p,d,b,y,v,g,m,O,k,A,x,N,j;if("string"!=typeof n)return"Input was not a string";for(b=[];n.length>0;){for(l=n.length,v=0,k=t.length;k>v;v++)d=t[v],u=d.pattern.exec(n),null!=u&&0===u.index&&(b.push({type:d.name,text:u[0]}),n=n.slice(u[0].length));if(n.length===l)return"Could not understand from here: "+n.slice(0,11)}for(p="expression about to start",h=[];b.length>0;){switch(f=b.shift(),p){case"expression about to start":switch(f.type){case"symbol":a=f.text.split("."),h.unshift({node:e.symbol(a[1],a[0])});break;case"variable":h.unshift({node:e.variable(f.text)});break;case"integer":c=parseInt(f.text),/\./.test(c)&&(c=f.text),h.unshift({node:e.integer(c)});break;case"float":h.unshift({node:e["float"](parseFloat(f.text))});break;case"string":y=f.text[0],f=f.text.slice(1,-1).replace(RegExp("\\\\"+y,"g"),y),h.unshift({node:e.string(f)});break;default:return"Unexpected "+f.text}p="expression ended";break;case"expression ended":switch(f.type){case"comma":p="expression about to start";break;case"openParen":h[0].head="application","closeParen"===(null!=b&&null!=(j=b[0])?j.type:void 0)?(b.shift(),h.unshift({node:e.application(h.shift().node)}),p="expression ended"):p="expression about to start";break;case"openBracket":h[0].head="binding",p="expression about to start";break;case"closeParen":for(o=g=0,A=h.length;A>g&&(i=h[o],"application"!==i.head);o=++g)if("binding"===i.head)return"Mismatch: [ closed by )";if(o===h.length)return"Unexpected )";for(r=[],s=m=0;o>=0?o>=m:m>=o;s=o>=0?++m:--m)r.unshift(h.shift().node);h.unshift({node:e.application.apply(null,r)});break;case"closeBracket":for(o=O=0,x=h.length;x>O&&(i=h[o],"binding"!==i.head);o=++O)if("application"===i.head)return"Mismatch: ( closed by ]";if(o===h.length)return"Unexpected ]";for(r=[],s=N=0;o>=0?o>=N:N>=o;s=o>=0?++N:--N)r.unshift(h.shift().node);h.unshift({node:e.binding.apply(null,r)});break;default:return"Unexpected "+f.text}}if("string"==typeof(null!=h?h[0].node:void 0))return h[0].node}return h.length>1?"Unexpected end of input":h[0].node},e.prototype.simpleEncode=function(){var e;return(e=function(t){var n,r,i,a,s,o;switch(null!=t?t.t:void 0){case"i":case"f":return""+t.v;case"v":return t.n;case"st":return"'"+t.v.replace(/'/g,"\\'")+"'";case"sy":return""+t.cd+"."+t.n;case"ba":return"'byte array'";case"e":return"'error'";case"a":return i=function(){var n,i,a,s;for(a=t.c,s=[],n=0,i=a.length;i>n;n++)r=a[n],s.push(e(r));return s}(),a=i.shift(),""+a+"("+i.join(",")+")";case"bi":return o=function(){var n,r,i,a;for(i=t.v,a=[],n=0,r=i.length;r>n;n++)s=i[n],a.push(e(s));return a}(),a=e(t.s),n=e(t.b),""+a+"["+o.join(",")+","+n+"]";default:return"Error: Invalid OpenMath type "+(null!=t?t.t:void 0)}})(this.tree)},e.prototype.findInParent=function(){var e,t,n,r,i,s,o,c,u,f,l,h,p;if(!this.parent)return void 0;for(f=this.parent.children,t=s=0,c=f.length;c>s;t=++s)if(e=f[t],this.sameObjectAs(e))return"c"+t;if("v"===this.type)for(l=this.parent.variables,t=o=0,u=l.length;u>o;t=++o)if(i=l[t],this.sameObjectAs(i))return"v"+t;if(this.sameObjectAs(this.parent.symbol))return"s";if(this.sameObjectAs(this.parent.body))return"b";p=null!=(h=this.parent.tree.a)?h:{};for(n in p)if(a.call(p,n)&&(r=p[n],this.tree===r))return n;return void 0},e.prototype.remove=function(){var e;if(e=this.findInParent()){switch(e[0]){case"c":this.parent.tree.c.splice(parseInt(e.slice(1)),1);break;case"v":this.parent.tree.v.splice(parseInt(e.slice(1)),1);break;case"b":delete this.parent.tree.b;break;case"s":delete this.parent.tree.s;break;case"{":delete this.parent.tree.a[e]}return delete this.tree.p}},e.prototype.getAttribute=function(t){var n,r,i,s,o,c;if(!(t instanceof e))return void 0;if("sy"!==t.type)return void 0;i=RegExp('"n":"'+t.name+'"'),n=RegExp('"cd":"'+t.cd+'"'),c=null!=(o=this.tree.a)?o:{};for(r in c)if(a.call(c,r)&&(s=c[r],i.test(r)&&n.test(r)))return new e(s)},e.prototype.removeAttribute=function(t){var n,r,i,s,o,c;if(t instanceof e&&"sy"===t.type){i=RegExp('"n":"'+t.name+'"'),n=RegExp('"cd":"'+t.cd+'"'),c=null!=(o=this.tree.a)?o:{};for(r in c)if(a.call(c,r)&&(s=c[r],i.test(r)&&n.test(r)))return new e(s).remove(),void delete this.tree.a[r]}},e.prototype.setAttribute=function(t,n){var r;if(t instanceof e&&n instanceof e&&"sy"===t.type)return this.removeAttribute(t),n.remove(),(null!=(r=this.tree).a?r.a:r.a={})[t.encode()]=n.tree,n.tree.p=this.tree},e}(),e["int"]=e.integer,e.flo=e["float"],e.str=e.string,e.byt=e.bytearray,e.sym=e.symbol,e["var"]=e.variable,e.app=e.application,e.att=e.attribution,e.bin=e.binding,e.err=e.error,e.simple=e.simpleDecode}).call(this);
//# sourceMappingURL=openmath.duo.min.js.map
(function(){var t,e,i,n,s,o,u,r,l,a,h,p,c,d,f=function(t,e){return function(){return t.apply(e,arguments)}},g=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1},b={}.hasOwnProperty,m=[].slice;("undefined"==typeof s||null===s)&&(s=null!=(c="undefined"!=typeof module&&null!==module?module.exports:void 0)?c:window),"undefined"!=typeof require&&null!==require&&(d=require("./openmath.duo"),e=d.OM,i=d.OMNode),a=e.symbol("metavariable","lurch"),p=e.string("true"),s.setMetavariable=h=function(t){var e;if(t instanceof i&&("v"===(e=t.type)||"sy"===e))return t.setAttribute(a,p.copy())},s.clearMetavariable=n=function(t){return t.removeAttribute(a)},s.isMetavariable=o=function(t){var e,n;return t instanceof i&&("v"===(e=t.type)||"sy"===e)&&(null!=(n=t.getAttribute(a))?n.equals(p):void 0)},s.Match=t=function(){function i(){this.toString=f(this.toString,this),this.copy=f(this.copy,this),this.complete=f(this.complete,this),this.storeTopmostPair=f(this.storeTopmostPair,this),this.getSubstitutionNode=f(this.getSubstitutionNode,this),this.getSubstitutionRight=f(this.getSubstitutionRight,this),this.getSubstitutionLeft=f(this.getSubstitutionLeft,this),this.getSubstitutionRoot=f(this.getSubstitutionRoot,this),this.getSubstitutionRequired=f(this.getSubstitutionRequired,this),this.hasSubstitution=f(this.hasSubstitution,this),this.clearSubstitution=f(this.clearSubstitution,this),this.setSubstitution=f(this.setSubstitution,this),this.applyTo=f(this.applyTo,this),this.keys=f(this.keys,this),this.has=f(this.has,this),this.clear=f(this.clear,this),this.get=f(this.get,this),this.set=f(this.set,this),this.map={}}return i.prototype.set=function(t,e){var i;return null!=t.simpleEncode&&(t=t.simpleEncode()),this.map[t]=e.copy(),null!=this.substitution?this.substitution.unavailable=function(){var e,n,s,o;for(s=this.substitution.unavailable,o=[],e=0,n=s.length;n>e;e++)i=s[e],i!==t&&o.push(i);return o}.call(this):void 0},i.prototype.get=function(t){var e;return this.map[null!=(e="function"==typeof t.simpleEncode?t.simpleEncode():void 0)?e:t]},i.prototype.clear=function(t){var e,i,n;return t=null!=(e="function"==typeof t.simpleEncode?t.simpleEncode():void 0)?e:t,delete this.map[t],g.call(null!=(i=null!=(n=this.substitution)?n.metavariables:void 0)?i:[],t)>=0&&g.call(this.substitution.unavailable,t)<0?this.substitution.unavailable.push(t):void 0},i.prototype.has=function(t){var e;return this.map.hasOwnProperty(null!=(e="function"==typeof t.simpleEncode?t.simpleEncode():void 0)?e:t)},i.prototype.keys=function(){return Object.keys(this.map)},i.prototype.applyTo=function(t){var e,i,n,s,u;for(i=t.copy(),u=i.descendantsSatisfying(o),n=0,s=u.length;s>n;n++)e=u[n],this.has(e)&&e.replaceWith(this.get(e).copy());return i},i.requiredSubstitution=e.symbol("replaceAll","lurch"),i.optionalSubstitution=e.symbol("replaceSome","lurch"),i.prototype.setSubstitution=function(e){var i,n,s,u,r,l,a,h,p,c;for(this.substitution={original:e,required:e.children[0].equals(t.requiredSubstitution),root:e.children[1],leftHandSide:e.children[2],rightHandSide:e.children[3],metavariables:[]},i=this.substitution.leftHandSide.descendantsSatisfying(o),r=0,a=i.length;a>r;r++)s=i[r],p=s.name,g.call(this.substitution.metavariables,p)<0&&this.substitution.metavariables.push(s.name);for(n=this.substitution.rightHandSide.descendantsSatisfying(o),l=0,h=n.length;h>l;l++)s=n[l],c=s.name,g.call(this.substitution.metavariables,c)<0&&this.substitution.metavariables.push(s.name);return this.substitution.unavailable=function(){var t,e,i,n;for(i=this.substitution.metavariables,n=[],t=0,e=i.length;e>t;t++)u=i[t],this.map.hasOwnProperty(u)||n.push(u);return n}.call(this)},i.prototype.clearSubstitution=function(){return delete this.substitution},i.prototype.hasSubstitution=function(){return null!=this.substitution},i.prototype.getSubstitutionRequired=function(){var t;return null!=(t=this.substitution)?t.required:void 0},i.prototype.getSubstitutionRoot=function(){var t;return null!=(t=this.substitution)?t.root:void 0},i.prototype.getSubstitutionLeft=function(){var t;return null!=(t=this.substitution)?t.leftHandSide:void 0},i.prototype.getSubstitutionRight=function(){var t;return null!=(t=this.substitution)?t.rightHandSide:void 0},i.prototype.getSubstitutionNode=function(){var t;return null!=(t=this.substitution)?t.original:void 0},i.prototype.storeTopmostPair=function(t,e){return this.pattern=t,this.expression=e},i.prototype.complete=function(){var t,i,n,s,u,r,l,a,h,p,c,d,f,g,m,v,y;if(null!=this.pattern&&null!=this.expression){h=/^unused_([0-9]+)$/,a=function(t){return"v"===t.type&&h.test(t.name)},l=this.pattern.descendantsSatisfying(a).concat(this.expression.descendantsSatisfying(a)),v=this.map;for(i in v)b.call(v,i)&&(p=v[i],l=l.concat(p.descendantsSatisfying(a)));for(t=[0],d=0,g=l.length;g>d;d++)c=l[d],s=h.exec(c.name),t.push(parseInt(s[1]));for(t=t.sort(function(t,e){return t-e}),n=t[t.length-1],r=this.pattern.descendantsSatisfying(o),y=[],f=0,m=r.length;m>f;f++)u=r[f],y.push(this.has(u)?void 0:this.set(u,e.variable("unused_"+ ++n)));return y}},i.prototype.copy=function(){var e,i,n,s;i=new t,s=this.map;for(e in s)b.call(s,e)&&(n=s[e],i.map[e]=n.copy());return null!=this.substitution&&(i.substitution={original:this.substitution.original,root:this.substitution.root,leftHandSide:this.substitution.leftHandSide,rightHandSide:this.substitution.rightHandSide,required:this.substitution.required,metavariables:this.substitution.metavariables.slice(0),unavailable:this.substitution.unavailable.slice(0)}),null!=this.pattern&&(i.pattern=this.pattern),null!=this.expression&&(i.expression=this.expression),i},i.prototype.toString=function(){var t,e,i,n,s;e="{",s=null!=(n=this.map)?n:{};for(t in s)b.call(s,t)&&(i=s[t],e.length>1&&(e+=","),e+=""+t+":"+i.simpleEncode());return e+="}",this.hasSubstitution()&&(e+="["+this.getSubstitutionLeft().simpleEncode()+(this.getSubstitutionRequired()?"=":"~")+this.getSubstitutionRight().simpleEncode()+" in "+this.getSubstitutionRoot().simpleEncode()+"]"),e},i}(),u=!1,l=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],u?console.log.apply(console,t):void 0},s.matches=r=function(i,n,s){var u,a,h,p,c,d,f,g,b,v,y,S,E,q,x,R,T,w,O,H,k,A,M,P,j,L,D,F,N,W,_,C,I,$,z,B,G,J,K,Q,U,V,X,Y,Z,tt,et,it,nt,st,ot,ut,rt,lt,at,ht,pt,ct,dt,ft,gt,bt,mt,vt,yt,St,Et;if(H=null==s,null==s&&(s=new t),l(""+(H?"\n":"")+"MATCHES:",null!=(gt=null!=i&&"function"==typeof i.simpleEncode?i.simpleEncode():void 0)?gt:i,null!=(bt=null!=n&&"function"==typeof n.simpleEncode?n.simpleEncode():void 0)?bt:n,""+s),H)for(s.storeTopmostPair(i,n),B=n.descendantsSatisfying(function(e){return"a"===e.type&&4===e.children.length&&e.children[0].equals(t.requiredSubstitution)}),Q=0,Y=B.length;Y>Q;Q++)z=B[Q],x=z.children[2],W=z.children[3],z.replaceWith(z.children[1]),z.replaceFree(x,W);if(l("  --pattern inside topmost pattern?",s.pattern.hasDescendantSatisfying(function(t){return t.sameObjectAs(i)})),l("  --expression inside topmost expression?",s.expression.hasDescendantSatisfying(function(t){return t.sameObjectAs(n)})),l("  --pattern inside substitution root?",null!=(mt=s.getSubstitutionRoot())?mt.hasDescendantSatisfying(function(t){return t.sameObjectAs(i)}):void 0),J=function(){var t,o,u,a,h,p,c,d,f,g,b,m,v,y,S,E,q,x,R,T,w;if(!s.hasSubstitution())return[];for(l("    match of",i.simpleEncode(),"to",n.simpleEncode(),"failed; trying subs...",s.toString()),b=s.getSubstitutionNode(),g=s.getSubstitutionRoot(),f=s.getSubstitutionRight(),p=e.application,m=p(s.getSubstitutionLeft(),f),s.clearSubstitution(),R=[i,n,[]],v=R[0],y=R[1],d=R[2];null!=v&&null!=y;){for(l("    attempting subs at this level:",m.simpleEncode(),p(v,y).simpleEncode(),""+s+"..."),T=r(m,p(v,y),s,!1),S=0,q=T.length;q>S;S++)h=T[S],l("        checking this:",""+h),a=v.address(g),o=h.applyTo(g),u=o.index(a),t=h.applyTo(f),l("        is "+(null!=t&&"function"==typeof t.simpleEncode?t.simpleEncode():void 0)+" free to replace "+(null!=u&&"function"==typeof u.simpleEncode?u.simpleEncode():void 0)+" in "+(null!=o&&"function"==typeof o.simpleEncode?o.simpleEncode():void 0)+"? "+t.isFreeToReplace(u,o)),t.isFreeToReplace(u,o)&&d.push(h);if(v.sameObjectAs(g))break;w=[v.parent,y.parent],v=w[0],y=w[1]}for(E=0,x=d.length;x>E;E++)c=d[E],c.setSubstitution(b);return l("    done attempting all subs; results:",function(){var t,e,i;for(i=[],t=0,e=d.length;e>t;t++)c=d[t],i.push(""+c);return i}()),d},"a"===i.type&&4===i.children.length&&(i.children[0].equals(t.requiredSubstitution)||i.children[0].equals(t.optionalSubstitution))){if(l("    pattern is a substitution..."),s.hasSubstitution())throw"Only one substitution permitted in a pattern";for(s.setSubstitution(i),N=s.getSubstitutionRight(),F=r(i.children[1],n,s),O=[],U=0,Z=F.length;Z>U;U++)if(D=F[U],l("    checking substitution match",""+D),i.children[0].equals(t.optionalSubstitution))l("        optional, so we approve it"),D.clearSubstitution(),O.push(D);else if(R=D.getSubstitutionLeft(),f=R.hasDescendantSatisfying(function(t){return o(t)&&!D.has(t)}))l("        approved because of unused metavars"),D.clearSubstitution(),O.push(D);else for(C=D.getSubstitutionRoot(),_=D.applyTo(C),R=D.applyTo(R),a=_.descendantsSatisfying(function(t){return t.equals(R)&&!t.hasDescendantSatisfying(o)&&t.isFree(_)}),l("        instantiated root:",_.simpleEncode()),l("        instances of lhs:",function(){var t,e,n;for(n=[],t=0,e=a.length;e>t;t++)u=a[t],n.push(u.address(i));return n}()),d=D.applyTo(n),l("        instantiated expression:",d.simpleEncode()),b=function(){var t,e,i;for(i=[],t=0,e=a.length;e>t;t++)u=a[t],i.push(d.index(u.address(_)));return i}(),l("        corresponding expression subtrees:",function(){var t,e,i;for(i=[],t=0,e=b.length;e>t;t++)h=b[t],i.push(h.simpleEncode());return i}()),K=function(){var t;return t=1<=arguments.length?m.call(arguments,0):[],e.application.apply(e,[e.string("tuple")].concat(m.call(t)))},y=D.applyTo(N),T=function(){var t,e,i;for(i=[],t=0,e=b.length;e>t;t++)h=b[t],i.push(y);return i}(),l("        will now recur on these tuples:"),l("        "+K.apply(null,T).simpleEncode()),l("        "+K.apply(null,b).simpleEncode()),D.clearSubstitution(),j=r(K.apply(null,T),K.apply(null,b),D),l("        recursion on tuples complete; testing..."),V=0,et=j.length;et>V;V++){for(L=j[V],l("        testing:",""+L),w=L.applyTo(N),v=!0,X=0,it=b.length;it>X;X++)if(g=b[X],!w.isFreeToReplace(g,n)){v=!1;break}v?(l("        approved after extending:",""+L),O.push(L)):l("        rejected after extending:",""+L)}if(F=O,H)for(at=0,nt=F.length;nt>at;at++)D=F[at],D.complete();return l("    results have been completed:",function(){var t,e,i;for(i=[],e=0,t=F.length;t>e;e++)P=F[e],i.push(""+P);return i}()),l("<--",function(){var t,e,i;for(i=[],e=0,t=O.length;t>e;e++)P=O[e],i.push(""+P);return i}()),O}if(o(i)){if(l("    pattern is a metavariable"),G=s.get(i))return l("    we use its already-determined value:"),D=r(G,n,s),l("<--",function(){var t,e,i;for(i=[],e=0,t=D.length;t>e;e++)P=D[e],i.push(""+P);return i}()),D;if(s.set(i,n),l("    stored new assignment",i.simpleEncode(),"=",n.simpleEncode(),"yielding",""+s),F=[s],H)for(ht=0,st=F.length;st>ht;ht++)D=F[ht],D.complete();return l("    results have been completed:",function(){var t,e,i;for(i=[],e=0,t=F.length;t>e;e++)P=F[e],i.push(""+P);return i}()),l("<--",function(){var t,e,i;for(i=[],e=0,t=F.length;t>e;e++)P=F[e],i.push(""+P);return i}()),F}if(l("    comparing types...",i.type,n.type),i.type!==n.type)return D=J(),l("<--",function(){var t,e,i;for(i=[],e=0,t=D.length;t>e;e++)P=D[e],i.push(""+P);return i}()),D;if("i"===(vt=i.type)||"f"===vt||"st"===vt||"ba"===vt||"sy"===vt||"v"===vt){if(i.equals(n,!1)){if(F=[s],H)for(pt=0,ot=F.length;ot>pt;pt++)D=F[pt],D.complete();l("    results have been completed:",function(){var t,e,i;for(i=[],e=0,t=F.length;t>e;e++)P=F[e],i.push(""+P);return i}())}else F=J();return l("<--",function(){var t,e,i;for(i=[],e=0,t=F.length;t>e;e++)P=F[e],i.push(""+P);return i}()),F}if(M=i.childrenSatisfying(),l("    pattern children:",function(){var t,e,i;for(i=[],e=0,t=M.length;t>e;e++)k=M[e],i.push(k.simpleEncode());return i}()),c=n.childrenSatisfying(),l("    expression children:",function(){var t,e,i;for(i=[],e=0,t=c.length;t>e;e++)h=c[e],i.push(h.simpleEncode());return i}()),M.length!==c.length)return D=J(),l("<--",function(){var t,e,i;for(i=[],e=0,t=D.length;t>e;e++)P=D[e],i.push(""+P);return i}()),D;for($=-1,E=function(e){return"a"===e.type&&(e.children[0].equals(t.requiredSubstitution)||e.children[0].equals(t.optionalSubstitution))},S=ct=0,ut=M.length;ut>ct;S=++ct)if(A=M[S],A.descendantsSatisfying(E).length>0){if($>-1)throw"Only one substitution permitted in a pattern";$=S}for($>-1&&(q=M.length-1,yt=[M[q],M[$]],M[$]=yt[0],M[q]=yt[1],St=[c[q],c[$]],c[$]=St[0],c[q]=St[1],l("    reordered children to put substitution at end..."),l("    pattern children:",function(){var t,e,i;for(i=[],e=0,t=M.length;t>e;e++)k=M[e],i.push(k.simpleEncode());return i}()),l("    expression children:",function(){var t,e,i;for(i=[],e=0,t=c.length;t>e;e++)h=c[e],i.push(h.simpleEncode());return i}())),F=[s],S=dt=0,rt=M.length;rt>dt;S=++dt){for(A=M[S],p=c[S],l("    recurring at",S,"on",A.simpleEncode(),"and",p.simpleEncode(),"with results",function(){var t,e,i;for(i=[],e=0,t=F.length;t>e;e++)P=F[e],i.push(""+P);return i}()),O=[],ft=0,lt=F.length;lt>ft;ft++)I=F[ft],O=O.concat(r(A,p,I.copy()));if(0===(F=O).length)break}if(l("    recursion complete; new result set:",function(){var t,e,i;for(e=[],i=0,t=F.length;t>i;i++)P=F[i],e.push(""+P);return e}()),H)for(Et=0,tt=F.length;tt>Et;Et++)D=F[Et],D.complete();return l("    results have been completed:",function(){var t,e,i;for(e=[],i=0,t=F.length;t>i;i++)P=F[i],e.push(""+P);return e}()),l("<--",function(){var t,e,i;for(e=[],i=0,t=F.length;t>i;i++)P=F[i],e.push(""+P);return e}()),F}}).call(this);
//# sourceMappingURL=matching.duo.min.js.map